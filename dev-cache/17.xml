<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Julia Evans]]></title>
  <link href="http://jvns.ca/atom.xml" rel="self"/>
  <link href="http://jvns.ca"/>
  <updated>2024-10-31T08:00:10+00:00</updated>
  <id>http://jvns.ca</id>
  <author>
      <name>Julia Evans</name>
  </author>
  <generator uri="http://gohugo.io/">Hugo</generator>

  
  <entry>
    <title type="html"><![CDATA[ASCII control characters in my terminal]]></title>
    <link href="https://jvns.ca/blog/2024/10/31/ascii-control-characters/"/>
    <updated>2024-10-31T08:00:10+00:00</updated>
    <id>https://jvns.ca/blog/2024/10/31/ascii-control-characters/</id>
    <content type="html"><![CDATA[<p>Hello! I&rsquo;ve been thinking about the terminal a lot and yesterday I got curious
about all these &ldquo;control codes&rdquo;, like <code>Ctrl-A</code>, <code>Ctrl-C</code>, <code>Ctrl-W</code>, etc. What&rsquo;s
the deal with all of them?</p>
<h3 id="a-table-of-ascii-control-characters">a table of ASCII control characters</h3>
<p>Here&rsquo;s a table of all 33 ASCII control characters, and what they do on my
machine (on Mac OS), more or less. There are about a million caveats, but I&rsquo;ll talk about
what it means and all the problems with this diagram that I know about.</p>
<p><a href="https://jvns.ca/ascii.html"><img src="https://jvns.ca/images/ascii-control.png"></a></p>
<p>You can also view it <a href="https://jvns.ca/ascii.html">as an HTML page</a> (I just made it an image so
it would show up in RSS).</p>
<h3 id="different-kinds-of-codes-are-mixed-together">different kinds of codes are mixed together</h3>
<p>The first surprising thing about this diagram to me is that there are 33
control codes, split into (very roughly speaking) these categories:</p>
<ol>
<li>Codes that are handled by the operating system&rsquo;s terminal driver, for
example when the OS sees a <code>3</code> (<code>Ctrl-C</code>), it&rsquo;ll send a <code>SIGINT</code> signal to
the current program</li>
<li>Everything else is passed through to the application as-is and the
application can do whatever it wants with them. Some subcategories of
those:
<ul>
<li>Codes that correspond to a literal keypress of a key on your keyboard
(<code>Enter</code>, <code>Tab</code>, <code>Backspace</code>). For example when you press <code>Enter</code>, your
terminal gets sent <code>13</code>.</li>
<li>Codes used by <code>readline</code>: &ldquo;the application can do whatever it wants&rdquo;
often means &ldquo;it&rsquo;ll do more or less what the <code>readline</code> library does,
whether the application actually uses <code>readline</code> or not&rdquo;, so I&rsquo;ve
labelled a bunch of the codes that <code>readline</code> uses</li>
<li>Other codes, for example I think <code>Ctrl-X</code> has no standard meaning in the
terminal in general but emacs uses it very heavily</li>
</ul>
</li>
</ol>
<p>There&rsquo;s no real structure to which codes are in which categories, they&rsquo;re all
just kind of randomly scattered because this evolved organically.</p>
<p>(If you&rsquo;re curious about readline, I wrote more about readline in <a href="https://jvns.ca/blog/2024/07/08/readline/">entering text in the terminal is complicated</a>, and there are a lot of
<a href="https://github.com/chzyer/readline/blob/master/doc/shortcut.md">cheat sheets out there</a>)</p>
<h3 id="there-are-only-33-control-codes">there are only 33 control codes</h3>
<p>Something else that I find a little surprising is that are only 33 control codes &ndash;
A to Z, plus 7 more (<code>@, [, \, ], ^, _, ?</code>). This means that if you want to
have for example <code>Ctrl-1</code> as a keyboard shortcut in a terminal application,
that&rsquo;s not really meaningful &ndash; on my machine at least <code>Ctrl-1</code> is exactly the
same thing as just pressing <code>1</code>, <code>Ctrl-3</code> is the same as <code>Ctrl-[</code>, etc.</p>
<p>Also <code>Ctrl+Shift+C</code> isn&rsquo;t a control code &ndash; what it does depends on your
terminal emulator. On Linux <code>Ctrl-Shift-X</code> is often used by the terminal
emulator to copy or open a new tab or paste for example, it&rsquo;s not sent to the
TTY at all.</p>
<p>Also I use <code>Ctrl+Left Arrow</code> all the time, but that isn&rsquo;t a control code,
instead it sends an ANSI escape sequence (<code>ctrl-[[1;5D</code>) which is a different
thing which we absolutely do not have space for in this post.</p>
<p>This &ldquo;there are only 33 codes&rdquo; thing is totally different from how keyboard
shortcuts work in a GUI where you can have <code>Ctrl+KEY</code> for any key you want.</p>
<h3 id="the-official-ascii-names-aren-t-very-meaningful-to-me">the official ASCII names aren&rsquo;t very meaningful to me</h3>
<p>Each of these 33 control codes has a name in ASCII (for example <code>3</code> is <code>ETX</code>).
When all of these control codes were originally defined, they weren&rsquo;t being
used for computers or terminals at all, they were used for <a href="https://falsedoor.com/doc/ascii_evolution-of-character-codes.pdf">the telegraph machine</a>.
Telegraph machines aren&rsquo;t the same as UNIX terminals so a lot of the codes were repurposed to mean something else.</p>
<p>Personally I don&rsquo;t find these ASCII names very useful, because 50% of the time
the name in ASCII has no actual relationship to what that code does on UNIX
systems today. So it feels easier to just ignore the ASCII names completely
instead of trying to figure which ones still match their original meaning.</p>
<h3 id="it-s-hard-to-use-ctrl-m-as-a-keyboard-shortcut">It&rsquo;s hard to use Ctrl-M  as a keyboard shortcut</h3>
<p>Another thing that&rsquo;s a bit weird is that <code>Ctrl-M</code> is literally the same as
<code>Enter</code>, and <code>Ctrl-I</code> is the same as <code>Tab</code>, which makes it hard to use those two as keyboard shortcuts.</p>
<p>From some quick research, it seems like some folks do still use <code>Ctrl-I</code> and
<code>Ctrl-M</code> as keyboard shortcuts (<a href="https://github.com/tmux/tmux/issues/2705">here&rsquo;s an example</a>), but to do that
you need to configure your terminal emulator to treat them differently than the
default.</p>
<p>For me the main takeaway is that if I ever write a terminal application I
should avoid <code>Ctrl-I</code> and <code>Ctrl-M</code> as keyboard shortcuts in it.</p>
<h3 id="how-to-identify-what-control-codes-get-sent">how to identify what control codes get sent</h3>
<p>While writing this I needed to do a bunch of experimenting to digure out what
various key combinations did, so I wrote this Python script
<a href="https://gist.github.com/jvns/a2ea09dbfbe03cc75b7bfb381941c742">echo-key.py</a>
that will print them out.</p>
<p>There&rsquo;s probably a more official way but I appreciated having a script I could
customize.</p>
<h3 id="caveat-on-canonical-vs-noncanonical-mode">caveat: on canonical vs noncanonical mode</h3>
<p>Two of these codes (<code>Ctrl-W</code> and <code>Ctrl-U</code>) are labelled in the table as
&ldquo;handled by the OS&rdquo;, but actually they&rsquo;re not <strong>always</strong> handled by the OS, it
depends on whether the terminal is in &ldquo;canonical&rdquo; mode or in &ldquo;noncanonical mode&rdquo;.</p>
<p>In <a href="https://www.man7.org/linux/man-pages/man3/termios.3.html">canonical mode</a>,
programs only get input when you press <code>Enter</code> (and the OS is in charge of deleting characters when you press <code>Backspace</code> or <code>Ctrl-W</code>). But in noncanonical mode the program gets
input immediately when you press a key, and the <code>Ctrl-W</code> and <code>Ctrl-U</code> codes are passed through to the program to handle any way it wants.</p>
<p>Generally in noncanonical mode the program will handle <code>Ctrl-W</code> and <code>Ctrl-U</code>
similarly to how the OS does, but there are some small differences.</p>
<p>Some examples of programs that use canonical mode:</p>
<ul>
<li>probably pretty much any noninteractive program, like <code>grep</code> or <code>cat</code></li>
<li><code>git</code>, I think</li>
</ul>
<p>Examples of programs that use noncanonical mode:</p>
<ul>
<li><code>python3</code>, <code>irb</code> and other REPLs</li>
<li>your shell</li>
<li>any full screen TUI like <code>less</code> or <code>vim</code></li>
</ul>
<h3 id="caveat-all-of-the-os-terminal-driver-codes-are-configurable-with-stty">caveat: all of the &ldquo;OS terminal driver&rdquo; codes are configurable with <code>stty</code></h3>
<p>I said that <code>Ctrl-C</code> sends <code>SIGINT</code> but technically this is not necessarily
true, if you really want to you can remap all of the codes labelled &ldquo;OS
terminal driver&rdquo;, plus Backspace, using a tool called <code>stty</code>, and you can view
the mappings with <code>stty -a</code>.</p>
<p>Here are the mappings on my machine right now:</p>
<pre><code>$ stty -a
cchars: discard = ^O; dsusp = ^Y; eof = ^D; eol = &lt;undef&gt;;
	eol2 = &lt;undef&gt;; erase = ^?; intr = ^C; kill = ^U; lnext = ^V;
	min = 1; quit = ^\; reprint = ^R; start = ^Q; status = ^T;
	stop = ^S; susp = ^Z; time = 0; werase = ^W;
</code></pre>
<p>I have personally never remapped any of these and I cannot imagine a reason I
would (I think it would be a recipe for confusion and disaster for me), but I
<a href="TODO">asked on Mastodon</a> and people said the most common reasons they used
<code>stty</code> were:</p>
<ul>
<li>fix a broken terminal with <code>stty sane</code></li>
<li>set <code>stty erase ^H</code> to change how Backspace works</li>
<li>set <code>stty ixoff</code></li>
<li>some people even map <code>SIGINT</code> to a different key, like their <code>DELETE</code> key</li>
</ul>
<h3 id="caveat-on-signals">caveat: on signals</h3>
<p>Two signals caveats:</p>
<ol>
<li>If the <code>ISIG</code> terminal mode is turned off, then the OS won&rsquo;t send signals. For example <code>vim</code> turns off <code>ISIG</code></li>
<li>Apparently on BSDs, there&rsquo;s an extra control code (<code>Ctrl-T</code>) which sends <code>SIGINFO</code></li>
</ol>
<p>You can see which terminal modes a program is setting using <code>strace</code> like this,
terminal modes are set with the <code>ioctl</code> system call:</p>
<pre><code>$ strace -tt -o out  vim
$ grep ioctl out | grep SET
</code></pre>
<p>here are the modes <code>vim</code> sets when it starts (<code>ISIG</code> and <code>ICANON</code> are
missing!):</p>
<pre><code>17:43:36.670636 ioctl(0, TCSETS, {c_iflag=IXANY|IMAXBEL|IUTF8,
c_oflag=NL0|CR0|TAB0|BS0|VT0|FF0|OPOST, c_cflag=B38400|CS8|CREAD,
c_lflag=ECHOK|ECHOCTL|ECHOKE|PENDIN, ...}) = 0
</code></pre>
<p>and it resets the modes when it exits:</p>
<pre><code>17:43:38.027284 ioctl(0, TCSETS, {c_iflag=ICRNL|IXANY|IMAXBEL|IUTF8,
c_oflag=NL0|CR0|TAB0|BS0|VT0|FF0|OPOST|ONLCR, c_cflag=B38400|CS8|CREAD,
c_lflag=ISIG|ICANON|ECHO|ECHOE|ECHOK|IEXTEN|ECHOCTL|ECHOKE|PENDIN, ...}) = 0
</code></pre>
<p>I think the specific combination of modes vim is using here might be called
&ldquo;raw mode&rdquo;, <a href="https://linux.die.net/man/3/cfmakeraw">man cfmakeraw</a> talks about
that.</p>
<h3 id="there-are-a-lot-of-conflicts">there are a lot of conflicts</h3>
<p>Related to &ldquo;there are only 33 codes&rdquo;, there are a lot of conflicts where
different parts of the system want to use the same code for different things,
for example by default <code>Ctrl-S</code> will freeze your screen, but if you turn that
off then <code>readline</code> will use <code>Ctrl-S</code> to do a forward search.</p>
<p>Another example is that on my machine sometimes <code>Ctrl-T</code> will send <code>SIGINFO</code>
and sometimes it&rsquo;ll transpose 2 characters and sometimes it&rsquo;ll do something
completely different depending on:</p>
<ul>
<li>whether the program has <code>ISIG</code> set</li>
<li>whether the program uses <code>readline</code> / imitates readline&rsquo;s behaviour</li>
</ul>
<h3 id="caveat-on-backspace-and-other-backspace">caveat: on &ldquo;backspace&rdquo; and &ldquo;other backspace&rdquo;</h3>
<p>In this diagram I&rsquo;ve labelled code 127 as &ldquo;backspace&rdquo; and 8 as &ldquo;other
backspace&rdquo;. Uh, what?</p>
<p>I think this was the single biggest topic of discussion in the replies on Mastodon &ndash; apparently there&rsquo;s a LOT of history to this and I&rsquo;d never heard of any of it before.</p>
<p>First, here&rsquo;s how it works on my machine:</p>
<ol>
<li>I press the <code>Backspace</code> key</li>
<li>The TTY gets sent the byte <code>127</code>, which is called <code>DEL</code> in ASCII</li>
<li>the OS terminal driver and readline both have <code>127</code> mapped to &ldquo;backspace&rdquo; (so it works both in canonical mode and noncanonical mode)</li>
<li>The previous character gets deleted</li>
</ol>
<p>If I press <code>Ctrl+H</code>, it has the same effect as <code>Backspace</code> if I&rsquo;m using
readline, but in a program without readline support (like <code>cat</code> for instance),
it just prints out <code>^H</code>.</p>
<p>Apparently Step 2 above is different for some folks &ndash; their <code>Backspace</code> key sends
the byte <code>8</code> instead of <code>127</code>, and so if they want Backspace to work then they
need to configure the OS (using <code>stty</code>) to set <code>erase = ^H</code>.</p>
<p>There&rsquo;s an incredible <a href="https://www.debian.org/doc/debian-policy/ch-opersys.html#keyboard-configuration">section of the Debian Policy Manual on keyboard configuration</a>
that describes how <code>Delete</code> and <code>Backspace</code> should work according to Debian
policy, which seems very similar to how it works on my Mac today.  My
understanding (via <a href="https://tech.lgbt/@Diziet/113396035847619715">this mastodon post</a>)
is that this policy was written in the 90s because there was a lot of confusion
about what <code>Backspace</code> should do in the 90s and there needed to be a standard
to get everything to work.</p>
<p>There&rsquo;s a bunch more historical terminal stuff here but that&rsquo;s all I&rsquo;ll say for
now.</p>
<h3 id="there-s-probably-a-lot-more-diversity-in-how-this-works">there&rsquo;s probably a lot more diversity in how this works</h3>
<p>I&rsquo;ve probably missed a bunch more ways that &ldquo;how it works on my machine&rdquo; might
be different from how it works on other people&rsquo;s machines, and I&rsquo;ve probably
made some mistakes about how it works on my machine too. But that&rsquo;s all I&rsquo;ve
got for today.</p>
<p>Some more stuff I know that I&rsquo;ve left out: according to <code>stty -a</code> <code>Ctrl-O</code> is
&ldquo;discard&rdquo;, <code>Ctrl-R</code> is &ldquo;reprint&rdquo;, and <code>Ctrl-Y</code> is &ldquo;dsusp&rdquo;. I have no idea how
to make those actually do anything (pressing them does not do anything
obvious, and some people have told me what they used to do historically but
it&rsquo;s not clear to me if they have a use in 2024), and a lot of the time in practice
they seem to just be passed through to the application anyway so I just
labelled <code>Ctrl-R</code> and <code>Ctrl-Y</code> as
<code>readline</code>.</p>
<h3 id="not-all-of-this-is-that-useful-to-know">not all of this is that useful to know</h3>
<p>Also I want to say that I think the contents of this post are kind of interesting
but I don&rsquo;t think they&rsquo;re necessarily that <em>useful</em>. I&rsquo;ve used the terminal
pretty successfully every day for the last 20 years without knowing literally
any of this &ndash; I just knew what <code>Ctrl-C</code>, <code>Ctrl-D</code>, <code>Ctrl-Z</code>, <code>Ctrl-R</code>,
<code>Ctrl-L</code> did in practice (plus maybe <code>Ctrl-A</code>, <code>Ctrl-E</code> and <code>Ctrl-W</code>) and did
not worry about the details for the most part, and that was
almost always totally fine except when I was <a href="https://jvns.ca/blog/2022/07/20/pseudoterminals/">trying to use xterm.js</a>.</p>
<p>But I had fun learning about it so maybe it&rsquo;ll be interesting to you too.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using less memory to look up IP addresses in Mess With DNS]]></title>
    <link href="https://jvns.ca/blog/2024/10/27/asn-ip-address-memory/"/>
    <updated>2024-10-27T07:47:04+00:00</updated>
    <id>https://jvns.ca/blog/2024/10/27/asn-ip-address-memory/</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve been having problems for the last 3 years or so where <a href="https://messwithdns.net/">Mess With DNS</a>
periodically runs out of memory and gets OOM killed.</p>
<p>This hasn&rsquo;t been a big priority for me: usually it just goes down for a few
minutes while it restarts, and it only happens once a day at most, so I&rsquo;ve just
been ignoring. But last week it started actually causing a problem so I decided
to look into it.</p>
<p>This was kind of winding road where I learned a lot so here&rsquo;s a table of contents:</p>
<ul>
<li><a href="#there-s-about-100mb-of-memory-available">there&rsquo;s about 100MB of memory available</a></li>
<li><a href="#the-problem-oom-killing-the-backup-script">the problem: OOM killing the backup script</a></li>
<li><a href="#attempt-1-use-sqlite">attempt 1: use SQLite</a>
<ul>
<li><a href="#problem-how-to-store-ipv6-addresses">problem: how to store IPv6 addresses</a></li>
<li><a href="#problem-it-s-500x-slower">problem: it&rsquo;s 500x slower</a></li>
<li><a href="#time-for-explain-query-plan">time for EXPLAIN QUERY PLAN</a></li>
</ul>
</li>
<li><a href="#attempt-2-use-a-trie">attempt 2: use a trie</a>
<ul>
<li><a href="#some-notes-on-memory-profiling">some notes on memory profiling</a></li>
</ul>
</li>
<li><a href="#attempt-3-make-my-array-use-less-memory">attempt 3: make my array use less memory</a>
<ul>
<li><a href="#idea-3-1-deduplicate-the-name-and-country">idea 3.1: deduplicate the Name and Country</a></li>
<li><a href="#how-big-are-asns">how big are ASNs?</a></li>
<li><a href="#idea-3-2-use-netip-addr-instead-of-net-ip">idea 3.2: use netip.Addr instead of net.IP</a></li>
<li><a href="#the-result-saved-70mb-of-memory">the result: saved 70MB of memory!</a></li>
</ul>
</li>
</ul>
<h3 id="there-s-about-100mb-of-memory-available">there&rsquo;s about 100MB of memory available</h3>
<p>I run Mess With DNS on a VM without about 465MB of RAM, which according to
<code>ps aux</code> (the <code>RSS</code> column) is split up something like:</p>
<ul>
<li>100MB for PowerDNS</li>
<li>200MB for Mess With DNS</li>
<li>40MB for <a href="https://fly.io/blog/ssh-and-user-mode-ip-wireguard/">hallpass</a></li>
</ul>
<p>That leaves about 110MB of memory free.</p>
<p>A while back I set <a href="https://tip.golang.org/doc/gc-guide">GOMEMLIMIT</a> to 250MB
to try to make sure the garbage collector ran if Mess With DNS used more than
250MB of memory, and I think this helped but it didn&rsquo;t solve everything.</p>
<h3 id="the-problem-oom-killing-the-backup-script">the problem: OOM killing the backup script</h3>
<p>A few weeks ago I started backing up Mess With DNS&rsquo;s database for the first time <a href="https://jvns.ca/til/restic-for-backing-up-sqlite-dbs/">using restic</a>.</p>
<p>This has been working okay, but since Mess With DNS operates without much extra
memory I think <code>restic</code> sometimes needed more memory than was available on the
system, and so the backup script sometimes got OOM killed.</p>
<p>This was a problem because</p>
<ol>
<li>backups might be corrupted sometimes</li>
<li>more importantly, restic takes out a lock when it runs, and so I&rsquo;d have to manually do an
unlock if I wanted the backups to continue working. Doing manual work like
this is the #1 thing I try to avoid with all my web services (who has time
for that!) so I really wanted to do something about it.</li>
</ol>
<p>There&rsquo;s probably more than one solution to this, but I decided to try to make
Mess With DNS use less memory so that there was more available memory on the
system, mostly because it seemed like a fun problem to try to solve.</p>
<h3 id="what-s-using-memory-ip-addresses">what&rsquo;s using memory: IP addresses</h3>
<p>I&rsquo;d run a memory profile of Mess With DNS a bunch of times in the past, so I
knew exactly what was using most of Mess With DNS&rsquo;s memory: IP addresses.</p>
<p>When it starts, Mess With DNS loads this <a href="https://iptoasn.com/">database where you can look up the
ASN of every IP address</a> into memory, so that when it
receives a DNS query it can take the source IP address like <code>74.125.16.248</code> and
tell you that IP address belongs to <code>GOOGLE</code>.</p>
<p>This database by itself used about 117MB of memory, and a simple <code>du</code> told me
that was too much &ndash; the original text files were only 37MB!</p>
<pre><code>$ du -sh *.tsv
26M	ip2asn-v4.tsv
11M	ip2asn-v6.tsv
</code></pre>
<p>The way it worked originally is that I had an array of these:</p>
<pre><code>type IPRange struct {
	StartIP net.IP
	EndIP   net.IP
	Num     int
	Name    string
	Country string
}
</code></pre>
<p>and I searched through it with a binary search to figure out if any of the
ranges contained the IP I was looking for. Basically the simplest possible
thing and it&rsquo;s super fast, my machine can do about 9 million lookups per
second.</p>
<h3 id="attempt-1-use-sqlite">attempt 1: use SQLite</h3>
<p>I&rsquo;ve been using SQLite recently, so my first thought was &ndash; maybe I can store
all of this data on disk in an SQLite database, give the tables an index, and
that&rsquo;ll use less memory.</p>
<p>So I:</p>
<ul>
<li>wrote a quick Python script using <a href="https://sqlite-utils.datasette.io/en/stable/">sqlite-utils</a> to import the TSV files into an SQLite database</li>
<li>adjusted my code to select from the database instead</li>
</ul>
<p>This did solve the initial memory goal (after a GC it now hardly used any
memory at all because the table was on disk!), though I&rsquo;m not sure how much GC
churn this solution would cause if we needed to do a lot of queries at once. I
did a quick memory profile and it seemed to allocate about 1KB of memory per
lookup.</p>
<p>Let&rsquo;s talk about the issues I ran into with using SQLite though.</p>
<h3 id="problem-how-to-store-ipv6-addresses">problem: how to store IPv6 addresses</h3>
<p>SQLite doesn&rsquo;t have support for big integers and IPv6 addresses are 128 bits,
so I decided to store them as text. I think <code>BLOB</code> might have been better, I
originally thought <code>BLOB</code>s couldn&rsquo;t be compared but the <a href="https://www.sqlite.org/datatype3.html#sort_order">sqlite docs</a> say they can.</p>
<p>I ended up with this schema:</p>
<pre><code>CREATE TABLE ipv4_ranges (
   start_ip INTEGER NOT NULL,
   end_ip INTEGER NOT NULL,
   asn INTEGER NOT NULL,
   country TEXT NOT NULL,
   name TEXT NOT NULL
);
CREATE TABLE ipv6_ranges (
   start_ip TEXT NOT NULL,
   end_ip TEXT NOT NULL,
   asn INTEGER,
   country TEXT,
   name TEXT
);
CREATE INDEX idx_ipv4_ranges_start_ip ON ipv4_ranges (start_ip);
CREATE INDEX idx_ipv6_ranges_start_ip ON ipv6_ranges (start_ip);
CREATE INDEX idx_ipv4_ranges_end_ip ON ipv4_ranges (end_ip);
CREATE INDEX idx_ipv6_ranges_end_ip ON ipv6_ranges (end_ip);
</code></pre>
<p>Also I learned that Python has an <code>ipaddress</code> module, so I could use
<code>ipaddress.ip_address(s).exploded</code> to make sure that the IPv6 addresses were
expanded so that a string comparison would compare them properly.</p>
<h3 id="problem-it-s-500x-slower">problem: it&rsquo;s 500x slower</h3>
<p>I ran a quick microbenchmark, something like this. It printed out that it could
look up 17,000 IPv6 addresses per second, and similarly for IPv4 addresses.</p>
<p>This was pretty discouraging &ndash; being able to look up 17k addresses per section
is kind of fine (Mess With DNS does not get a lot of traffic), but I compared it to
the original binary search code and the original code could do 9 million per second.</p>
<pre><code>	ips := []net.IP{}
	count := 20000
	for i := 0; i &lt; count; i++ {
		// create a random IPv6 address
		bytes := randomBytes()
		ip := net.IP(bytes[:])
		ips = append(ips, ip)
	}
	now := time.Now()
	success := 0
	for _, ip := range ips {
		_, err := ranges.FindASN(ip)
		if err == nil {
			success++
		}
	}
	fmt.Println(success)
	elapsed := time.Since(now)
	fmt.Println(&quot;number per second&quot;, float64(count)/elapsed.Seconds())
</code></pre>
<h3 id="time-for-explain-query-plan">time for EXPLAIN QUERY PLAN</h3>
<p>I&rsquo;d never really done an EXPLAIN in sqlite, so I thought it would be a fun
opportunity to see what the query plan was doing.</p>
<pre><code>sqlite&gt; explain query plan select * from ipv6_ranges where '2607:f8b0:4006:0824:0000:0000:0000:200e' BETWEEN start_ip and end_ip;
QUERY PLAN
`--SEARCH ipv6_ranges USING INDEX idx_ipv6_ranges_end_ip (end_ip&gt;?)
</code></pre>
<p>It looks like it&rsquo;s just using the <code>end_ip</code> index and not the <code>start_ip</code> index,
so maybe it makes sense that it&rsquo;s slower than the binary search.</p>
<p>I tried to figure out if there was a way to make SQLite use both indexes, but I
couldn&rsquo;t find one and maybe it knows best anyway.</p>
<p>At this point I gave up on the SQLite solution, I didn&rsquo;t love that it was
slower and also it&rsquo;s a lot more complex than just doing a binary search. I felt
like I&rsquo;d rather keep something much more similar to the binary search.</p>
<p>A few things I tried with SQLite that did not cause it to use both indexes:</p>
<ul>
<li>using a compound index instead of two separate indexes</li>
<li>running <code>ANALYZE</code></li>
<li>using <code>INTERSECT</code> to intersect the results of <code>start_ip &lt; ?</code> and <code>? &lt; end_ip</code>. This did make it use both indexes, but it also seemed to make the
query literally 1000x slower, probably because it needed to create the
results of both subqueries in memory and intersect them.</li>
</ul>
<h3 id="attempt-2-use-a-trie">attempt 2: use a trie</h3>
<p>My next idea was to use a
<a href="https://medium.com/basecs/trying-to-understand-tries-3ec6bede0014">trie</a>,
because I had some vague idea that maybe a trie would use less memory, and
I found this library called
<a href="https://github.com/seancfoley/ipaddress-go">ipaddress-go</a> that lets you look up IP addresses using a trie.</p>
<p>I tried using it <a href="https://gist.github.com/jvns/3ce617796b22127017590ac62c57fddd">here&rsquo;s the code</a>, but I
think I was doing something wildly wrong because, compared to my naive array + binary search:</p>
<ul>
<li>it used WAY more memory (800MB to store just the IPv4 addresses)</li>
<li>it was a lot slower to do the lookups (it could do only 100K/second instead of 9 million/second)</li>
</ul>
<p>I&rsquo;m not really sure what went wrong here but I gave up on this approach and
decided to just try to make my array use less memory and stick to a simple
binary search.</p>
<h3 id="some-notes-on-memory-profiling">some notes on memory profiling</h3>
<p>One thing I learned about memory profiling is that you can use <code>runtime</code>
package to see how much memory is currently allocated in the program. That&rsquo;s
how I got all the memory numbers in this post. Here&rsquo;s the code:</p>
<pre><code>func memusage() {
	runtime.GC()
	var m runtime.MemStats
	runtime.ReadMemStats(&amp;m)
	fmt.Printf(&quot;Alloc = %v MiB\n&quot;, m.Alloc/1024/1024)
	// write mem.prof
	f, err := os.Create(&quot;mem.prof&quot;)
	if err != nil {
		log.Fatal(err)
	}
	pprof.WriteHeapProfile(f)
	f.Close()
}
</code></pre>
<p>Also I learned that if you use <code>pprof</code> to analyze a heap profile there are two
ways to analyze it: you can pass either <code>--alloc-space</code> or <code>--inuse-space</code> to
<code>go tool pprof</code>. I don&rsquo;t know how I didn&rsquo;t realize this before but
<code>alloc-space</code> will tell you about everything that was allocated, and
<code>inuse-space</code> will just include memory that&rsquo;s currently in use.</p>
<p>Anyway I ran <code>go tool pprof -pdf --inuse_space mem.prof &gt; mem.pdf</code> a lot. Also
every time I use pprof I find myself referring to <a href="https://jvns.ca/blog/2017/09/24/profiling-go-with-pprof/">my own intro to pprof</a>, it&rsquo;s probably
the blog post I wrote that I use the most often. I should add <code>--alloc-space</code>
and <code>--inuse-space</code> to it.</p>
<h3 id="attempt-3-make-my-array-use-less-memory">attempt 3: make my array use less memory</h3>
<p>I was storing my ip2asn entries like this:</p>
<pre><code>type IPRange struct {
	StartIP net.IP
	EndIP   net.IP
	Num     int
	Name    string
	Country string
}
</code></pre>
<p>I had 3 ideas for ways to improve this:</p>
<ol>
<li>There was a lot of repetition of <code>Name</code> and the <code>Country</code>, because a lot of IP ranges belong to the same ASN</li>
<li><code>net.IP</code> is an <code>[]byte</code> under the hood, which felt like it involved an unnecessary pointer, was there a way to inline it into the struct?</li>
<li>Maybe I didn&rsquo;t need both the start IP and the end IP, often the ranges were consecutive so maybe I could rearrange things so that I only had the start IP</li>
</ol>
<h3 id="idea-3-1-deduplicate-the-name-and-country">idea 3.1: deduplicate the Name and Country</h3>
<p>I figured I could store the ASN info in an array, and then just store the index
into the array in my <code>IPRange</code> struct. Here are the structs so you can see what
I mean:</p>
<pre><code>type IPRange struct {
	StartIP netip.Addr
	EndIP   netip.Addr
	ASN     uint32
	Idx     uint32
}

type ASNInfo struct {
	Country string
	Name    string
}

type ASNPool struct {
	asns   []ASNInfo
	lookup map[ASNInfo]uint32
}
</code></pre>
<p>This worked! It brought memory usage from 117MB to 65MB &ndash; a 50MB savings. I felt good about this.</p>
<p><a href="https://github.com/jvns/mess-with-dns/blob/94f77b4bb1597b5e2a6768e33bd6c285919aa1bf/api/streamer/ip2asn/ip2asn.go#L18-L54">Here&rsquo;s all of the code for that part</a>.</p>
<h3 id="how-big-are-asns">how big are ASNs?</h3>
<p>As an aside &ndash; I&rsquo;m storing the ASN in a <code>uint32</code>, is that right? I looked in the ip2asn
file and the biggest one seems to be 401307, though there are a few lines that
say <code>4294901931</code> which is much bigger, but also are just inside the range of a
uint32. So I can definitely use a <code>uint32</code>.</p>
<pre><code>59.101.179.0	59.101.179.255	4294901931	Unknown	AS4294901931
</code></pre>
<h3 id="idea-3-2-use-netip-addr-instead-of-net-ip">idea 3.2: use <code>netip.Addr</code> instead of <code>net.IP</code></h3>
<p>It turns out that I&rsquo;m not the only one who felt that <code>net.IP</code> was using an
unnecessary amount of memory &ndash; in 2021 the folks at Tailscale released a new
IP address library for Go which solves this and many other issues. <a href="https://tailscale.com/blog/netaddr-new-ip-type-for-go">They wrote a great blog post about it</a>.</p>
<p>I discovered (to my delight) that not only does this new IP address library exist and do exactly what I want, it&rsquo;s also now in the Go
standard library as <a href="https://pkg.go.dev/net/netip#Addr">netip.Addr</a>. Switching to <code>netip.Addr</code> was
very easy and saved another 20MB of memory, bringing us to 46MB.</p>
<p>I didn&rsquo;t try my third idea (remove the end IP from the struct) because I&rsquo;d
already been programming for long enough on a Saturday morning and I was happy
with my progress.</p>
<p>It&rsquo;s always such a great feeling when I think &ldquo;hey, I don&rsquo;t like this, there
must be a better way&rdquo; and then immediately discover that someone has already
made the exact thing I want, thought about it a lot more than me, and
implemented it much better than I would have.</p>
<h3 id="all-of-this-was-messier-in-real-life">all of this was messier in real life</h3>
<p>Even though I tried to explain this in a simple linear way &ldquo;I tried X, then I
tried Y, then I tried Z&rdquo;, that&rsquo;s kind of a lie &ndash; I always try to take my
actual debugging process (total chaos) and make it seem more linear and
understandable because the reality is just too annoying to write down. It&rsquo;s
more like:</p>
<ul>
<li>try sqlite</li>
<li>try a trie</li>
<li>second guess everything that I concluded about sqlite, go back and look at
the results again</li>
<li>wait what about indexes</li>
<li>very very belatedly realize that I can use <code>runtime</code> to check how much
memory everything is using, start doing that</li>
<li>look at the trie again, maybe I misunderstood everything</li>
<li>give up and go back to binary search</li>
<li>look at all of the numbers for tries/sqlite again to make sure I didn&rsquo;t misunderstand</li>
</ul>
<h3 id="a-note-on-using-512mb-of-memory">A note on using 512MB of memory</h3>
<p>Someone asked why I don&rsquo;t just give the VM more memory. I could very easily
afford to pay for a VM with 1GB of memory, but I feel like 512MB really
<em>should</em> be enough (and really that 256MB should be enough!) so I&rsquo;d rather stay
inside that constraint. It&rsquo;s kind of a fun puzzle.</p>
<h3 id="a-few-ideas-from-the-replies">a few ideas from the replies</h3>
<p>Folks had a lot of good ideas I hadn&rsquo;t thought of. Recording them as
inspiration if I feel like having another Fun Performance Day at some point.</p>
<ul>
<li>Try Go&rsquo;s <a href="https://pkg.go.dev/unique">unique</a> package for the <code>ASNPool</code>. Someone tried this and it uses more memory, probably because Go&rsquo;s pointers are 64 bits</li>
<li>Try compiling with <code>GOARCH=386</code> to use 32-bit pointers to sace space (maybe in combination with using <code>unique</code>!)</li>
<li>It should be possible to store all of the IPv6 addresses in just 64 bits, because only the first 64 bits of the address are public</li>
<li><a href="https://en.m.wikipedia.org/wiki/Interpolation_search">Interpolation search</a> might be faster than binary search since IP addresses are numeric</li>
<li>Try the MaxMind db format with <a href="https://github.com/maxmind/mmdbwriter">mmdbwriter</a> or <a href="https://github.com/ipinfo/mmdbctl">mmdbctl</a></li>
<li>Tailscale&rsquo;s <a href="https://github.com/tailscale/art">art</a> routing table package</li>
</ul>
<h3 id="the-result-saved-70mb-of-memory">the result: saved 70MB of memory!</h3>
<p>I deployed the new version and now Mess With DNS is using less memory! Hooray!</p>
<p>A few other notes:</p>
<ul>
<li>lookups are a little slower &ndash; in my microbenchmark they went from 9 million
lookups/second to 6 million, maybe because I added a little indirection.
Using less memory and a little more CPU seemed like a good tradeoff though.</li>
<li>it&rsquo;s still using more memory than the raw text files do (46MB vs 37MB), I
guess pointers take up space and that&rsquo;s okay.</li>
</ul>
<p>I&rsquo;m honestly not sure if this will solve all my memory problems, probably not!
But I had fun, I learned a few things about SQLite, I still don&rsquo;t know what to
think about tries, and it made me love binary search even more than I already
did.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Some notes on upgrading Hugo]]></title>
    <link href="https://jvns.ca/blog/2024/10/07/some-notes-on-upgrading-hugo/"/>
    <updated>2024-10-07T09:19:57+00:00</updated>
    <id>https://jvns.ca/blog/2024/10/07/some-notes-on-upgrading-hugo/</id>
    <content type="html"><![CDATA[<p>Warning: this is a post about very boring yakshaving, probably only of interest
to people who are trying to upgrade Hugo from a very old version to a new
version. But what are blogs for if not documenting one&rsquo;s very boring yakshaves
from time to time?</p>
<p>So yesterday I decided to try to upgrade Hugo. There&rsquo;s no real reason to do
this &ndash; I&rsquo;ve been using Hugo version 0.40 to generate this blog since 2018, it
works fine, and I don&rsquo;t have any problems with it. But I thought &ndash; maybe it
won&rsquo;t be as hard as I think, and I kind of like a tedious computer task sometimes!</p>
<p>I thought I&rsquo;d document what I learned along the way in case it&rsquo;s useful to
anyone else doing this very specific migration. I upgraded from Hugo v0.40
(from 2018) to v0.135 (from 2024).</p>
<p>Here are most of the changes I had to make:</p>
<h3 id="change-1-template-theme-partials-thing-html-is-now-partial-thing-html">change 1: <code>template &quot;theme/partials/thing.html</code> is now <code>partial thing.html</code></h3>
<p>I had to replace a bunch of instances of <code>{{ template &quot;theme/partials/header.html&quot; . }}</code> with <code>{{ partial &quot;header.html&quot; . }}</code>.</p>
<p>This happened in <a href="https://github.com/gohugoio/hugo/releases/tag/v0.42">v0.42</a>:</p>
<blockquote>
<p>We have now virtualized the filesystems for project and theme files. This
makes everything simpler, faster and more powerful. But it also means that
template lookups on the form {{ template “theme/partials/pagination.html” .
}} will not work anymore. That syntax has never been documented, so it&rsquo;s not
expected to be in wide use.</p>
</blockquote>
<h3 id="change-2-data-pages-is-now-site-regularpages">change 2: <code>.Data.Pages</code> is now <code>site.RegularPages</code></h3>
<p>This seems to be discussed in the <a href="https://github.com/gohugoio/hugo/releases/tag/v0.57.2">release notes for 0.57.2</a></p>
<p>I just needed to replace <code>.Data.Pages</code> with <code>site.RegularPages</code> in the template on the homepage as well as in my RSS feed template.</p>
<h3 id="change-3-next-and-prev-got-flipped">change 3:  <code>.Next</code> and <code>.Prev</code> got flipped</h3>
<p>I had this comment in the part of my theme where I link to the next/previous blog post:</p>
<blockquote>
<p>&ldquo;next&rdquo; and &ldquo;previous&rdquo; in hugo apparently mean the opposite of what I&rsquo;d think
they&rsquo;d mean intuitively. I&rsquo;d expect &ldquo;next&rdquo; to mean &ldquo;in the future&rdquo; and
&ldquo;previous&rdquo; to mean &ldquo;in the past&rdquo; but it&rsquo;s the opposite</p>
</blockquote>
<p>It looks they changed this in
<a href="https://github.com/gohugoio/hugo/commit/ad705aac0649fa3102f7639bc4db65d45e108ee2">ad705aac064</a>
so that &ldquo;next&rdquo; actually is in the future and &ldquo;prev&rdquo; actually is in the past. I
definitely find the new behaviour more intuitive.</p>
<h3 id="downloading-the-hugo-changelogs-with-a-script">downloading the Hugo changelogs with a script</h3>
<p>Figuring out why/when all of these changes happened was a little difficult. I
ended up hacking together a bash script to <a href="https://gist.github.com/jvns/dbe4bd9271a56f1f8562bfe329c2aa9e">download all of the changelogs from github as text files</a>, which I
could then grep to try to figure out what happened. It turns out it&rsquo;s pretty
easy to get all of the changelogs from the GitHub API.</p>
<p>So far everything was not so bad &ndash; there was also a change around taxonomies
that&rsquo;s I can&rsquo;t quite explain, but it was all pretty manageable, but then we got
to the really tough one: the markdown renderer.</p>
<h3 id="change-4-the-markdown-renderer-blackfriday-goldmark">change 4: the markdown renderer (blackfriday -&gt; goldmark)</h3>
<p>The blackfriday markdown renderer (which was previously the default) was removed in <a href="https://github.com/gohugoio/hugo/releases/tag/v0.100.0">v0.100.0</a>. This seems pretty reasonable:</p>
<blockquote>
<p>It has been deprecated for a long time, its v1 version is not maintained
anymore, and there are many known issues. Goldmark should be a mature
replacement by now.</p>
</blockquote>
<p>Fixing all my Markdown changes was a huge pain &ndash; I ended up having to update
80 different Markdown files (out of 700) so that they would render properly, and I&rsquo;m not totally sure</p>
<h3 id="why-bother-switching-renderers">why bother switching renderers?</h3>
<p>The obvious question here is &ndash; why bother even trying to upgrade Hugo at all
if I have to switch Markdown renderers?
My old site was running totally fine and I think it wasn&rsquo;t necessarily a <em>good</em>
use of time, but the one reason I think it might be useful in the future is
that the new renderer (goldmark) uses the <a href="https://commonmark.org/">CommonMark markdown standard</a>, which I&rsquo;m hoping will be somewhat
more futureproof. So maybe I won&rsquo;t have to go through this again? We&rsquo;ll see.</p>
<p>Also it turned out that the new Goldmark renderer does fix some problems I had
(but didn&rsquo;t know that I had) with smart quotes and how lists/blockquotes
interact.</p>
<h3 id="finding-all-the-markdown-problems-the-process">finding all the Markdown problems: the process</h3>
<p>The hard part of this Markdown change was even figuring out what changed.
Almost all of the problems (including #2 and #3 above) just silently broke the
site, they didn&rsquo;t cause any errors or anything. So I had to diff the HTML to
hunt them down.</p>
<p>Here&rsquo;s what I ended up doing:</p>
<ol>
<li>Generate the site with the old version, put it in <code>public_old</code></li>
<li>Generate the new version, put it in <code>public</code></li>
<li>Diff every single HTML file in <code>public/</code> and <code>public_old</code> with <a href="https://gist.github.com/jvns/c7272cfb906e3ed0a3e9f8d361c5b5fc">this diff.sh script</a> and put the results in a <code>diffs/</code> folder</li>
<li>Run variations on <code>find diffs -type f | xargs cat | grep -C 5 '(31m|32m)' | less -r</code> over and over again to look at every single change until I found something that seemed wrong</li>
<li>Update the Markdown to fix the problem</li>
<li>Repeat until everything seemed okay</li>
</ol>
<p>(the <code>grep 31m|32m</code> thing is searching for red/green text in the diff)</p>
<p>This was very time consuming but it was a little bit fun for some reason so I
kept doing it until it seemed like nothing too horrible was left.</p>
<h3 id="the-new-markdown-rules">the new markdown rules</h3>
<p>Here&rsquo;s a list of every type of Markdown change I had to make. It&rsquo;s very
possible these are all extremely specific to me but it took me a long time to
figure them all out so maybe this will be helpful to one other person who finds
this in the future.</p>
<h4 id="4-1-mixing-html-and-markdown">4.1: mixing HTML and markdown</h4>
<p>This doesn&rsquo;t work anymore (it doesn&rsquo;t expand the link):</p>
<pre><code>&lt;small&gt;
[a link](https://example.com)
&lt;/small&gt;
</code></pre>
<p>I need to do this instead:</p>
<pre><code>&lt;small&gt;

[a link](https://example.com)

&lt;/small&gt;
</code></pre>
<p>This works too:</p>
<pre><code>&lt;small&gt; [a link](https://example.com) &lt;/small&gt;
</code></pre>
<h4 id="4-2-is-changed-into">4.2: <code>&lt;&lt;</code> is changed into «</h4>
<p>I didn&rsquo;t want this so I needed to configure:</p>
<pre><code>markup:
  goldmark:
    extensions:
      typographer:
        leftAngleQuote: '&amp;lt;&amp;lt;'
        rightAngleQuote: '&amp;gt;&amp;gt;'
</code></pre>
<h4 id="4-3-nested-lists-sometimes-need-4-space-indents">4.3: nested lists sometimes need 4 space indents</h4>
<p>This doesn&rsquo;t render as a nested list anymore if I only indent by 2 spaces, I need to put 4 spaces.</p>
<pre><code>1. a
  * b
  * c
2. b
</code></pre>
<p>The problem is that the amount of indent needed depends on the size of the list
markers. <a href="https://spec.commonmark.org/0.29/#example-263">Here&rsquo;s a reference in CommonMark for this</a>.</p>
<h4 id="4-4-blockquotes-inside-lists-work-better">4.4: blockquotes inside lists work better</h4>
<p>Previously the <code>&gt; quote</code> here didn&rsquo;t render as a blockquote, and with the new renderer it does.</p>
<pre><code>* something
&gt; quote
* something else
</code></pre>
<p>I found a bunch of Markdown that had been kind of broken (which I hadn&rsquo;t
noticed) that works better with the new renderer, and this is an example of
that.</p>
<p>Lists inside blockquotes also seem to work better.</p>
<h4 id="4-5-headings-inside-lists">4.5: headings inside lists</h4>
<p>Previously this didn&rsquo;t render as a heading, but now it does. So I needed to
replace the <code>#</code> with <code>&amp;num;</code>.</p>
<pre><code>* # passengers: 20
</code></pre>
<h4 id="4-6-or-1-at-the-beginning-of-the-line-makes-it-a-list">4.6:  <code>+</code> or <code>1)</code> at the beginning of the line makes it a list</h4>
<p>I had something which looked like this:</p>
<pre><code>`1 / (1
+ exp(-1)) = 0.73`
</code></pre>
<p>With Blackfriday it rendered like this:</p>
<pre><code>&lt;p&gt;&lt;code&gt;1 / (1
+ exp(-1)) = 0.73&lt;/code&gt;&lt;/p&gt;
</code></pre>
<p>and with Goldmark it rendered like this:</p>
<pre><code>&lt;p&gt;`1 / (1&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;exp(-1)) = 0.73`&lt;/li&gt;
&lt;/ul&gt;
</code></pre>
<p>Same thing if there was an accidental <code>1)</code> at the beginning of a line, like in this Markdown snippet</p>
<pre><code>I set up a small Hadoop cluster (1 master, 2 workers, replication set to 
1) on 
</code></pre>
<p>To fix this I just had to rewrap the line so that the <code>+</code> wasn&rsquo;t the first character.</p>
<p>The Markdown is formatted this way because I wrap my Markdown to 80 characters
a lot and the wrapping isn&rsquo;t very context sensitive.</p>
<h4 id="4-7-no-more-smart-quotes-in-code-blocks">4.7: no more smart quotes in code blocks</h4>
<p>There were a bunch of places where the old renderer (Blackfriday) was doing
unwanted things in code blocks like replacing <code>...</code> with <code>…</code> or replacing
quotes with smart quotes. I hadn&rsquo;t realized this was happening and I was very
happy to have it fixed.</p>
<h4 id="4-8-better-quote-management">4.8: better quote management</h4>
<p>The way this gets rendered got better:</p>
<pre><code>&quot;Oh, *interesting*!&quot;
</code></pre>
<ul>
<li>old: “Oh, <em>interesting</em>!“</li>
<li>new: “Oh, <em>interesting</em>!”</li>
</ul>
<p>Before there were two left smart quotes, now the quotes match.</p>
<h4 id="4-9-images-are-no-longer-wrapped-in-a-p-tag">4.9: images are no longer wrapped in a <code>p</code> tag</h4>
<p>Previously if I had an image like this:</p>
<pre><code>&lt;img src=&quot;https://jvns.ca/images/rustboot1.png&quot;&gt;
</code></pre>
<p>it would get wrapped in a <code>&lt;p&gt;</code> tag, now it doesn&rsquo;t anymore. I dealt with this
just by adding a <code>margin-bottom: 0.75em</code> to images in the CSS, hopefully
that&rsquo;ll make them display well enough.</p>
<h4 id="4-10-br-is-now-wrapped-in-a-p-tag">4.10: <code>&lt;br&gt;</code> is now wrapped in a <code>p</code> tag</h4>
<p>Previously this wouldn&rsquo;t get wrapped in a <code>p</code> tag, but now it seems to:</p>
<pre><code>&lt;br&gt;&lt;br&gt;
</code></pre>
<p>I just gave up on fixing this though and resigned myself to maybe having some
extra space in some cases. Maybe I&rsquo;ll try to fix it later if I feel like
another yakshave.</p>
<h4 id="4-11-some-more-goldmark-settings">4.11: some more goldmark settings</h4>
<p>I also needed to</p>
<ul>
<li>turn off code highlighting (because it wasn&rsquo;t working properly and I didn&rsquo;t have it before anyway)</li>
<li>use the old &ldquo;blackfriday&rdquo; method to generate heading IDs so they didn&rsquo;t change</li>
<li>allow raw HTML in my markdown</li>
</ul>
<p>Here&rsquo;s what I needed to add to my <code>config.yaml</code> to do all that:</p>
<pre><code>markup:
  highlight:
    codeFences: false
  goldmark:
    renderer:
      unsafe: true
    parser:
      autoHeadingIDType: blackfriday
</code></pre>
<p>Maybe I&rsquo;ll try to get syntax highlighting working one day, who knows. I might
prefer having it off though.</p>
<h3 id="a-little-script-to-compare-blackfriday-and-goldmark">a little script to compare blackfriday and goldmark</h3>
<p>I also wrote a little program to compare the Blackfriday and Goldmark output
for various markdown snippets, <a href="https://gist.github.com/jvns/9cc3024ff98433ced5e3a2304c5fc5e4">here it is in a gist</a>.</p>
<p>It&rsquo;s not really configured the exact same way Blackfriday and Goldmark were in
my Hugo versions, but it was still helpful to have to help me understand what
was going on.</p>
<h3 id="a-quick-note-on-maintaining-themes">a quick note on maintaining themes</h3>
<p>My approach to themes in Hugo has been:</p>
<ol>
<li>pay someone to make a nice design for the site (for example wizardzines.com was designed by <a href="https://melody.dev/">Melody Starling</a>)</li>
<li>use a totally custom theme</li>
<li>commit that theme to the same Github repo as the site</li>
</ol>
<p>So I just need to edit the theme files to fix any problems. Also I wrote a lot
of the theme myself so I&rsquo;m pretty familiar with how it works.</p>
<p>Relying on someone else to keep a theme updated feels kind of scary to me, I
think if I were using a third-party theme I&rsquo;d just copy the code into my site&rsquo;s
github repo and then maintain it myself.</p>
<h3 id="which-static-site-generators-have-better-backwards-compatibility">which static site generators have better backwards compatibility?</h3>
<p>I <a href="https://social.jvns.ca/@b0rk/113260718682453232">asked on Mastodon</a> if
anyone had used a static site generator with good backwards compatibility.</p>
<p>The main answers seemed to be Jekyll and 11ty. Several people said they&rsquo;d been
using Jekyll for 10 years without any issues, and 11ty says it has
<a href="https://www.11ty.dev/blog/stability/">stability as a core goal</a>.</p>
<p>I think a big factor in how appealing Jekyll/11ty are is how easy it is for you
to maintain a working Ruby / Node environment on your computer: part of the
reason I stopped using Jekyll was that I got tired of having to maintain a
working Ruby installation. But I imagine this wouldn&rsquo;t be a problem for a Ruby
or Node developer.</p>
<p>Several people said that they don&rsquo;t build their Jekyll site locally at all &ndash;
they just use GitHub Pages to build it.</p>
<h3 id="that-s-it">that&rsquo;s it!</h3>
<p>Overall I&rsquo;ve been happy with Hugo &ndash; I <a href="https://jvns.ca/blog/2016/10/09/switching-to-hugo/">started using it</a> because it had fast
build times and it was a static binary, and both of those things are still
extremely useful to me. I might have spent 10 hours on this upgrade, but I&rsquo;ve
probably spent 1000+ hours writing blog posts without thinking about Hugo at
all so that seems like an extremely reasonable ratio.</p>
<p>I find it hard to be too mad about the backwards incompatible changes, most of
them were quite a long time ago, Hugo does a great job of making their old
releases available so you can use the old release if you want, and the most
difficult one is removing support for the <code>blackfriday</code> Markdown renderer in
favour of using something CommonMark-compliant which seems pretty reasonable to
me even if it is a huge pain.</p>
<p>But it did take a long time and I don&rsquo;t think I&rsquo;d particularly recommend moving
700 blog posts to a new Markdown renderer unless you&rsquo;re really in the mood for
a lot of computer suffering for some reason.</p>
<p>The new renderer did fix a bunch of problems so I think overall it might be a
good thing, even if I&rsquo;ll have to remember to make 2 changes to how I write
Markdown (4.1 and 4.3).</p>
<p>Also I&rsquo;m still using Hugo 0.54 for <a href="https://wizardzines.com">https://wizardzines.com</a> so maybe these notes
will be useful to Future Me if I ever feel like upgrading Hugo for that site.</p>
<p>Hopefully I didn&rsquo;t break too many things on the blog by doing this, let me know
if you see anything broken!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Terminal colours are tricky]]></title>
    <link href="https://jvns.ca/blog/2024/10/01/terminal-colours/"/>
    <updated>2024-10-01T10:01:44+00:00</updated>
    <id>https://jvns.ca/blog/2024/10/01/terminal-colours/</id>
    <content type="html"><![CDATA[<p>Yesterday I was thinking about how long it took me to get a colorscheme in my
terminal that I was mostly happy with (SO MANY YEARS), and it made me wonder
what about terminal colours made it so hard.</p>
<p>So I <a href="https://social.jvns.ca/@b0rk/113226972156366201">asked people on Mastodon</a> what problems
they&rsquo;ve run into with colours in the terminal, and I got a ton of interesting
responses! Let&rsquo;s talk about some of the problems and a few possible ways to fix
them.</p>
<h3 id="problem-1-blue-on-black">problem 1: blue on black</h3>
<p>One of the top complaints was &ldquo;blue on black is hard to read&rdquo;. Here&rsquo;s an
example of that: if I open Terminal.app, set the background to black, and run
<code>ls</code>, the directories are displayed in a blue that isn&rsquo;t that easy to read:</p>
<img src="https://jvns.ca/images/terminal-blue.png" style="max-width: 400px">
<p>To understand why we&rsquo;re seeing this blue, let&rsquo;s talk about ANSI colours!</p>
<h3 id="the-16-ansi-colours">the 16 ANSI colours</h3>
<p>Your terminal has 16 numbered colours &ndash; black, red, green, yellow, blue,
magenta, cyan, white, and &ldquo;bright&rdquo; version of each of those.</p>
<p>Programs can use them by printing out an &ldquo;ANSI escape code&rdquo; &ndash; for example if
you want to see each of the 16 colours in your terminal, you can run this
Python program:</p>
<pre><code class="language-python">def color(num, text):
    return f&quot;\033[38;5;{num}m{text}\033[0m&quot;

for i in range(16):
    print(color(i, f&quot;number {i:02}&quot;))
</code></pre>
<h3 id="what-are-the-ansi-colours">what are the ANSI colours?</h3>
<p>This made me wonder &ndash; if blue is colour number 5, who decides what hex color
that should correspond to?</p>
<p>The answer seems to be &ldquo;there&rsquo;s no standard, terminal emulators just choose
colours and it&rsquo;s not very consistent&rdquo;. Here&rsquo;s a <a href="https://en.m.wikipedia.org/wiki/ANSI_escape_code#Colors">screenshot of a table from Wikipedia</a>, where you
can see that there&rsquo;s a lot of variation:</p>
<img src="https://jvns.ca/images/wikipedia.png"> 
<h3 id="problem-1-5-bright-yellow-on-white">problem 1.5: bright yellow on white</h3>
<p>Bright yellow on white is even worse than blue on black, here&rsquo;s what I get in
a terminal with the default settings:</p>
<img src="https://jvns.ca/images/terminal-yellow.png" style="max-height: 40px">
<p>That&rsquo;s almost impossible to read (and some other colours like light green cause
similar issues), so let&rsquo;s talk about solutions!</p>
<h3 id="two-ways-to-reconfigure-your-colours">two ways to reconfigure your colours</h3>
<p>If you&rsquo;re annoyed by these colour contrast issues (or maybe you just think the
default ANSI colours are ugly), you might think &ndash; well, I&rsquo;ll just choose a
different &ldquo;blue&rdquo; and pick something I like better!</p>
<p>There are two ways you can do this:</p>
<p><strong>Way 1: Configure your terminal emulator</strong>: I think most modern terminal emulators
have a way to reconfigure the colours, and some of them even come with some
preinstalled themes that you might like better than the defaults.</p>
<p><strong>Way 2: Run a shell script</strong>: There are ANSI escape codes that you can print
out to tell your terminal emulator to reconfigure its colours. <a href="https://github.com/chriskempson/base16-shell/blob/master/scripts/base16-solarized-light.sh">Here&rsquo;s a shell script that does that</a>,
from the <a href="https://github.com/chriskempson/base16-shell">base16-shell</a> project.
You can see that it has a few different conventions for changing the colours &ndash;
I guess different terminal emulators have different escape codes for changing
their colour palette, and so the script is trying to pick the right style of
escape code based on the <code>TERM</code> environment variable.</p>
<h3 id="what-are-the-pros-and-cons-of-the-2-ways-of-configuring-your-colours">what are the pros and cons of the 2 ways of configuring your colours?</h3>
<p>I prefer to use the &ldquo;shell script&rdquo; method, because:</p>
<ul>
<li>if I switch terminal emulators for some reason, I don&rsquo;t need to a different configuration system, my colours still Just Work</li>
<li>I use <a href="https://github.com/chriskempson/base16-shell">base16-shell</a> with base16-vim to make my vim colours match my terminal colours, which is convenient</li>
</ul>
<p>some advantages of configuring colours in your terminal emulator:</p>
<ul>
<li>if you use a popular terminal emulator, there are probably a lot more nice terminal themes out there that you can choose from</li>
<li>not all terminal emulators support the &ldquo;shell script method&rdquo;, and even if
they do, the results can be a little inconsistent</li>
</ul>
<p>This is what my shell has looked like for probably the last 5 years (using the
solarized light base16 theme), and I&rsquo;m pretty happy with it. Here&rsquo;s <code>htop</code>:</p>
<img src="https://jvns.ca/images/terminal-my-colours.png" style="max-width: 400px">
<p>Okay, so let&rsquo;s say you&rsquo;ve found a terminal colorscheme that you like. What else
can go wrong?</p>
<h3 id="problem-2-programs-using-256-colours">problem 2: programs using 256 colours</h3>
<p>Here&rsquo;s what some output of <code>fd</code>, a <code>find</code> alternative, looks like in my
colorscheme:</p>
<img src="https://jvns.ca/images/terminal-problem-fd.png" style="max-width: 400px">
<p>The contrast is pretty bad here, and I definitely don&rsquo;t have that lime green in
my normal colorscheme. What&rsquo;s going on?</p>
<p>We can see what color codes <code>fd</code> is using using the <code>unbuffer</code> program to
capture its output including the color codes:</p>
<pre><code>$ unbuffer fd . &gt; out
$ vim out
^[[38;5;48mbad-again.sh^[[0m
^[[38;5;48mbad.sh^[[0m
^[[38;5;48mbetter.sh^[[0m
out
</code></pre>
<p><code>^[[38;5;48</code> means &ldquo;set the foreground color to color <code>48</code>&rdquo;. Terminals don&rsquo;t
only have 16 colours &ndash; many terminals these days actually have 3 ways of
specifying colours:</p>
<ol>
<li>the 16 ANSI colours we already talked about</li>
<li>an extended set of 256 colours</li>
<li>a further extended set of 24-bit hex colours, like <code>#ffea03</code></li>
</ol>
<p>So <code>fd</code> is using one of the colours from the extended 256-color set. <code>bat</code> (a
<code>cat</code> alternative) does something similar &ndash; here&rsquo;s what it looks like by
default in my terminal.</p>
<img src="https://jvns.ca/images/terminal-bat.png" style="max-width: 400px">
<p>This looks fine though and it really seems like it&rsquo;s trying to work well with a
variety of terminal themes.</p>
<h3 id="some-newer-tools-seem-to-have-theme-support">some newer tools seem to have theme support</h3>
<p>I think it&rsquo;s interesting that some of these newer terminal tools (<code>fd</code>, <code>cat</code>,
<code>delta</code>, and probably more) have support for arbitrary custom themes. I guess
the downside of this approach is that the default theme might clash with your
terminal&rsquo;s background, but the upside is that it gives you a lot more control
over theming the tool&rsquo;s output than just choosing 16 ANSI colours.</p>
<p>I don&rsquo;t really use <code>bat</code>, but if I did I&rsquo;d probably use <code>bat --theme ansi</code> to
just use the ANSI colours that I have set in my normal terminal colorscheme.</p>
<h3 id="problem-3-the-grays-in-solarized">problem 3: the grays in Solarized</h3>
<p>A bunch of people on Mastodon mentioned a specific issue with grays in the
Solarized theme: when I list a directory, the base16 Solarized Light theme
looks like this:</p>
<img src="https://jvns.ca/images/terminal-solarized-base16.png" style="max-width: 400px">
<p>but iTerm&rsquo;s default Solarized Light theme looks like this:</p>
<img src="https://jvns.ca/images/terminal-solarized-iterm.png" style="max-width: 400px">
<p>This is because in the iTerm theme (which is the <a href="https://ethanschoonover.com/solarized/#the-values">original Solarized design</a>), colors 9-14 (the &ldquo;bright blue&rdquo;, &ldquo;bright
red&rdquo;, etc) are mapped to a series of grays, and when I run <code>ls</code>, it&rsquo;s trying to
use those &ldquo;bright&rdquo; colours to color my directories and executables.</p>
<p>My best guess for why the original Solarized theme is designed this way is to
make the grays available to the <a href="https://github.com/altercation/vim-colors-solarized/blob/528a59f26d12278698bb946f8fb82a63711eec21/colors/solarized.vim">vim Solarized colorscheme</a>.</p>
<p>I&rsquo;m pretty sure I prefer the modified base16 version I use where the &ldquo;bright&rdquo;
colours are actually colours instead of all being shades of gray though. (I
didn&rsquo;t actually realize the version I was using wasn&rsquo;t the &ldquo;original&rdquo; Solarized
theme until I wrote this post)</p>
<p>In any case I really love Solarized and I&rsquo;m very happy it exists so that I can
use a modified version of it.</p>
<h3 id="problem-4-a-vim-theme-that-doesn-t-match-the-terminal-background">problem 4: a vim theme that doesn&rsquo;t match the terminal background</h3>
<p>If I my vim theme has a different background colour than my terminal theme, I
get this ugly border, like this:</p>
<img src="https://jvns.ca/images/terminal-vim-black-bg.png" style="max-width: 400px">
<p>This one is a pretty minor issue though and I think making your terminal
background match your vim background is pretty straightforward.</p>
<h3 id="problem-5-programs-setting-a-background-color">problem 5: programs setting a background color</h3>
<p>A few people mentioned problems with terminal applications setting an
unwanted background colour, so let&rsquo;s look at an example of that.</p>
<p>Here <code>ngrok</code> has set the background to color #16 (&ldquo;black&rdquo;), but the
<code>base16-shell</code> script I use sets color 16 to be bright orange, so I get this,
which is pretty bad:</p>
<img src="https://jvns.ca/images/terminal-ngrok-solarized.png" style="max-width: 400px">
<p>I think the intention is for ngrok to look something like this:</p>
<img src="https://jvns.ca/images/terminal-ngrok-regular.png" style="max-width: 400px">
<p>I think <code>base16-shell</code> sets color #16 to orange (instead of black)
so that it can provide extra colours for use by <a href="https://github.com/chriskempson/base16-vim/blob/3be3cd82cd31acfcab9a41bad853d9c68d30478d/colors/base16-solarized-light.vim">base16-vim</a>.
This feels reasonable to me &ndash; I use <code>base16-vim</code> in the terminal, so I guess I&rsquo;m
using that feature and it&rsquo;s probably more important to me than <code>ngrok</code> (which I
rarely use) behaving a bit weirdly.</p>
<p>This particular issue is a maybe obscure clash between ngrok and my colorschem,
but I think this kind of clash is pretty common when a program sets an ANSI
background color that the user has remapped for some reason.</p>
<h3 id="a-nice-solution-to-contrast-issues-minimum-contrast">a nice solution to contrast issues: &ldquo;minimum contrast&rdquo;</h3>
<p>A bunch of terminals (iTerm2, <a href="https://github.com/Eugeny/tabby">tabby</a>, kitty&rsquo;s <a href="https://sw.kovidgoyal.net/kitty/conf/#opt-kitty.text_fg_override_threshold">text_fg_override_threshold</a>, and
folks tell me also Ghostty and Windows Terminal) have a &ldquo;minimum
contrast&rdquo; feature that will automatically adjust colours to make sure they have enough contrast.</p>
<p>Here&rsquo;s an example from iTerm. This ngrok accident from before has pretty bad
contrast, I find it pretty difficult to read:</p>
<img src="https://jvns.ca/images/terminal-ngrok-solarized.png" style="max-width: 400px">
<p>With &ldquo;minimum contrast&rdquo; set to 40 in iTerm, it looks like this instead:</p>
<img src="https://jvns.ca/images/terminal-ngrok-solarized-contrast.png" style="max-width: 400px">
<p>I didn&rsquo;t have minimum contrast turned on before but I just turned it on today
because it makes such a big difference when something goes wrong with colours
in the terminal.</p>
<h3 id="problem-6-term-being-set-to-the-wrong-thing">problem 6: <code>TERM</code> being set to the wrong thing</h3>
<p>A few people mentioned that they&rsquo;ll SSH into a system that doesn&rsquo;t support the
<code>TERM</code> environment variable that they have set locally, and then the colours
won&rsquo;t work.</p>
<p>I think the way <code>TERM</code> works is that systems have a <code>terminfo</code> database, so if
the value of the <code>TERM</code> environment variable isn&rsquo;t in the system&rsquo;s terminfo
database, then it won&rsquo;t know how to output colours for that terminal. I don&rsquo;t
know too much about terminfo, but someone linked me to this <a href="https://twoot.site/@bean/113056942625234032">terminfo rant</a> that talks about a few other
issues with terminfo.</p>
<p>I don&rsquo;t have a system on hand to reproduce this one so I can&rsquo;t say for sure how
to fix it, but <a href="https://unix.stackexchange.com/questions/67537/prevent-ssh-client-passing-term-environment-variable-to-server">this stackoverflow question</a>
suggests running something like <code>TERM=xterm ssh</code> instead of <code>ssh</code>.</p>
<h3 id="problem-7-picking-good-colours-is-hard">problem 7: picking &ldquo;good&rdquo; colours is hard</h3>
<p>A couple of problems people mentioned with designing / finding terminal colorschemes:</p>
<ul>
<li>some folks are colorblind and have trouble finding an appropriate colorscheme</li>
<li>accidentally making the background color too close to the cursor or selection color, so they&rsquo;re hard to find</li>
<li>generally finding colours that work with every program is a struggle (for example you can see me having a problem with this with ngrok above!)</li>
</ul>
<h3 id="problem-8-making-nethack-mc-look-right">problem 8: making nethack/mc look right</h3>
<p>Another problem people mentioned is using a program like nethack or midnight
commander which you might expect to have a specific colourscheme based on the
default ANSI terminal colours.</p>
<p>For example, midnight commander has a really specific classic look:</p>
<img src="https://jvns.ca/images/terminal-mc-normal.png" style="max-width: 200px">
<p>But in my Solarized theme, midnight commander looks like this:</p>
<img src="https://jvns.ca/images/terminal-mc-solarized.png" style="max-width: 200px">
<p>The Solarized version feels like it could be disorienting if you&rsquo;re
very used to the &ldquo;classic&rdquo; look.</p>
<p>One solution Simon Tatham mentioned to this is using some palette customization
ANSI codes (like the ones base16 uses that I talked about earlier) to change
the color palette right before starting the program, for example remapping
yellow to a brighter yellow before starting Nethack so that the yellow
characters look better.</p>
<h3 id="problem-9-commands-disabling-colours-when-writing-to-a-pipe">problem 9: commands disabling colours when writing to a pipe</h3>
<p>If I run <code>fd | less</code>, I see something like this, with the colours disabled.</p>
<img src="https://jvns.ca/images/terminal-fd-bw.png" style="max-width: 300px">
<p>In general I find this useful &ndash; if I pipe a command to <code>grep</code>, I don&rsquo;t want it
to print out all those color escape codes, I just want the plain text. But what if you want to see the colours?</p>
<p>To see the colours, you can run <code>unbuffer fd | less -r</code>! I just learned about
<code>unbuffer</code> recently and I think it&rsquo;s really cool, <code>unbuffer</code> opens a tty for the
command to write to so that it thinks it&rsquo;s writing to a TTY. It also fixes
issues with programs buffering their output when writing to a pipe, which is
why it&rsquo;s called <code>unbuffer</code>.</p>
<p>Here&rsquo;s what the output of <code>unbuffer fd | less -r</code> looks like for me:</p>
<img src="https://jvns.ca/images/terminal-fd-color.png" style="max-width: 300px">
<p>Also some commands (including <code>fd</code>) support a <code>--color=always</code> flag which will
force them to always print out the colours.</p>
<h3 id="problem-10-unwanted-colour-in-ls-and-other-commands">problem 10: unwanted colour in <code>ls</code> and other commands</h3>
<p>Some people mentioned that they don&rsquo;t want <code>ls</code> to use colour at all, perhaps
because <code>ls</code> uses blue, it&rsquo;s hard to read on black, and maybe they don&rsquo;t feel like
customizing their terminal&rsquo;s colourscheme to make the blue more readable or
just don&rsquo;t find the use of colour helpful.</p>
<p>Some possible solutions to this one:</p>
<ul>
<li>you can run <code>ls --color=never</code>, which is probably easiest</li>
<li>you can also set <code>LS_COLORS</code> to customize the colours used by <code>ls</code>. I think some other programs other than <code>ls</code> support the <code>LS_COLORS</code> environment variable too.</li>
<li>also some programs support setting <code>NO_COLOR=true</code> (there&rsquo;s a <a href="https://no-color.org/">list here</a>)</li>
</ul>
<p>Here&rsquo;s an example of running <code>LS_COLORS=&quot;fi=0:di=0:ln=0:pi=0:so=0:bd=0:cd=0:or=0:ex=0&quot; ls</code>:</p>
<img src="https://jvns.ca/images/terminal-ls-colors.png" style="max-width: 500px">
<h3 id="problem-11-the-colours-in-vim">problem 11: the colours in vim</h3>
<p>I used to have a lot of problems with configuring my colours in vim &ndash; I&rsquo;d set
up my terminal colours in a way that I thought was okay, and then I&rsquo;d start vim
and it would just be a disaster.</p>
<p>I think what was going on here is that today, there are two ways to set up a vim colorscheme in the terminal:</p>
<ol>
<li>using your ANSI terminal colours &ndash; you tell vim which ANSI colour number to use for the background, for functions, etc.</li>
<li>using 24-bit hex colours &ndash; instead of ANSI terminal colours, the vim colorscheme can use hex codes like #faea99 directly</li>
</ol>
<p>20 years ago when I started using vim, terminals with 24-bit hex color support
were a lot less common (or maybe they didn&rsquo;t exist at all), and vim certainly
didn&rsquo;t have support for using 24-bit colour in the terminal. From some quick
searching through git, it looks like <a href="https://github.com/vim/vim/commit/8a633e3427b47286869aa4b96f2bfc1fe65b25cd">vim added support for 24-bit colour in 2016</a>
&ndash; just 8 years ago!</p>
<p>So to get colours to work properly in vim before 2016, you needed to synchronize
your terminal colorscheme and your vim colorscheme. <a href="https://github.com/chriskempson/base16-vim/blob/3be3cd82cd31acfcab9a41bad853d9c68d30478d/colors/base16-solarized-light.vim#L52-L71">Here&rsquo;s what that looked like</a>,
the colorscheme needed to map the vim color classes like <code>cterm05</code> to ANSI colour numbers.</p>
<p>But in 2024, the story is really different! Vim (and Neovim, which I use now)
support 24-bit colours, and as of Neovim 0.10 (released in May 2024), the
<code>termguicolors</code> setting (which tells Vim to use 24-bit hex colours for
colorschemes) is <a href="https://neovim.io/doc/user/news-0.10.html">turned on by default</a> in any terminal with 24-bit
color support.</p>
<p>So this &ldquo;you need to synchronize your terminal colorscheme and your vim
colorscheme&rdquo; problem is not an issue anymore for me in 2024, since I
don&rsquo;t plan to use terminals without 24-bit color support in the future.</p>
<p>The biggest consequence for me of this whole thing is that I don&rsquo;t need base16
to set colors 16-21 to weird stuff anymore to integrate with vim &ndash; I can just
use a terminal theme and a vim theme, and as long as the two themes use similar
colours (so it&rsquo;s not jarring for me to switch between them) there&rsquo;s no problem.
I think I can just remove those parts from my <code>base16</code> shell script and totally
avoid the problem with ngrok and the weird orange background I talked about
above.</p>
<h3 id="some-more-problems-i-left-out">some more problems I left out</h3>
<p>I think there are a lot of issues around the intersection of multiple programs,
like using some combination tmux/ssh/vim that I couldn&rsquo;t figure out how to
reproduce well enough to talk about them. Also I&rsquo;m sure I missed a lot of other
things too.</p>
<h3 id="base16-has-really-worked-for-me">base16 has really worked for me</h3>
<p>I&rsquo;ve personally had a lot of success with using
<a href="https://github.com/chriskempson/base16-shell">base16-shell</a> with
<a href="https://github.com/chriskempson/base16-vim">base16-vim</a> &ndash; I just need to add <a href="https://github.com/chriskempson/base16-shell?tab=readme-ov-file#fish">a couple of lines</a> to my
fish config to set it up (+ a few <code>.vimrc</code> lines) and then I can move on and
accept any remaining problems that that doesn&rsquo;t solve.</p>
<p>I don&rsquo;t think base16 is for everyone though, some limitations I&rsquo;m aware
of with base16 that might make it not work for you:</p>
<ul>
<li>it comes with a limited set of builtin themes and you might not like any of them</li>
<li>the Solarized base16 theme (and maybe all of the themes?) sets the &ldquo;bright&rdquo;
ANSI colours to be exactly the same as the normal colours, which might cause
a problem if you&rsquo;re relying on the &ldquo;bright&rdquo; colours to be different from the
regular ones</li>
<li>it sets colours 16-21 in order to give the vim colorschemes from <code>base16-vim</code>
access to more colours, which might not be relevant if you always use a
terminal with 24-bit color support, and can cause problems like the ngrok
issue above</li>
<li>also the way it sets colours 16-21 could be a problem in terminals that don&rsquo;t
have 256-color support, like the linux framebuffer terminal</li>
</ul>
<p>Apparently there&rsquo;s a community fork of base16 called
<a href="https://github.com/tinted-theming/home">tinted-theming</a>, which I haven&rsquo;t
looked into much yet.</p>
<h3 id="some-other-colorscheme-tools">some other colorscheme tools</h3>
<p>Just one so far but I&rsquo;ll link more if people tell me about them:</p>
<ul>
<li><a href="https://rootloops.sh/">rootloops.sh</a> for generating colorschemes (and <a href="https://hamvocke.com/blog/lets-create-a-terminal-color-scheme/">&ldquo;let&rsquo;s create a terminal color scheme&rdquo;</a>)</li>
<li>Some popular colorschemes (according to people I asked on Mastodon): <a href="https://catppuccin.com/">catpuccin</a>, Monokai, Gruvbox, <a href="https://github.com/dracula">Dracula</a>, <a href="https://protesilaos.com/emacs/modus-themes">Modus (a high contrast theme)</a>, <a href="https://github.com/folke/tokyonight.nvim">Tokyo Night</a>, <a href="https://www.nordtheme.com/">Nord</a>, <a href="https://rosepinetheme.com/">Rosé Pine</a></li>
</ul>
<h3 id="okay-that-was-a-lot">okay, that was a lot</h3>
<p>We talked about a lot in this post and  while I think learning about all these
details is kind of fun if I&rsquo;m in the mood to do a deep dive, I find it SO
FRUSTRATING to deal with it when I just want my colours to work! Being
surprised by unreadable text and having to find a workaround is just not my
idea of a good day.</p>
<p>Personally I&rsquo;m a zero-configuration kind of person and it&rsquo;s not that appealing
to me to have to put together a lot of custom configuration just to make my
colours in the terminal look acceptable. I&rsquo;d much rather just have some
reasonable defaults that I don&rsquo;t have to change.</p>
<h3 id="minimum-contrast-seems-like-an-amazing-feature">minimum contrast seems like an amazing feature</h3>
<p>My one big takeaway from writing this was to turn on &ldquo;minimum contrast&rdquo; in my
terminal, I think it&rsquo;s going to fix most of the occasional accidental
unreadable text issues I run into and I&rsquo;m pretty excited about it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Some Go web dev notes]]></title>
    <link href="https://jvns.ca/blog/2024/09/27/some-go-web-dev-notes/"/>
    <updated>2024-09-27T11:16:00+00:00</updated>
    <id>https://jvns.ca/blog/2024/09/27/some-go-web-dev-notes/</id>
    <content type="html"><![CDATA[<p>I spent a lot of time in the past couple of weeks working on a website in Go
that may or may not ever see the light of day, but I learned a couple of things
along the way I wanted to write down. Here they are:</p>
<h3 id="go-1-22-now-has-better-routing">go 1.22 now has better routing</h3>
<p>I&rsquo;ve never felt motivated to learn any of the Go routing libraries
(gorilla/mux, chi, etc), so I&rsquo;ve been doing all my routing by hand, like this.</p>
<pre><code>	// DELETE /records:
	case r.Method == &quot;DELETE&quot; &amp;&amp; n == 1 &amp;&amp; p[0] == &quot;records&quot;:
		if !requireLogin(username, r.URL.Path, r, w) {
			return
		}
		deleteAllRecords(ctx, username, rs, w, r)
	// POST /records/&lt;ID&gt;
	case r.Method == &quot;POST&quot; &amp;&amp; n == 2 &amp;&amp; p[0] == &quot;records&quot; &amp;&amp; len(p[1]) &gt; 0:
		if !requireLogin(username, r.URL.Path, r, w) {
			return
		}
		updateRecord(ctx, username, p[1], rs, w, r)

</code></pre>
<p>But apparently <a href="https://go.dev/blog/routing-enhancements">as of Go 1.22</a>, Go
now has better support for routing in the standard library, so that code can be
rewritten something like this:</p>
<pre><code>	mux.HandleFunc(&quot;DELETE /records/&quot;, app.deleteAllRecords)
	mux.HandleFunc(&quot;POST /records/{record_id}&quot;, app.updateRecord)
</code></pre>
<p>Though it would also need a login middleware, so maybe something more like
this, with a <code>requireLogin</code> middleware.</p>
<pre><code>	mux.Handle(&quot;DELETE /records/&quot;, requireLogin(http.HandlerFunc(app.deleteAllRecords)))
</code></pre>
<h3 id="a-gotcha-with-the-built-in-router-redirects-with-trailing-slashes">a gotcha with the built-in router: redirects with trailing slashes</h3>
<p>One annoying gotcha I ran into was: if I make a route for <code>/records/</code>, then a
request for <code>/records</code> <a href="https://pkg.go.dev/net/http#hdr-Trailing_slash_redirection-ServeMux">will be redirected</a> to <code>/records/</code>.</p>
<p>I ran into an issue with this where sending a POST request to <code>/records</code>
redirected to a GET request for <code>/records/</code>, which broke the POST request
because it removed the request body. Thankfully <a href="https://xeiaso.net/blog/go-servemux-slash-2021-11-04/">Xe Iaso wrote a blog post about the exact same issue</a> which made it
easier to debug.</p>
<p>I think the solution to this is just to use API endpoints like <code>POST /records</code>
instead of <code>POST /records/</code>, which seems like a more normal design anyway.</p>
<h3 id="sqlc-automatically-generates-code-for-my-db-queries">sqlc automatically generates code for my db queries</h3>
<p>I got a little bit tired of writing so much boilerplate for my SQL queries, but
I didn&rsquo;t really feel like learning an ORM, because I know what SQL queries I
want to write, and I didn&rsquo;t feel like learning the ORM&rsquo;s conventions for
translating things into SQL queries.</p>
<p>But then I found <a href="https://sqlc.dev/">sqlc</a>, which will compile a query like this:</p>
<pre><code>
-- name: GetVariant :one
SELECT *
FROM variants
WHERE id = ?;

</code></pre>
<p>into Go code like this:</p>
<pre><code>const getVariant = `-- name: GetVariant :one
SELECT id, created_at, updated_at, disabled, product_name, variant_name
FROM variants
WHERE id = ?
`

func (q *Queries) GetVariant(ctx context.Context, id int64) (Variant, error) {
	row := q.db.QueryRowContext(ctx, getVariant, id)
	var i Variant
	err := row.Scan(
		&amp;i.ID,
		&amp;i.CreatedAt,
		&amp;i.UpdatedAt,
		&amp;i.Disabled,
		&amp;i.ProductName,
		&amp;i.VariantName,
	)
	return i, err
}
</code></pre>
<p>What I like about this is that if I&rsquo;m ever unsure about what Go code to write
for a given SQL query, I can just write the query I want, read the generated
function and it&rsquo;ll tell me exactly what to do to call it. It feels much easier
to me than trying to dig through the ORM&rsquo;s documentation to figure out how to
construct the SQL query I want.</p>
<p>Reading <a href="https://brandur.org/fragments/sqlc-2024">Brandur&rsquo;s sqlc notes from 2024</a> also gave me some confidence
that this is a workable path for my tiny programs. That post gives a really
helpful example of how to conditionally update fields in a table using CASE
statements (for example if you have a table with 20 columns and you only want
to update 3 of them).</p>
<h3 id="sqlite-tips">sqlite tips</h3>
<p>Someone on Mastodon linked me to this post called <a href="https://kerkour.com/sqlite-for-servers">Optimizing sqlite for servers</a>. My projects are small and I&rsquo;m
not so concerned about performance, but my main takeaways were:</p>
<ul>
<li>have a dedicated object for <strong>writing</strong> to the database, and run
<code>db.SetMaxOpenConns(1)</code> on it. I learned the hard way that if I don&rsquo;t do this
then I&rsquo;ll get <code>SQLITE_BUSY</code> errors from two threads trying to write to the db
at the same time.</li>
<li>if I want to make reads faster, I could have 2 separate db objects, one for writing and one for reading</li>
</ul>
<p>There are a more tips in that post that seem useful (like &ldquo;COUNT queries are
slow&rdquo; and &ldquo;Use STRICT tables&rdquo;), but I haven&rsquo;t done those yet.</p>
<p>Also sometimes if I have two tables where I know I&rsquo;ll never need to do a <code>JOIN</code>
beteween them, I&rsquo;ll just put them in separate databases so that I can connect
to them independently.</p>
<h3 id="go-1-19-introduced-a-way-to-set-a-gc-memory-limit">Go 1.19 introduced a way to set a GC memory limit</h3>
<p>I run all of my Go projects in VMs with relatively little memory, like 256MB or
512MB. I ran into an issue where my application kept getting OOM killed and it
was confusing &ndash; did I have a memory leak? What?</p>
<p>After some Googling, I realized that maybe I didn&rsquo;t have a memory leak, maybe I
just needed to reconfigure the garbage collector! It turns out that by default (according to <a href="https://tip.golang.org/doc/gc-guide">A Guide to the Go Garbage Collector</a>), Go&rsquo;s garbage collector will
let the application allocate memory up to <strong>2x</strong> the current heap size.</p>
<p><a href="https://messwithdns.net">Mess With DNS</a>&rsquo;s base heap size is around 170MB and
the amount of memory free on the VM is around 160MB right now, so if its memory
doubled, it&rsquo;ll get OOM killed.</p>
<p>In Go 1.19, they added a way to tell Go &ldquo;hey, if the application starts using
this much memory, run a GC&rdquo;. So I set the GC memory limit to 250MB and it seems
to have resulted in the application getting OOM killed less often:</p>
<pre><code>export GOMEMLIMIT=250MiB
</code></pre>
<h3 id="some-reasons-i-like-making-websites-in-go">some reasons I like making websites in Go</h3>
<p>I&rsquo;ve been making tiny websites (like the <a href="https://nginx-playground.wizardzines.com/">nginx playground</a>) in Go on and off for the last 4 years or so and it&rsquo;s really been working for me. I think I like it because:</p>
<ul>
<li>there&rsquo;s just 1 static binary, all I need to do to deploy it is copy the binary. If there are static files I can just embed them in the binary with <a href="https://pkg.go.dev/embed">embed</a>.</li>
<li>there&rsquo;s a built-in webserver that&rsquo;s okay to use in production, so I don&rsquo;t need to configure WSGI or whatever to get it to work. I can just put it behind <a href="https://caddyserver.com/">Caddy</a> or run it on fly.io or whatever.</li>
<li>Go&rsquo;s toolchain is very easy to install, I can just do <code>apt-get install golang-go</code> or whatever and then a <code>go build</code> will build my project</li>
<li>it feels like there&rsquo;s very little to remember to start sending HTTP responses
&ndash; basically all there is are functions like <code>Serve(w http.ResponseWriter, r *http.Request)</code> which read the request and send a response. If I need to
remember some detail of how exactly that&rsquo;s accomplished, I just have to read
the function!</li>
<li>also <code>net/http</code> is in the standard library, so you can start making websites
without installing any libraries at all. I really appreciate this one.</li>
<li>Go is a pretty systems-y language, so if I need to run an <code>ioctl</code> or
something that&rsquo;s easy to do</li>
</ul>
<p>In general everything about it feels like it makes projects easy to work on for
5 days, abandon for 2 years, and then get back into writing code without a lot
of problems.</p>
<p>For contrast, I&rsquo;ve tried to learn Rails a couple of times and I really <em>want</em>
to love Rails &ndash; I&rsquo;ve made a couple of toy websites in Rails and it&rsquo;s always
felt like a really magical experience. But ultimately when I come back to those
projects I can&rsquo;t remember how anything works and I just end up giving up. It
feels easier to me to come back to my Go projects that are full of a lot of
repetitive boilerplate, because at least I can read the code and figure out how
it works.</p>
<h3 id="things-i-haven-t-figured-out-yet">things I haven&rsquo;t figured out yet</h3>
<p>some things I haven&rsquo;t done much of yet in Go:</p>
<ul>
<li>rendering HTML templates: usually my Go servers are just APIs and I make the
frontend a single-page app with Vue. I&rsquo;ve used <code>html/template</code> a lot in Hugo (which I&rsquo;ve used for this blog for the last 8 years)
but I&rsquo;m still not sure how I feel about it.</li>
<li>I&rsquo;ve never made a real login system, usually my servers don&rsquo;t have users at all.</li>
<li>I&rsquo;ve never tried to implement CSRF</li>
</ul>
<p>In general I&rsquo;m not sure how to implement security-sensitive features so I don&rsquo;t
start projects which need login/CSRF/etc. I imagine this is where a framework
would help.</p>
<h3 id="it-s-cool-to-see-the-new-features-go-has-been-adding">it&rsquo;s cool to see the new features Go has been adding</h3>
<p>Both of the Go features I mentioned in this post (<code>GOMEMLIMIT</code> and the routing)
are new in the last couple of years and I didn&rsquo;t notice when they came out. It
makes me think I should pay closer attention to the release notes for new Go
versions.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Reasons I still love the fish shell]]></title>
    <link href="https://jvns.ca/blog/2024/09/12/reasons-i--still--love-fish/"/>
    <updated>2024-09-12T15:09:12+00:00</updated>
    <id>https://jvns.ca/blog/2024/09/12/reasons-i--still--love-fish/</id>
    <content type="html"><![CDATA[<p>I wrote about how much I love <a href="https://fishshell.com/">fish</a> in <a href="https://jvns.ca/blog/2017/04/23/the-fish-shell-is-awesome/">this blog post from 2017</a> and, 7 years
of using it every day later, I&rsquo;ve found even more reasons to love it. So I
thought I&rsquo;d write a new post with both the old reasons I loved it and some
reasons.</p>
<p>This came up today because I was trying to figure out why my terminal doesn&rsquo;t
break anymore when I cat a binary to my terminal, the answer was &ldquo;fish fixes
the terminal!&rdquo;, and I just thought that was really nice.</p>
<h3 id="1-no-configuration">1. no configuration</h3>
<p>In 10 years of using fish I have never found a single thing I wanted to configure. It just works the way I want. My fish config file just has:</p>
<ul>
<li>environment variables</li>
<li>aliases (<code>alias ls eza</code>, <code>alias vim nvim</code>, etc)</li>
<li>the occasional <code>direnv hook fish | source</code> to integrate a tool like direnv</li>
<li>a script I run to set up my <a href="https://github.com/chriskempson/base16-shell/blob/588691ba71b47e75793ed9edfcfaa058326a6f41/scripts/base16-solarized-light.sh">terminal colours</a></li>
</ul>
<p>I&rsquo;ve been told that configuring things in fish is really easy if you ever do
want to configure something though.</p>
<h3 id="2-autosuggestions-from-my-shell-history">2. autosuggestions from my shell history</h3>
<p>My absolute favourite thing about fish is that I type, it’ll automatically
suggest (in light grey) a matching command that I ran recently. I can press the
right arrow key to accept the completion, or keep typing to ignore it.</p>
<p>Here’s what that looks like. In this example I just typed the “v” key and it
guessed that I want to run the previous vim command again.</p>
<img src="https://jvns.ca/images/fish-2024.png">
<h3 id="2-5-smart-shell-autosuggestions">2.5 &ldquo;smart&rdquo; shell autosuggestions</h3>
<p>One of my favourite subtle autocomplete features is how fish handles autocompleting commands that contain paths in them. For example, if I run:</p>
<pre><code>$ ls blah.txt
</code></pre>
<p>that command will only be autocompleted in directories that contain <code>blah.txt</code> &ndash; it won&rsquo;t show up in a different directory. (here&rsquo;s <a href="https://github.com/fish-shell/fish-shell/issues/120#issuecomment-6376019">a short comment about how it works</a>)</p>
<p>As an example, if in this directory I type <code>bash scripts/</code>, it&rsquo;ll only suggest
history commands including files that <em>actually exist</em> in my blog&rsquo;s scripts
folder, and not the dozens of other irrelevant <code>scripts/</code> commands I&rsquo;ve run in
other folders.</p>
<p>I didn&rsquo;t understand exactly how this worked until last week, it just felt like fish was
magically able to suggest the right commands. It still feels a little like magic and I love it.</p>
<h3 id="3-pasting-multiline-commands">3. pasting multiline commands</h3>
<p>If I copy and paste multiple lines, bash will run them all, like this:</p>
<pre><code>[bork@grapefruit linux-playground (main)]$ echo hi
hi
[bork@grapefruit linux-playground (main)]$ touch blah
[bork@grapefruit linux-playground (main)]$ echo hi
hi
</code></pre>
<p>This is a bit alarming &ndash; what if I didn&rsquo;t actually <em>want</em> to run all those
commands?</p>
<p>Fish will paste them all at a single prompt, so that I can press Enter if I
actually want to run them. Much less scary.</p>
<pre><code>bork@grapefruit ~/work/&gt; echo hi

                         touch blah
                         echo hi
</code></pre>
<h3 id="4-nice-tab-completion">4. nice tab completion</h3>
<p>If I run <code>ls</code> and press tab, it&rsquo;ll display all the filenames in a nice grid. I can use either Tab, Shift+Tab, or the arrow keys to navigate the grid.</p>
<p>Also, I can tab complete from the <strong>middle</strong> of a filename &ndash; if the filename
starts with a weird character (or if it&rsquo;s just not very unique), I can type
some characters from the middle and press tab.</p>
<p>Here&rsquo;s what the tab completion looks like:</p>
<pre><code>bork@grapefruit ~/work/&gt; ls 
api/  blah.py     fly.toml   README.md
blah  Dockerfile  frontend/  test_websocket.sh
</code></pre>
<p>I honestly don&rsquo;t complete things other than filenames very much so I can&rsquo;t
speak to that, but I&rsquo;ve found the experience of tab completing filenames to be
very good.</p>
<h3 id="5-nice-default-prompt-including-git-integration">5. nice default prompt (including git integration)</h3>
<p>Fish&rsquo;s default prompt includes everything I want:</p>
<ul>
<li>username</li>
<li>hostname</li>
<li>current folder</li>
<li>git integration</li>
<li>status of last command exit (if the last command failed)</li>
</ul>
<p>Here&rsquo;s a screenshot with a few different variations on the default prompt,
including if the last command was interrupted (the <code>SIGINT</code>) or failed.</p>
<img src="https://jvns.ca/images/fish-prompt-2024.png">
<h3 id="6-nice-history-defaults">6. nice history defaults</h3>
<p>In bash, the maximum history size is 500 by default, presumably because
computers used to be slow and not have a lot of disk space. Also, by default,
commands don&rsquo;t get added to your history until you end your session. So if your
computer crashes, you lose some history.</p>
<p>In fish:</p>
<ol>
<li>the default history size is 256,000 commands. I don&rsquo;t see any reason I&rsquo;d ever need more.</li>
<li>if you open a new tab, everything you&rsquo;ve ever run (including commands in
open sessions) is immediately available to you</li>
<li>in an existing session, the history search will only include commands from
the current session, plus everything that was in history at the time that
you started the shell</li>
</ol>
<p>I&rsquo;m not sure how clearly I&rsquo;m explaining how fish&rsquo;s history system works here,
but it feels really good to me in practice. My impression is that the way it&rsquo;s
implemented is the commands are continually added to the history file, but fish
only loads the history file once, on startup.</p>
<p>I&rsquo;ll mention here that if you want to have a fancier history system in another
shell it might be worth checking out <a href="https://github.com/atuinsh/atuin">atuin</a> or <a href="https://github.com/junegunn/fzf">fzf</a>.</p>
<h3 id="7-press-up-arrow-to-search-history">7. press up arrow to search history</h3>
<p>I also like fish&rsquo;s interface for searching history: for example if I want to
edit my fish config file, I can just type:</p>
<pre><code>$ config.fish
</code></pre>
<p>and then press the up arrow to go back the last command that included <code>config.fish</code>. That&rsquo;ll complete to:</p>
<pre><code>$ vim ~/.config/fish/config.fish
</code></pre>
<p>and I&rsquo;m done. This isn&rsquo;t <em>so</em> different from using <code>Ctrl+R</code> in bash to search
your history but I think I like it a little better over all, maybe because
<code>Ctrl+R</code> has some behaviours that I find confusing (for example you can
end up accidentally editing your history which I don&rsquo;t like).</p>
<h3 id="8-the-terminal-doesn-t-break">8. the terminal doesn&rsquo;t break</h3>
<p>I used to run into issues with bash where I&rsquo;d accidentally <code>cat</code> a binary to
the terminal, and it would break the terminal.</p>
<p>Every time fish displays a prompt, it&rsquo;ll try to fix up your terminal so that
you don&rsquo;t end up in weird situations like this. I think <a href="https://github.com/fish-shell/fish-shell/blob/a979b6341d7fc4c466b3992f25da3209e0808aaa/src/reader.rs#L3601-L3623">this is some of the
code in fish to prevent broken terminals</a>.</p>
<p>Some things that it does are:</p>
<ul>
<li>turn on <code>echo</code> so that you can see the characters you type</li>
<li>make sure that newlines work properly so that you don&rsquo;t get that weird staircase effect</li>
<li>reset your terminal background colour, etc</li>
</ul>
<p>I don&rsquo;t think I&rsquo;ve run into any of these &ldquo;my terminal is broken&rdquo; issues in a
very long time, and I actually didn&rsquo;t even realize that this was because of
fish &ndash; I thought that things somehow magically just got better, or maybe I
wasn&rsquo;t making as many mistakes. But I think it was mostly fish saving me from
myself, and I really appreciate that.</p>
<h3 id="9-ctrl-s-is-disabled">9. Ctrl+S is disabled</h3>
<p>Also related to terminals breaking: fish disables Ctrl+S (which freezes your
terminal and then you need to remember to press Ctrl+Q to unfreeze it). It&rsquo;s a
feature that I&rsquo;ve never wanted and I&rsquo;m happy to not have it.</p>
<p>Apparently you can disable <code>Ctrl+S</code> in other shells with <code>stty -ixon</code>.</p>
<h3 id="10-fish-add-path">10. <code>fish_add_path</code></h3>
<p>I have mixed feelings about this one, but in Fish you can use <code>fish_add_path /opt/whatever/bin</code> to add a path to your PATH, globally, permanently, across
all open shell sessions. This can get a bit confusing if you forget where
those PATH entries are configured but overall I think I appreciate it.</p>
<h3 id="11-nice-syntax-highlighting">11. nice syntax highlighting</h3>
<p>By default commands that don&rsquo;t exist are highlighted in red, like this.</p>
<img src="https://jvns.ca/images/fish-syntax-2024.png">
<h3 id="12-easier-loops">12. easier loops</h3>
<p>I find the loop syntax in fish a lot easier to type than the bash syntax. It looks like this:</p>
<pre><code>for i in *.yaml
  echo $i
end
</code></pre>
<p>Also it&rsquo;ll add indentation in your loops which is nice.</p>
<h3 id="13-easier-multiline-editing">13. easier multiline editing</h3>
<p>Related to loops: you can edit multiline commands much more easily than in bash
(just use the arrow keys to navigate the multiline command!). Also when you use
the up arrow to get a multiline command from your history, it&rsquo;ll show you the
whole command the exact same way you typed it instead of squishing it all onto
one line like bash does:</p>
<pre><code>$ bash
$ for i in *.png
&gt; do
&gt; echo $i
&gt; done
$ # press up arrow
$ for i in *.png; do echo $i; done ink
</code></pre>
<h3 id="14-ctrl-left-arrow">14. Ctrl+left arrow</h3>
<p>This might just be me, but I really appreciate that fish has the <code>Ctrl+left arrow</code> / <code>Ctrl+right arrow</code> keyboard shortcut for moving between
words when writing a command.</p>
<p>I&rsquo;m honestly a bit confused about where this keyboard shortcut is coming from
(the only documented keyboard shortcut for this I can find in fish is <code>Alt+left arrow</code> / <code>Alt + right arrow</code> which seems to do the same thing), but I&rsquo;m pretty
sure this is a fish shortcut.</p>
<p>A couple of notes about getting this shortcut to work / where it comes from:</p>
<ul>
<li>one person said they needed to switch their terminal emulator from the &ldquo;Linux
console&rdquo; keybindings to &ldquo;Default (XFree 4)&rdquo; to get it to work in fish</li>
<li>on Mac OS, <code>Ctrl+left arrow</code> switches workspaces by default, so I had to turn
that off.</li>
<li>Also apparently Ubuntu configures libreadline in <code>/etc/inputrc</code> to make
<code>Ctrl+left/right arrow</code> go back/forward a word, so it&rsquo;ll work in bash on
Ubuntu and maybe other Linux distros too. Here&rsquo;s a <a href="https://stackoverflow.com/questions/5029118/bash-ctrl-to-move-cursor-between-words-strings">stack overflow question talking about that</a></li>
</ul>
<h3 id="a-downside-not-everything-has-a-fish-integration">a downside: not everything has a fish integration</h3>
<p>Sometimes tools don&rsquo;t have instructions for integrating them with fish. That&rsquo;s annoying, but:</p>
<ul>
<li>I&rsquo;ve found this has gotten better over the last 10 years as fish has gotten
more popular. For example Python&rsquo;s virtualenv has had a fish integration for
a long time now.</li>
<li>If I need to run a POSIX shell command real quick, I can always just run <code>bash</code> or <code>zsh</code></li>
<li>I&rsquo;ve gotten much better over the years at translating simple commands to fish syntax when I need to</li>
</ul>
<p>My biggest day-to-day to annoyance is probably that for whatever reason I&rsquo;m
still not  used to fish&rsquo;s syntax for setting environment variables, I get confused
about <code>set</code> vs <code>set -x</code>.</p>
<h3 id="on-posix-compatibility">on POSIX compatibility</h3>
<p>When I started using fish, you couldn&rsquo;t do things like <code>cmd1 &amp;&amp; cmd2</code> &ndash; it
would complain &ldquo;no, you need to run <code>cmd1; and cmd2</code>&rdquo; instead.</p>
<p>It seems like over the years fish has started accepting a little more POSIX-style syntax than it used to, like:</p>
<ul>
<li><code>cmd1 &amp;&amp; cmd2</code></li>
<li><code>export a=b</code> to set an environment variable (though this seems a bit limited, you can&rsquo;t do <code>export PATH=$PATH:/whatever</code> so I think it&rsquo;s probably better to learn <code>set</code> instead)</li>
</ul>
<h3 id="on-fish-as-a-default-shell">on fish as a default shell</h3>
<p>Changing my default shell to fish is always a little annoying, I occasionally get myself into a situation where</p>
<ol>
<li>I install fish somewhere like maybe <code>/home/bork/.nix-stuff/bin/fish</code></li>
<li>I add the new fish location to <code>/etc/shells</code> as an allowed shell</li>
<li>I change my shell with <code>chsh</code></li>
<li>at some point months/years later I reinstall fish in a different location for some reason and remove the old one</li>
<li>oh no!!! I have no valid shell! I can&rsquo;t open a new terminal tab anymore!</li>
</ol>
<p>This has never been a major issue because I always have a terminal open
somewhere where I can fix the problem and rescue myself, but it&rsquo;s a bit
alarming.</p>
<p>If you don&rsquo;t want to use <code>chsh</code> to change your shell to fish (which is very reasonable,
maybe I shouldn&rsquo;t be doing that), the <a href="https://wiki.archlinux.org/title/Fish">Arch wiki page</a> has a couple of good suggestions &ndash;
either configure your terminal emulator to run fish or add an <code>exec fish</code> to
your <code>.bashrc</code>.</p>
<h3 id="i-ve-never-really-learned-the-scripting-language">I&rsquo;ve never really learned the scripting language</h3>
<p>Other than occasionally writing a for loop interactively on the command line,
I&rsquo;ve never really learned the fish scripting language. I still do all of my
shell scripting in bash.</p>
<p>I don&rsquo;t think I&rsquo;ve ever written a fish function or <code>if</code> statement.</p>
<h3 id="it-seems-like-fish-is-getting-pretty-popular">it seems like fish is getting pretty popular</h3>
<p>I ran a highly unscientific poll on Mastodon asking people what shell they <a href="https://social.jvns.ca/@b0rk/112722850642874842">use interactively</a>. The results were (of 2600 responses):</p>
<ul>
<li>46% bash</li>
<li>49% zsh</li>
<li>16% fish</li>
<li>5% other</li>
</ul>
<p>I think 16% for fish is pretty remarkable, since (as far as I know) there isn&rsquo;t
any system where fish is the default shell, and my sense is that it&rsquo;s very
common to just stick to whatever your system&rsquo;s default shell is.</p>
<p>It feels like a big achievement for the fish project, even if maybe my Mastodon
followers are more likely than the average shell user to use fish for some
reason.</p>
<h3 id="who-might-fish-be-right-for">who might fish be right for?</h3>
<p>Fish definitely isn&rsquo;t for everyone. I think I like it because:</p>
<ol>
<li>I really dislike configuring my shell (and honestly my dev environment in general), I want things to &ldquo;just work&rdquo; with the default settings</li>
<li>fish&rsquo;s defaults feel good to me</li>
<li>I don&rsquo;t spend that much time logged into random servers using other shells
so there&rsquo;s not too much context switching</li>
<li>I liked its features so much that I was willing to relearn how to do a few
&ldquo;basic&rdquo; shell things, like using parentheses <code>(seq 1 10)</code> to run a command
instead of backticks or using <code>set</code> instead of <code>export</code></li>
</ol>
<p>Maybe you&rsquo;re also a person who would like fish! I hope a few more of the people
who fish is for can find it, because I spend so much of my time in the terminal
and it&rsquo;s made that time much more pleasant.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Migrating Mess With DNS to use PowerDNS]]></title>
    <link href="https://jvns.ca/blog/2024/08/19/migrating-mess-with-dns-to-use-powerdns/"/>
    <updated>2024-08-19T08:15:28+00:00</updated>
    <id>https://jvns.ca/blog/2024/08/19/migrating-mess-with-dns-to-use-powerdns/</id>
    <content type="html"><![CDATA[<p>About 3 years ago, I announced <a href="https://messwithdns.net/">Mess With DNS</a> in
<a href="https://jvns.ca/blog/2021/12/15/mess-with-dns/">this blog post</a>, a playground
where you can learn how DNS works by messing around and creating records.</p>
<p>I wasn&rsquo;t very careful with the DNS implementation though (to quote the release blog
post: &ldquo;following the DNS RFCs? not exactly&rdquo;), and people started reporting
problems that eventually I decided that I wanted to fix.</p>
<h3 id="the-problems">the problems</h3>
<p>Some of the problems people have reported were:</p>
<ul>
<li>domain names with underscores weren&rsquo;t allowed, even though they should be</li>
<li>If there was a CNAME record for a domain name, it allowed you to create other records for that domain name, even if it shouldn&rsquo;t</li>
<li>you could create 2 different CNAME records for the same domain name, which shouldn&rsquo;t be allowed</li>
<li>no support for the SVCB or HTTPS record types, which seemed a little complex to implement</li>
<li>no support for upgrading from UDP to TCP for big responses</li>
</ul>
<p>And there are certainly more issues that nobody got around to reporting, for
example that if you added an NS record for a subdomain to delegate it, Mess
With DNS wouldn&rsquo;t handle the delegation properly.</p>
<h3 id="the-solution-powerdns">the solution: PowerDNS</h3>
<p>I wasn&rsquo;t sure how to fix these problems for a long time &ndash; technically I
<em>could</em> have started addressing them individually, but it felt like there were
a million edge cases and I&rsquo;d never get there.</p>
<p>But then one day I was chatting with someone else who was working on a DNS
server and they said they were using <a href="https://github.com/PowerDNS/pdns/">PowerDNS</a>: an open
source DNS server with an HTTP API!</p>
<p>This seemed like an obvious solution to my problems &ndash; I could just swap out my
own crappy DNS implementation for PowerDNS.</p>
<p>There were a couple of challenges I ran into when setting up PowerDNS that I&rsquo;ll
talk about here. I really don&rsquo;t do a lot of web development and I think I&rsquo;ve never
built a website that depends on a relatively complex API before, so it was a
bit of a learning experience.</p>
<h3 id="challenge-1-getting-every-query-made-to-the-dns-server">challenge 1: getting every query made to the DNS server</h3>
<p>One of the main things Mess With DNS does is give you a live view of every DNS
query it receives for your subdomain, using a websocket. To make this work, it
needs to intercept every DNS query before they it gets sent to the PowerDNS DNS
server:</p>
<p>There were 2 options I could think of for how to intercept the DNS queries:</p>
<ol>
<li>dnstap: <code>dnsdist</code> (a DNS load balancer from the PowerDNS project) has
support for logging all DNS queries it receives using
<a href="https://dnstap.info/">dnstap</a>, so I could put dnsdist in front of PowerDNS
and then log queries that way</li>
<li>Have my Go server listen on port 53 and proxy the queries myself</li>
</ol>
<p>I originally implemented option #1, but for some reason there was a 1 second
delay before every query got logged. I couldn&rsquo;t figure out why, so I
implemented my own <a href="https://github.com/jvns/mess-with-dns/blob/3423c9496dd772f7157a56f9e068fd926e89c331/api/main.go#L265-L310">very simple proxy</a> instead.</p>
<h3 id="challenge-2-should-the-frontend-have-direct-access-to-the-powerdns-api">challenge 2: should the frontend have direct access to the PowerDNS API?</h3>
<p>The frontend used to have a lot of DNS logic in it &ndash; it converted emoji domain
names to ASCII using punycode, had a lookup table to convert numeric DNS query
types (like <code>1</code>) to their human-readable names (like <code>A</code>), did a little bit of
validation, and more.</p>
<p>Originally I considered keeping this pattern and just giving the frontend (more
or less) direct access to the PowerDNS API to create and delete, but writing
even more complex code in Javascript didn&rsquo;t feel that appealing to me &ndash; I
don&rsquo;t really know how to write tests in Javascript and it seemed like it
wouldn&rsquo;t end well.</p>
<p>So I decided to take all of the DNS logic out of the frontend and write a new
DNS API for managing records, shaped something like this:</p>
<ul>
<li><code>GET /records</code></li>
<li><code>DELETE /records/&lt;ID&gt;</code></li>
<li><code>DELETE /records/</code> (delete all records for a user)</li>
<li><code>POST /records/</code> (create record)</li>
<li><code>POST /records/&lt;ID&gt;</code> (update record)</li>
</ul>
<p>This meant that I could actually write tests for my code, since the backend is
in Go and I do know how to write tests in Go.</p>
<h3 id="what-i-learned-it-s-okay-for-an-api-to-duplicate-information">what I learned: it&rsquo;s okay for an API to duplicate information</h3>
<p>I had this idea that APIs shouldn&rsquo;t return duplicate information &ndash; for example
if I get a DNS record, it should only include a given piece of information
once.</p>
<p>But I ran into a problem with that idea when displaying MX records: an MX
record has 2 fields, &ldquo;preference&rdquo;, and &ldquo;mail server&rdquo;. And I needed to display
that information in 2 different ways on the frontend:</p>
<ol>
<li>In a form, where &ldquo;Preference&rdquo; and &ldquo;Mail Server&rdquo; are 2 different form fields (like <code>10</code> and <code>mail.example.com</code>)</li>
<li>In a summary view, where I wanted to just show the record (<code>10 mail.example.com</code>)</li>
</ol>
<p>This is kind of a small problem, but it came up in a few different places.</p>
<p>I talked to my friend Marco Rogers about this, and based on some advice from
him I realized that I could return the same information in the API in 2
different ways! Then the frontend just has to display it. So I started just
returning duplicate information in the API, something like this:</p>
<pre><code>{
  values: {'Preference': 10, 'Server': 'mail.example.com'},
  content: '10 mail.example.com',
  ...
}
</code></pre>
<p>I ended up using this pattern in a couple of other places where I needed to
display the same information in 2 different ways and it was SO much easier.</p>
<p>I think what I learned from this is that if I&rsquo;m making an API that isn&rsquo;t
intended for external use (there are no users of this API other than the
frontend!), I can tailor it very specifically to the frontend&rsquo;s needs and
that&rsquo;s okay.</p>
<h3 id="challenge-3-what-s-a-record-s-id">challenge 3: what&rsquo;s a record&rsquo;s ID?</h3>
<p>In Mess With DNS (and I think in most DNS user interfaces!), you create, add, and delete <strong>records</strong>.</p>
<p>But that&rsquo;s not how the PowerDNS API works. In PowerDNS, you create a <strong>zone</strong>,
which is made of <strong>record sets</strong>. Records don&rsquo;t have any ID in the API at all.</p>
<p>I ended up solving this by generate a fake ID for each records which is made of:</p>
<ul>
<li>its <strong>name</strong></li>
<li>its <strong>type</strong></li>
<li>and its <strong>content</strong> (base64-encoded)</li>
</ul>
<p>For example one record&rsquo;s ID is <code>brooch225.messwithdns.com.|NS|bnMxLm1lc3N3aXRoZG5zLmNvbS4=</code></p>
<p>Then I can search through the zone and find the appropriate record to update
it.</p>
<p>This means that if you update a record then its ID will change which isn&rsquo;t
usually what I want in an ID, but that seems fine.</p>
<h3 id="challenge-4-making-clear-error-messages">challenge 4: making clear error messages</h3>
<p>I think the error messages that the PowerDNS API returns aren&rsquo;t really intended to be shown to end users, for example:</p>
<ul>
<li><code>Name 'new\032site.island358.messwithdns.com.' contains unsupported characters</code> (this error encodes the space as <code>\032</code>, which is a bit disorienting if you don&rsquo;t know that the space character is 32 in ASCII)</li>
<li><code>RRset test.pear5.messwithdns.com. IN CNAME: Conflicts with pre-existing RRset</code> (this talks about RRsets, which aren&rsquo;t a concept that the Mess With DNS UI has at all)</li>
<li><code>Record orange.beryl5.messwithdns.com./A '1.2.3.4$': Parsing record content (try 'pdnsutil check-zone'): unable to parse IP address, strange character: $</code> (mentions &ldquo;pdnsutil&rdquo;, a utility which Mess With DNS&rsquo;s users don&rsquo;t have
access to in this context)</li>
</ul>
<p>I ended up handling this in two ways:</p>
<ol>
<li>Do some initial basic validation of values that users enter (like IP addresses), so I can just return errors like <code>Invalid IPv4 address: &quot;1.2.3.4$</code></li>
<li>If that goes well, send the request to PowerDNS and if we get an error back, then do some <a href="https://github.com/jvns/mess-with-dns/blob/c02579190e103218b2c8dfc6dceb19f863752f15/api/records/pdns_errors.go">hacky translation</a> of those messages to make them clearer.</li>
</ol>
<p>Sometimes users will still get errors from PowerDNS directly, but I added some
logging of all the errors that users see, so hopefully I can review them and
add extra translations if there are other common errors that come up.</p>
<p>I think what I learned from this is that if I&rsquo;m building a user-facing
application on top of an API, I need to be pretty thoughtful about how I
resurface those errors to users.</p>
<h3 id="challenge-5-setting-up-sqlite">challenge 5: setting up SQLite</h3>
<p>Previously Mess With DNS was using a Postgres database. This was problematic
because I only gave the Postgres machine 256MB of RAM, which meant that the
database got OOM killed almost every single day. I never really worked out
exactly why it got OOM killed every day, but that&rsquo;s how it was. I spent some
time trying to tune Postgres&rsquo; memory usage by setting the max connections /
<code>work-mem</code> / <code>maintenance-work-mem</code> and it helped a bit but didn&rsquo;t solve the
problem.</p>
<p>So for this refactor I decided to use SQLite instead, because the website
doesn&rsquo;t really get that much traffic. There are some choices involved with
using SQLite, and I decided to:</p>
<ol>
<li>Run <code>db.SetMaxOpenConns(1)</code> to make sure that we only open 1 connection to
the database at a time, to prevent <code>SQLITE_BUSY</code> errors from two threads
trying to access the database at the same time (just setting WAL mode didn&rsquo;t
work)</li>
<li>Use separate databases for each of the 3 tables (users, records, and
requests) to reduce contention. This maybe isn&rsquo;t really necessary, but there
was no reason I needed the tables to be in the same database so I figured I&rsquo;d set
up separate databases to be safe.</li>
<li>Use the cgo-free <a href="https://pkg.go.dev/modernc.org/sqlite?utm_source=godoc">modernc.org/sqlite</a>, which <a href="https://datastation.multiprocess.io/blog/2022-05-12-sqlite-in-go-with-and-without-cgo.html">translates SQLite&rsquo;s source code to Go</a>.
I might switch to a more &ldquo;normal&rdquo; sqlite implementation instead at some point and use cgo though.
I think the main reason I prefer to avoid cgo is that cgo has landed me with <a href="https://jvns.ca/blog/2021/11/17/debugging-a-weird--file-not-found--error/">difficult-to-debug errors in the past</a>.</li>
<li>use WAL mode</li>
</ol>
<p>I still haven&rsquo;t set up backups, though I don&rsquo;t think my Postgres database had
backups either. I think I&rsquo;m unlikely to use
<a href="https://litestream.io/">litestream</a> for backups &ndash; Mess With DNS is very far
from a critical application, and I think daily backups that I could recover
from in case of a disaster are more than good enough.</p>
<h3 id="challenge-6-upgrading-vue-managing-forms">challenge 6: upgrading Vue &amp; managing forms</h3>
<p>This has nothing to do with PowerDNS but I decided to upgrade Vue.js from
version 2 to 3 as part of this refresh. The main problem with that is that the
form validation library I was using (FormKit) completely changed its API
between Vue 2 and Vue 3, so I decided to just stop using it instead of learning
the new API.</p>
<p>I ended up switching to some form validation tools that are built into the
browser like <code>required</code> and <code>oninvalid</code> (<a href="https://github.com/jvns/mess-with-dns/blob/90f7a2d2982c8151a3ddcab532bc1db07a043f84/frontend/components/NewRecord.html#L5-L8">here&rsquo;s the code</a>).
I think it could use some of improvement, I still don&rsquo;t understand forms very well.</p>
<h3 id="challenge-7-managing-state-in-the-frontend">challenge 7: managing state in the frontend</h3>
<p>This also has nothing to do with PowerDNS, but when modifying the frontend I
realized that my state management in the frontend was a mess &ndash; in every place
where I made an API request to the backend, I had to try to remember to add a
&ldquo;refresh records&rdquo; call after that in every place that I&rsquo;d modified the state
and I wasn&rsquo;t always consistent about it.</p>
<p>With some more advice from Marco, I ended up implementing a single global
<a href="https://github.com/jvns/mess-with-dns/blob/90f7a2d2982c8151a3ddcab532bc1db07a043f84/frontend/store.ts#L32-L44">state management store</a>
which stores all the state for the application, and which lets me
create/update/delete records.</p>
<p>Then my components can just call <code>store.createRecord(record)</code>, and the store
will automatically resynchronize all of the state as needed.</p>
<h3 id="challenge-8-sequencing-the-project">challenge 8: sequencing the project</h3>
<p>This project ended up having several steps because I reworked the whole
integration between the frontend and the backend. I ended up splitting it into
a few different phases:</p>
<ol>
<li>Upgrade Vue from v2 to v3</li>
<li>Make the state management store</li>
<li>Implement a different backend API, move a lot of DNS logic out of the frontend, and add tests for the backend</li>
<li>Integrate PowerDNS</li>
</ol>
<p>I made sure that the website was (more or less) 100% working and then deployed
it in between phases, so that the amount of changes I was managing at a time
stayed somewhat under control.</p>
<h3 id="the-new-website-is-up-now">the new website is up now!</h3>
<p>I released the upgraded website a few days ago and it seems to work!
The PowerDNS API has been great to work on top of, and I&rsquo;m relieved that
there&rsquo;s a whole class of problems that I now don&rsquo;t have to think about at all,
other than potentially trying to make the error messages from PowerDNS a little
clearer. Using PowerDNS has fixed a lot of the DNS issues that folks have
reported in the last few years and it feels great.</p>
<p>If you run into problems with the new Mess With DNS I&rsquo;d love to <a href="https://github.com/jvns/mess-with-dns/issues/">hear about them here</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Go structs are copied on assignment (and other things about Go I'd missed)]]></title>
    <link href="https://jvns.ca/blog/2024/08/06/go-structs-copied-on-assignment/"/>
    <updated>2024-08-06T08:38:35+00:00</updated>
    <id>https://jvns.ca/blog/2024/08/06/go-structs-copied-on-assignment/</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve been writing Go pretty casually for years &ndash; the backends for all of my
playgrounds (<a href="https://nginx-playground.wizardzines.com/">nginx</a>, <a href="https://messwithdns.net/">dns</a>, <a href="https://memory-spy.wizardzines.com/">memory</a>, <a href="https://dns-lookup.jvns.ca/">more DNS</a>) are written in Go, but many of those projects are just a few hundred lines and I don&rsquo;t come back to those codebases much.</p>
<p>I thought I more or less understood the basics of the language, but this week
I&rsquo;ve been writing a lot more Go than usual while working on some upgrades to
<a href="https://messwithdns.net">Mess with DNS</a>, and ran into a bug that revealed I
was missing a very basic concept!</p>
<p>Then I posted about this on Mastodon and someone linked me to this very cool
site (and book) called <a href="https://100go.co">100 Go Mistakes and How To Avoid Them</a> by <a href="https://teivah.dev/">Teiva Harsanyi</a>. It just came out in 2022 so it&rsquo;s relatively new.</p>
<p>I decided to read through the site to see what <em>else</em> I was missing, and found
a couple of other misconceptions I had about Go. I&rsquo;ll talk about some of the
mistakes that jumped out to me the most, but really the whole
<a href="https://100go.co/">100 Go Mistakes</a> site is great and I&rsquo;d recommend reading it.</p>
<p>Here&rsquo;s the initial mistake that started me on this journey:</p>
<h3 id="mistake-1-not-understanding-that-structs-are-copied-on-assignment">mistake 1: not understanding that structs are copied on assignment</h3>
<p>Let&rsquo;s say we have a struct:</p>
<pre><code>type Thing struct {
    Name string
}
</code></pre>
<p>and this code:</p>
<pre><code>thing := Thing{&quot;record&quot;}
other_thing := thing
other_thing.Name = &quot;banana&quot;
fmt.Println(thing)
</code></pre>
<p>This prints &ldquo;record&rdquo; and not &ldquo;banana&rdquo; (<a href="https://go.dev/play/p/kUeP2ocFtXw">play.go.dev link</a>), because <code>thing</code> is copied when you
assign it to <code>other_thing</code>.</p>
<h3 id="the-problem-this-caused-me-ranges">the problem this caused me: ranges</h3>
<p>The bug I spent 2 hours of my life debugging last week was effectively this code (<a href="https://go.dev/play/p/85FnGG86UBP">play.go.dev link</a>):</p>
<pre><code>type Thing struct {
  Name string
}
func findThing(things []Thing, name string) *Thing {
  for _, thing := range things {
    if thing.Name == name {
      return &amp;thing
    }
  }
  return nil
}

func main() {
  things := []Thing{Thing{&quot;record&quot;}, Thing{&quot;banana&quot;}}
  thing := findThing(things, &quot;record&quot;)
  thing.Name = &quot;gramaphone&quot;
  fmt.Println(things)
}
</code></pre>
<p>This prints out <code>[{record} {banana}]</code> &ndash; because <code>findThing</code> returned a copy, we didn&rsquo;t change the name in the original array.</p>
<p>This mistake is <a href="https://100go.co/#ignoring-that-elements-are-copied-in-range-loops-30">#30 in 100 Go Mistakes</a>.</p>
<p>I fixed the bug by changing it to something like this (<a href="https://go.dev/play/p/CKZCRUwv_nG">play.go.dev link</a>), which returns a
reference to the item in the array we&rsquo;re looking for instead of a copy.</p>
<pre><code>func findThing(things []Thing, name string) *Thing {
  for i := range things {
    if things[i].Name == name {
      return &amp;things[i]
    }
  }
  return nil
}
</code></pre>
<h3 id="why-didn-t-i-realize-this">why didn&rsquo;t I realize this?</h3>
<p>When I learned that I was mistaken about how assignment worked in Go I was
really taken aback, like &ndash; it&rsquo;s such a basic fact about the language works!
If I was wrong about that then what ELSE am I wrong about in Go????</p>
<p>My best guess for what happened is:</p>
<ol>
<li>I&rsquo;ve heard for my whole life that when you define a function,
you need to think about whether its arguments are passed by <strong>reference</strong> or
by <strong>value</strong></li>
<li>So I&rsquo;d thought about this in Go, and I knew that if you pass a struct as a
value to a function, it gets copied &ndash; if you want to pass a reference then
you have to pass a pointer</li>
<li>But somehow it never occurred to me that you need to think about the same
thing for <strong>assignments</strong>, perhaps because in most of the other languages I
use (Python, JS, Java) I think everything is a reference anyway. Except for
in Rust, where you do have values that you make copies of but I think most of the time I had to run <code>.clone()</code> explicitly.
(though apparently structs will be automatically copied on assignment if the struct implements the <code>Copy</code> trait)</li>
<li>Also obviously I just don&rsquo;t write that much Go so I guess it&rsquo;s never come
up.</li>
</ol>
<h3 id="mistake-2-side-effects-appending-slices-25-https-100go-co-unexpected-side-effects-using-slice-append-25">mistake 2: side effects appending slices (<a href="https://100go.co/#unexpected-side-effects-using-slice-append-25">#25</a>)</h3>
<p>When you subset a slice with <code>x[2:3]</code>, the original slice and the sub-slice
share the same backing array, so if you append to the new slice, it can
unintentionally change the old slice:</p>
<p>For example, this code prints <code>[1 2 3 555 5]</code> (<a href="https://go.dev/play/p/qssfM_NSXJD">code on play.go.dev</a>)</p>
<pre><code>x := []int{1, 2, 3, 4, 5}
y := x[2:3]
y = append(y, 555)
fmt.Println(x)
</code></pre>
<p>I don&rsquo;t think this has ever actually happened to me, but it&rsquo;s alarming and I&rsquo;m
very happy to know about it.</p>
<p>Apparently you can avoid this problem by changing <code>y := x[2:3]</code> to <code>y := x[2:3:3]</code>, which restricts the new slice&rsquo;s capacity so that appending to it
will re-allocate a new slice. Here&rsquo;s some <a href="https://go.dev/play/p/aE78JUL4-Iv">code on play.go.dev</a> that does that.</p>
<h3 id="mistake-3-not-understanding-the-different-types-of-method-receivers-42">mistake 3: not understanding the different types of method receivers (#42)</h3>
<p>This one isn&rsquo;t a &ldquo;mistake&rdquo; exactly, but it&rsquo;s been a source of confusion for me
and it&rsquo;s pretty simple so I&rsquo;m glad to have it cleared up.</p>
<p>In Go you can declare methods in 2 different ways:</p>
<ol>
<li><code>func (t Thing) Function()</code> (a &ldquo;value receiver&rdquo;)</li>
<li><code>func (t *Thing) Function()</code> (a &ldquo;pointer receiver&rdquo;)</li>
</ol>
<p>My understanding now is that basically:</p>
<ul>
<li>If you want the method to mutate the struct <code>t</code>, you need a pointer receiver.</li>
<li>If you want to make sure the method <strong>doesn&rsquo;t</strong> mutate the struct <code>t</code>, use a value receiver.</li>
</ul>
<p><a href="https://100go.co/#not-knowing-which-type-of-receiver-to-use-42">Explanation #42</a> has a
bunch of other interesting details though. There&rsquo;s definitely still something
I&rsquo;m missing about value vs pointer receivers (I got a compile error related to
them a couple of times in the last week that I still don&rsquo;t understand), but
hopefully I&rsquo;ll run into that error again soon and I can figure it out.</p>
<h3 id="more-interesting-things-i-noticed">more interesting things I noticed</h3>
<p>Some more notes from 100 Go Mistakes:</p>
<ul>
<li>apparently you can <a href="https://100go.co/#never-using-named-result-parameters-43">name the outputs of your function (#43)</a>, though that can have <a href="https://100go.co/#unintended-side-effects-with-named-result-parameters-44">issues (#44)</a> and I&rsquo;m not sure I want to</li>
<li><a href="https://100go.co/#not-exploring-all-the-go-testing-features-90">apparently you can put tests in a different package (#90)</a> to
ensure that you only use the package&rsquo;s public interfaces, which seems really
useful</li>
<li>there are a lots of notes about how to use contexts, channels, goroutines,
mutexes, sync.WaitGroup, etc. I&rsquo;m sure I have something to learn about all of
those but today is not the day I&rsquo;m going to learn them.</li>
</ul>
<p>Also there are some things that have tripped me up in the past, like:</p>
<ul>
<li><a href="https://100go.co/#forgetting-the-return-statement-after-replying-to-an-http-request-80">forgetting the return statement after replying to an HTTP request (#80)</a></li>
<li><a href="https://100go.co/#not-using-testing-utility-packages-httptest-and-iotest-88">not realizing the httptest package exists (#88)</a></li>
</ul>
<h3 id="this-100-common-mistakes-format-is-great">this &ldquo;100 common mistakes&rdquo; format is great</h3>
<p>I really appreciated this &ldquo;100 common mistakes&rdquo; format &ndash; it made it really
easy for me to skim through the mistakes and very quickly mentally classify
them into:</p>
<ol>
<li>yep, I know that</li>
<li>not interested in that one right now</li>
<li>WOW WAIT I DID NOT KNOW THAT, THAT IS VERY USEFUL!!!!</li>
</ol>
<p>It looks like &ldquo;100 Common Mistakes&rdquo; is a series of books from Manning and they
also have &ldquo;100 Java Mistakes&rdquo; and an upcoming &ldquo;100 SQL Server Mistakes&rdquo;.</p>
<p>Also I enjoyed what I&rsquo;ve read of <a href="https://effectivepython.com/">Effective Python</a> by Brett Slatkin, which has a similar &ldquo;here are a bunch of
short Python style tips&rdquo; structure where you can quickly skim it and take
what&rsquo;s useful to you. There&rsquo;s also Effective C++, Effective Java, and probably
more.</p>
<h3 id="some-other-go-resources">some other Go resources</h3>
<p>other resources I&rsquo;ve appreciated:</p>
<ul>
<li><a href="https://gobyexample.com/">Go by example</a> for basic syntax</li>
<li><a href="https://go.dev/play/">go.dev/play</a></li>
<li>obviously <a href="https://pkg.go.dev">https://pkg.go.dev</a> for documentation about literally everything</li>
<li><a href="https://staticcheck.dev/">staticcheck</a> seems like a useful linter &ndash; for
example I just started using it to tell me when I&rsquo;ve forgotten to handle an
error</li>
<li>apparently <a href="https://golangci-lint.run/">golangci-lint</a> includes a bunch of different linters</li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Entering text in the terminal is complicated]]></title>
    <link href="https://jvns.ca/blog/2024/07/08/readline/"/>
    <updated>2024-07-08T13:00:15+00:00</updated>
    <id>https://jvns.ca/blog/2024/07/08/readline/</id>
    <content type="html"><![CDATA[<p>The other day I asked what folks on Mastodon find confusing about working in
the terminal, and one thing that stood out to me was &ldquo;editing a command you
already typed in&rdquo;.</p>
<p>This really resonated with me: even though entering some text and editing it is
a very &ldquo;basic&rdquo; task, it took me maybe 15 years of using the terminal every
single day to get used to using <code>Ctrl+A</code> to go to the beginning of the line (or
<code>Ctrl+E</code> for the end &ndash; I think I used <code>Home</code>/<code>End</code> instead).</p>
<p>So let&rsquo;s talk about why entering text might be hard! I&rsquo;ll also share a few tips
that I wish I&rsquo;d learned earlier.</p>
<h3 id="it-s-very-inconsistent-between-programs">it&rsquo;s very inconsistent between programs</h3>
<p>A big part of what makes entering text in the terminal hard is the
inconsistency between how different programs handle entering text. For example:</p>
<ol>
<li>some programs (<code>cat</code>, <code>nc</code>, <code>git commit --interactive</code>, etc) don&rsquo;t support using arrow keys at all: if you press arrow keys, you&rsquo;ll just see <code>^[[D^[[D^[[C^[[C^</code></li>
<li>many programs (like <code>irb</code>, <code>python3</code> on a Linux machine and many many more) use the <code>readline</code> library, which gives you a lot of basic functionality (history, arrow keys, etc)</li>
<li>some programs (like <code>/usr/bin/python3</code> on my Mac) do support very basic features like arrow keys, but not other features like <code>Ctrl+left</code> or reverse searching with <code>Ctrl+R</code></li>
<li>some programs (like the <code>fish</code> shell or <code>ipython3</code> or <code>micro</code> or <code>vim</code>) have their own fancy system for accepting input which is totally custom</li>
</ol>
<p>So there&rsquo;s a lot of variation! Let&rsquo;s talk about each of those a little more.</p>
<h3 id="mode-1-the-baseline">mode 1: the baseline</h3>
<p>First, there&rsquo;s &ldquo;the baseline&rdquo; &ndash; what happens if a program just accepts text by
calling <code>fgets()</code> or whatever and doing absolutely nothing else to provide a
nicer experience. Here&rsquo;s what using these tools typically looks for me &ndash; If I
start the version of <a href="https://wiki.archlinux.org/title/Dash">dash</a> installed on
my machine (a pretty minimal shell) press the left arrow keys, it just prints
<code>^[[D</code> to the terminal.</p>
<pre><code>$ ls l-^[[D^[[D^[[D
</code></pre>
<p>At first it doesn&rsquo;t seem like all of these &ldquo;baseline&rdquo; tools have much in
common, but there are actually a few features that you get for free just from
your terminal, without the program needing to do anything special at all.</p>
<p>The things you get for free are:</p>
<ol>
<li>typing in text, obviously</li>
<li>backspace</li>
<li><code>Ctrl+W</code>, to delete the previous word</li>
<li><code>Ctrl+U</code>, to delete the whole line</li>
<li>a few other things unrelated to text editing (like <code>Ctrl+C</code> to interrupt the process, <code>Ctrl+Z</code> to suspend, etc)</li>
</ol>
<p>This is not <em>great</em>, but it means that if you want to delete a word you
generally can do it with <code>Ctrl+W</code> instead of pressing backspace 15 times, even
if you&rsquo;re in an environment which is offering you absolutely zero features.</p>
<p>You can get a list of all the ctrl codes that your terminal supports with <code>stty -a</code>.</p>
<h3 id="mode-2-tools-that-use-readline">mode 2: tools that use <code>readline</code></h3>
<p>The next group is tools that use readline! Readline is a GNU library to make
entering text more pleasant, and it&rsquo;s very widely used.</p>
<p>My favourite readline keyboard shortcuts are:</p>
<ol>
<li><code>Ctrl+E</code> (or <code>End</code>) to go to the end of the line</li>
<li><code>Ctrl+A</code> (or <code>Home</code>) to go to the beginning of the line</li>
<li><code>Ctrl+left/right arrow</code> to go back/forward 1 word</li>
<li>up arrow to go back to the previous command</li>
<li><code>Ctrl+R</code> to search your history</li>
</ol>
<p>And you can use <code>Ctrl+W</code> / <code>Ctrl+U</code> from the &ldquo;baseline&rdquo; list, though <code>Ctrl+U</code>
deletes from the cursor to the beginning of the line instead of deleting the
whole line. I think <code>Ctrl+W</code> might also have a slightly different definition of
what a &ldquo;word&rdquo; is.</p>
<p>There are a lot more (<a href="https://www.man7.org/linux/man-pages/man3/readline.3.html#EDITING_COMMANDS">here&rsquo;s a full list</a>), but those are the only ones that I personally use.</p>
<p>The <code>bash</code> shell is probably the most famous readline user (when you use
<code>Ctrl+R</code> to search your history in bash, that feature actually comes from
readline), but there are TONS of programs that use it &ndash; for example <code>psql</code>,
<code>irb</code>, <code>python3</code>, etc.</p>
<h3 id="tip-you-can-make-anything-use-readline-with-rlwrap">tip: you can make ANYTHING use readline with <code>rlwrap</code></h3>
<p>One of my absolute favourite things is that if you have a program like <code>nc</code>
without readline support, you can just run <code>rlwrap nc</code> to turn it into a
program with readline support!</p>
<p>This is incredible and makes a lot of tools that are borderline unusable MUCH
more pleasant to use. You can even apparently set up <a href="https://github.com/hanslub42/rlwrap">rlwrap</a> to include your own
custom autocompletions, though I&rsquo;ve never tried that.</p>
<h3 id="some-reasons-tools-might-not-use-readline">some reasons tools might not use readline</h3>
<p>I think reasons tools might not use readline might include:</p>
<ul>
<li>the program is very simple (like <code>cat</code> or <code>nc</code>) and maybe the maintainers don&rsquo;t want to bring in a relatively large dependency</li>
<li>license reasons, if the program&rsquo;s license is not GPL-compatible &ndash; readline is GPL-licensed, not LGPL</li>
<li>only a very small part of the program is interactive, and maybe readline
support isn&rsquo;t seen as important. For example <code>git</code> has a few interactive
features (like <code>git add -p</code>), but not very many, and usually you&rsquo;re just
typing a single character like <code>y</code> or <code>n</code> &ndash; most of the time you need to really
type something significant in git, it&rsquo;ll drop you into a text editor instead.</li>
</ul>
<p>For example idris2 says <a href="https://idris2.readthedocs.io/en/latest/tutorial/interactive.html#editing-at-the-repl">they don&rsquo;t use readline</a>
to keep dependencies minimal and suggest using <code>rlwrap</code> to get better
interactive features.</p>
<h3 id="how-to-know-if-you-re-using-readline">how to know if you&rsquo;re using readline</h3>
<p>The simplest test I can think of is to press <code>Ctrl+R</code>, and if you see:</p>
<pre><code>(reverse-i-search)`':
</code></pre>
<p>then you&rsquo;re probably using readline. This obviously isn&rsquo;t a guarantee (some
other library could use the term <code>reverse-i-search</code> too!), but I don&rsquo;t know of
another system that uses that specific term to refer to searching history.</p>
<h3 id="the-readline-keybindings-come-from-emacs">the readline keybindings come from Emacs</h3>
<p>Because I&rsquo;m a vim user, It took me a very long time to understand where these
keybindings come from (why <code>Ctrl+A</code> to go to the beginning of a line??? so
weird!)</p>
<p>My understanding is these keybindings actually come from Emacs &ndash; <code>Ctrl+A</code> and
<code>Ctrl+E</code> do the same thing in Emacs as they do in Readline and I assume the
other keyboard shortcuts mostly do as well, though I tried out <code>Ctrl+W</code> and
<code>Ctrl+U</code> in Emacs and they don&rsquo;t do the same thing as they do in the terminal
so I guess there are some differences.</p>
<p>There&rsquo;s some more <a href="https://twobithistory.org/2019/08/22/readline.html">history of the Readline project here</a>.</p>
<h3 id="mode-3-another-input-library-like-libedit">mode 3: another input library (like <code>libedit</code>)</h3>
<p>On my Mac laptop, <code>/usr/bin/python3</code> is in a weird middle ground where it
supports <em>some</em> readline features (for example the arrow keys), but not the
other ones. For example when I press <code>Ctrl+left arrow</code>, it prints out <code>;5D</code>,
like this:</p>
<pre><code>$ python3
&gt;&gt;&gt; importt subprocess;5D
</code></pre>
<p>Folks on Mastodon helped me figure out that this is because in the default
Python install on Mac OS, the Python <code>readline</code> module is actually backed by
<code>libedit</code>, which is a similar library which has fewer features, presumably
because Readline is <a href="https://en.wikipedia.org/wiki/GNU_Readline#Choice_of_the_GPL_as_GNU_Readline's_license">GPL licensed</a>.</p>
<p>Here&rsquo;s how I was eventually able to figure out that Python was using libedit on
my system:</p>
<pre><code>$ python3 -c &quot;import readline; print(readline.__doc__)&quot;
Importing this module enables command line editing using libedit readline.
</code></pre>
<p>Generally Python uses readline though if you install it on Linux or through
Homebrew. It&rsquo;s just that the specific version that Apple includes on their
systems doesn&rsquo;t have readline. Also <a href="https://docs.python.org/3.13/whatsnew/3.13.html#a-better-interactive-interpreter">Python 3.13 is going to remove the readline dependency</a>
in favour of a custom library, so &ldquo;Python uses readline&rdquo; won&rsquo;t be true in the
future.</p>
<p>I assume that there are more programs on my Mac that use libedit but I haven&rsquo;t
looked into it.</p>
<h3 id="mode-4-something-custom">mode 4: something custom</h3>
<p>The last group of programs is programs that have their own custom (and sometimes
much fancier!) system for editing text. This includes:</p>
<ul>
<li>most terminal text editors (nano, micro, vim, emacs, etc)</li>
<li>some shells (like fish), for example it seems like fish supports <code>Ctrl+Z</code> for undo when typing in a command. Zsh&rsquo;s line editor is called <a href="https://zsh.sourceforge.io/Guide/zshguide04.html">zle</a>.</li>
<li>some REPLs (like <code>ipython</code>), for example IPython uses the <a href="https://python-prompt-toolkit.readthedocs.io/">prompt_toolkit</a> library instead of readline</li>
<li>lots of other programs (like <code>atuin</code>)</li>
</ul>
<p>Some features you might see are:</p>
<ul>
<li>better autocomplete which is more customized to the tool</li>
<li>nicer history management (for example with syntax highlighting) than the default you get from readline</li>
<li>more keyboard shortcuts</li>
</ul>
<h3 id="custom-input-systems-are-often-readline-inspired">custom input systems are often readline-inspired</h3>
<p>I went looking at how <a href="https://atuin.sh/">Atuin</a> (a wonderful tool for
searching your shell history that I started using recently) handles text input.
Looking at <a href="https://github.com/atuinsh/atuin/blob/a67cfc82fe0dc907a01f07a0fd625701e062a33b/crates/atuin/src/command/client/search/interactive.rs#L382-L430">the code</a>
and some of the discussion around it, their implementation is custom but it&rsquo;s
inspired by readline, which makes sense to me &ndash; a lot of users are used to
those keybindings, and it&rsquo;s convenient for them to work even though atuin
doesn&rsquo;t use readline.</p>
<p><a href="https://python-prompt-toolkit.readthedocs.io/">prompt_toolkit</a> (the library
IPython uses) is similar &ndash; it actually supports a lot of options (including
vi-like keybindings), but the default is to support the readline-style
keybindings.</p>
<p>This is like how you see a lot of programs which support very basic vim
keybindings (like <code>j</code> for down and <code>k</code> for up). For example Fastmail supports
<code>j</code> and <code>k</code> even though most of its other keybindings don&rsquo;t have much
relationship to vim.</p>
<p>I assume that most &ldquo;readline-inspired&rdquo; custom input systems have various subtle
incompatibilities with readline, but this doesn&rsquo;t really bother me at all
personally because I&rsquo;m extremely ignorant of most of readline&rsquo;s features. I only use
maybe 5 keyboard shortcuts, so as long as they support the 5 basic commands I
know (which they always do!) I feel pretty comfortable. And usually these
custom systems have much better autocomplete than you&rsquo;d get from just using
readline, so generally I prefer them over readline.</p>
<h3 id="lots-of-shells-support-vi-keybindings">lots of shells support vi keybindings</h3>
<p>Bash, zsh, and fish all have a &ldquo;vi mode&rdquo; for entering text. In a
<a href="https://social.jvns.ca/@b0rk/112723846172173621">very unscientific poll</a> I ran on
Mastodon, 12% of people said they use it, so it seems pretty popular.</p>
<p>Readline also has a &ldquo;vi mode&rdquo; (which is how Bash&rsquo;s support for it works), so by
extension lots of other programs have it too.</p>
<p>I&rsquo;ve always thought that vi mode seems really cool, but for some reason even
though I&rsquo;m a vim user it&rsquo;s never stuck for me.</p>
<h3 id="understanding-what-situation-you-re-in-really-helps">understanding what situation you&rsquo;re in really helps</h3>
<p>I&rsquo;ve spent a lot of my life being confused about why a command line application
I was using wasn&rsquo;t behaving the way I wanted, and it feels good to be able to
more or less understand what&rsquo;s going on.</p>
<p>I think this is roughly my mental flowchart when I&rsquo;m entering text at a command
line prompt:</p>
<ol>
<li>Do the arrow keys not work? Probably there&rsquo;s no input system at all, but at
least I can use <code>Ctrl+W</code> and <code>Ctrl+U</code>, and I can <code>rlwrap</code> the tool if I
want more features.</li>
<li>Does <code>Ctrl+R</code> print <code>reverse-i-search</code>? Probably it&rsquo;s readline, so I can use
all of the readline shortcuts I&rsquo;m used to, and I know I can get some basic
history and press up arrow to get the previous command.</li>
<li>Does <code>Ctrl+R</code> do something else? This is probably some custom input library:
it&rsquo;ll probably act more or less like readline, and I can check the
documentation if I really want to know how it works.</li>
</ol>
<p>Being able to diagnose what&rsquo;s going on like this makes the command line feel a
more predictable and less chaotic.</p>
<h3 id="some-things-this-post-left-out">some things this post left out</h3>
<p>There are lots more complications related to entering text that we didn&rsquo;t talk
about at all here, like:</p>
<ul>
<li>issues related to ssh / tmux / etc</li>
<li>the <code>TERM</code> environment variable</li>
<li>how different terminals (gnome terminal, iTerm, xterm, etc) have different kinds of support for copying/pasting text</li>
<li>unicode</li>
<li>probably a lot more</li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Reasons to use your shell's job control]]></title>
    <link href="https://jvns.ca/blog/2024/07/03/reasons-to-use-job-control/"/>
    <updated>2024-07-03T08:00:20+00:00</updated>
    <id>https://jvns.ca/blog/2024/07/03/reasons-to-use-job-control/</id>
    <content type="html"><![CDATA[<p>Hello! Today someone on Mastodon asked about job control (<code>fg</code>, <code>bg</code>, <code>Ctrl+z</code>,
<code>wait</code>, etc). It made me think about how I don&rsquo;t use my shell&rsquo;s job
control interactively very often: usually I prefer to just open a new terminal
tab if I want to run multiple terminal programs, or use tmux if it&rsquo;s over ssh.
But I was curious about whether other people used job control more often than me.</p>
<p>So I <a href="https://social.jvns.ca/@b0rk/112716835387523648">asked on Mastodon</a> for
reasons people use job control. There were a lot of great responses, and it
even made me want to consider using job control a little more!</p>
<p>In this post I&rsquo;m only going to talk about using job control interactively (not
in scripts) &ndash; the post is already long enough just talking about interactive
use.</p>
<h3 id="what-s-job-control">what&rsquo;s job control?</h3>
<p>First: what&rsquo;s job control? Well &ndash; in a terminal, your processes can be in one of 3 states:</p>
<ol>
<li>in the <strong>foreground</strong>. This is the normal state when you start a process.</li>
<li>in the <strong>background</strong>. This is what happens when you run <code>some_process &amp;</code>: the process is still running, but you can&rsquo;t interact with it anymore unless you bring it back to the foreground.</li>
<li><strong>stopped</strong>. This is what happens when you start a process and then press <code>Ctrl+Z</code>. This pauses the process: it won&rsquo;t keep using the CPU, but you can restart it if you want.</li>
</ol>
<p>&ldquo;Job control&rdquo; is a set of commands for seeing which processes are running in a terminal and moving processes between these 3 states</p>
<h3 id="how-to-use-job-control">how to use job control</h3>
<ul>
<li><code>fg</code> brings a process to the foreground. It works on both stopped processes and background processes. For example, if you start a background process with <code>cat &lt; /dev/zero &amp;</code>, you can bring it back to the foreground by running <code>fg</code></li>
<li><code>bg</code> restarts a stopped process and puts it in the background.</li>
<li>Pressing <code>Ctrl+z</code> stops the current foreground process.</li>
<li><code>jobs</code> lists all processes that are active in your terminal</li>
<li><code>kill</code> sends a signal (like <code>SIGKILL</code>) to a job (this is the shell builtin <code>kill</code>, not <code>/bin/kill</code>)</li>
<li><code>disown</code> removes the job from the list of running jobs, so that it doesn&rsquo;t get killed when you close the terminal</li>
<li><code>wait</code> waits for all background processes to complete. I only use this in scripts though.</li>
<li>apparently in bash/zsh you can also just type <code>%2</code> instead of <code>fg %2</code></li>
</ul>
<p>I might have forgotten some other job control commands but I think those are all the ones I&rsquo;ve ever used.</p>
<p>You can also give <code>fg</code> or <code>bg</code> a specific job to foreground/background. For example if I see this in the output of <code>jobs</code>:</p>
<pre><code>$ jobs
Job Group State   Command
1   3161  running cat &lt; /dev/zero &amp;
2   3264  stopped nvim -w ~/.vimkeys $argv
</code></pre>
<p>then I can foreground <code>nvim</code> with <code>fg %2</code>. You can also kill it with <code>kill -9 %2</code>, or just <code>kill %2</code> if you want to be more gentle.</p>
<h3 id="how-is-kill-2-implemented">how is <code>kill %2</code> implemented?</h3>
<p>I was curious about how <code>kill %2</code> works &ndash; does <code>%2</code> just get replaced with the
PID of the relevant process when you run the command, the way environment
variables are? Some quick experimentation shows that it isn&rsquo;t:</p>
<pre><code>$ echo kill %2
kill %2
$ type kill
kill is a function with definition
# Defined in /nix/store/vicfrai6lhnl8xw6azq5dzaizx56gw4m-fish-3.7.0/share/fish/config.fish
</code></pre>
<p>So <code>kill</code> is a fish builtin that knows how to interpret <code>%2</code>. Looking at
the source code (which is very easy in fish!), it uses <code>jobs -p %2</code> to expand <code>%2</code>
into a PID, and then runs the regular <code>kill</code> command.</p>
<h3 id="on-differences-between-shells">on differences between shells</h3>
<p>Job control is implemented by your shell. I use fish, but my sense is that the
basics of job control work pretty similarly in bash, fish, and zsh.</p>
<p>There are definitely some shells which don&rsquo;t have job control at all, but I&rsquo;ve
only used bash/fish/zsh so I don&rsquo;t know much about that.</p>
<p>Now let&rsquo;s get into a few reasons people use job control!</p>
<h3 id="reason-1-kill-a-command-that-s-not-responding-to-ctrl-c">reason 1: kill a command that&rsquo;s not responding to Ctrl+C</h3>
<p>I run into processes that don&rsquo;t respond to <code>Ctrl+C</code> pretty regularly, and it&rsquo;s
always a little annoying &ndash; I usually switch terminal tabs to find and kill and
the process. A bunch of people pointed out that you can do this in a faster way
using job control!</p>
<p>How to do this: Press <code>Ctrl+Z</code>, then <code>kill %1</code> (or the appropriate job number
if there&rsquo;s more than one stopped/background job, which you can get from
<code>jobs</code>). You can also <code>kill -9</code> if it&rsquo;s really not responding.</p>
<h3 id="reason-2-background-a-gui-app-so-it-s-not-using-up-a-terminal-tab">reason 2: background a GUI app so it&rsquo;s not using up a terminal tab</h3>
<p>Sometimes I start a GUI program from the command line (for example with
<code>wireshark some_file.pcap</code>), forget to start it in the background, and don&rsquo;t want it eating up my terminal tab.</p>
<p>How to do this:</p>
<ul>
<li>move the GUI program to the background by pressing <code>Ctrl+Z</code> and then running <code>bg</code>.</li>
<li>you can also run <code>disown</code> to remove it from the list of jobs, to make sure that
the GUI program won&rsquo;t get closed when you close your terminal tab.</li>
</ul>
<p>Personally I try to avoid starting GUI programs from the terminal if possible
because I don&rsquo;t like how their stdout pollutes my terminal (on a Mac I use
<code>open -a Wireshark</code> instead because I find it works better but sometimes you
don&rsquo;t have another choice.</p>
<h3 id="reason-2-5-accidentally-started-a-long-running-job-without-tmux">reason 2.5: accidentally started a long-running job without <code>tmux</code></h3>
<p>This is basically the same as the GUI app thing &ndash; you can move the job to the
background and disown it.</p>
<p>I was also curious about if there are ways to redirect a process&rsquo;s output to a
file after it&rsquo;s already started. A quick search turned up <a href="https://github.com/jerome-pouiller/reredirect/">this Linux-only tool</a> which is based on
<a href="https://blog.nelhage.com/">nelhage</a>&rsquo;s <a href="https://github.com/nelhage/reptyr">reptyr</a> (which lets you for example move a
process that you started outside of tmux to tmux) but I haven&rsquo;t tried either of
those.</p>
<h3 id="reason-3-running-a-command-while-using-vim">reason 3: running a command while using <code>vim</code></h3>
<p>A lot of people mentioned that if they want to quickly test something while
editing code in <code>vim</code> or another terminal editor, they like to use <code>Ctrl+Z</code>
to stop vim, run the command, and then run <code>fg</code> to go back to their editor.</p>
<p>You can also use this to check the output of a command that you ran before
starting <code>vim</code>.</p>
<p>I&rsquo;ve never gotten in the habit of this, probably because I mostly use a GUI
version of vim. I feel like I&rsquo;d also be likely to switch terminal tabs and end
up wondering &ldquo;wait&hellip; where did I put my editor???&rdquo; and have to go searching
for it.</p>
<h3 id="reason-4-preferring-interleaved-output">reason 4: preferring interleaved output</h3>
<p>A few people said that they prefer to the output of all of their commands being
interleaved in the terminal. This really surprised me because I usually think
of having the output of lots of different commands interleaved as being a <em>bad</em>
thing, but one person said that they like to do this with tcpdump specifically
and I think that actually sounds extremely useful. Here&rsquo;s what it looks like:</p>
<pre><code># start tcpdump
$ sudo tcpdump -ni any port 1234 &amp;
tcpdump: data link type PKTAP
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type PKTAP (Apple DLT_PKTAP), snapshot length 524288 bytes

# run curl
$ curl google.com:1234
13:13:29.881018 IP 192.168.1.173.49626 &gt; 142.251.41.78.1234: Flags [S], seq 613574185, win 65535, options [mss 1460,nop,wscale 6,nop,nop,TS val 2730440518 ecr 0,sackOK,eol], length 0
13:13:30.881963 IP 192.168.1.173.49626 &gt; 142.251.41.78.1234: Flags [S], seq 613574185, win 65535, options [mss 1460,nop,wscale 6,nop,nop,TS val 2730441519 ecr 0,sackOK,eol], length 0
13:13:31.882587 IP 192.168.1.173.49626 &gt; 142.251.41.78.1234: Flags [S], seq 613574185, win 65535, options [mss 1460,nop,wscale 6,nop,nop,TS val 2730442520 ecr 0,sackOK,eol], length 0
 
# when you're done, kill the tcpdump in the background
$ kill %1 
</code></pre>
<p>I think it&rsquo;s really nice here that you can see the output of tcpdump inline in
your terminal &ndash; when I&rsquo;m using tcpdump I&rsquo;m always switching back and forth and
I always get confused trying to match up the timestamps, so keeping everything
in one terminal seems like it might be a lot clearer. I&rsquo;m going to try it.</p>
<h3 id="reason-5-suspend-a-cpu-hungry-program">reason 5: suspend a CPU-hungry program</h3>
<p>One person said that sometimes they&rsquo;re running a very CPU-intensive program,
for example converting a video with <code>ffmpeg</code>, and they need to use the CPU for
something else, but don&rsquo;t want to lose the work that ffmpeg already did.</p>
<p>You can do this by pressing <code>Ctrl+Z</code> to pause the process, and then run <code>fg</code>
when you want to start it again.</p>
<h3 id="reason-6-you-accidentally-ran-ctrl-z">reason 6: you accidentally ran Ctrl+Z</h3>
<p>Many people replied that they didn&rsquo;t use job control <em>intentionally</em>, but
that they sometimes accidentally ran Ctrl+Z, which stopped whatever program was
running, so they needed to learn how to use <code>fg</code> to bring it back to the
foreground.</p>
<p>The were also some mentions of accidentally running <code>Ctrl+S</code> too (which stops
your terminal and I think can be undone with <code>Ctrl+Q</code>). My terminal totally
ignores <code>Ctrl+S</code> so I guess I&rsquo;m safe from that one though.</p>
<h3 id="reason-7-already-set-up-a-bunch-of-environment-variables">reason 7: already set up a bunch of environment variables</h3>
<p>Some folks mentioned that they already set up a bunch of environment variables
that they need to run various commands, so it&rsquo;s easier to use job control to
run multiple commands in the same terminal than to redo that work in another
tab.</p>
<h3 id="reason-8-it-s-your-only-option">reason 8: it&rsquo;s your only option</h3>
<p>Probably the most obvious reason to use job control to manage multiple
processes is &ldquo;because you have to&rdquo; &ndash; maybe you&rsquo;re in single-user mode, or on a
very restricted computer, or SSH&rsquo;d into a machine that doesn&rsquo;t have tmux or
screen and you don&rsquo;t want to create multiple SSH sessions.</p>
<h3 id="reason-9-some-people-just-like-it-better">reason 9: some people just like it better</h3>
<p>Some people also said that they just don&rsquo;t like using terminal tabs: for
instance a few folks mentioned that they prefer to be able to see all of their
terminals on the screen at the same time, so they&rsquo;d rather have 4 terminals on
the screen and then use job control if they need to run more than 4 programs.</p>
<h3 id="i-learned-a-few-new-tricks">I learned a few new tricks!</h3>
<p>I think my two main takeaways from thos post is I&rsquo;ll probably try out job control a little more for:</p>
<ol>
<li>killing processes that don&rsquo;t respond to Ctrl+C</li>
<li>running <code>tcpdump</code> in the background with whatever network command I&rsquo;m running, so I can see both of their output in the same place</li>
</ol>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[New zine: How Git Works!]]></title>
    <link href="https://jvns.ca/blog/2024/04/25/new-zine--how-git-works-/"/>
    <updated>2024-06-03T09:45:11+00:00</updated>
    <id>https://jvns.ca/blog/2024/04/25/new-zine--how-git-works-/</id>
    <content type="html"><![CDATA[<p>Hello! I&rsquo;ve been writing about git on here nonstop for months, and the git zine
is FINALLY done! It came out on Friday!</p>
<p>You can get it for $12 here:
<a href="https://wizardzines.com/zines/git">https://wizardzines.com/zines/git</a>, or get
an <a href="https://wizardzines.com/zines/all-the-zines/">14-pack of all my zines here</a>.</p>
<p>Here&rsquo;s the cover:</p>
<div align="center">
<a href="https://wizardzines.com/zines/git">
  <img width="600px" src="https://wizardzines.com/zines/git/cover-small.jpg">
  </a>
</div>
<h3 id="the-table-of-contents">the table of contents</h3>
<p>Here&rsquo;s the table of contents:</p>
<a href="https://wizardzines.com/zines/git/toc.png">
  <img width="600px" src="https://wizardzines.com/zines/git/toc.png">
</a>
<h3 id="who-is-this-zine-for">who is this zine for?</h3>
<p>I wrote this zine for people who have been using git for years and are still
afraid of it. As always &ndash; I think it sucks to be afraid of the tools that you
use in your work every day! I want folks to feel confident using git.</p>
<p>My goals are:</p>
<ul>
<li>To explain how some parts of git that initially seem scary (like &ldquo;detached
HEAD state&rdquo;) are pretty straightforward to deal with once you understand
what&rsquo;s going on</li>
<li>To show some parts of git you probably <em>should</em> be careful around.  For
example, the stash is one of the places in git where it&rsquo;s easiest to lose
your work in a way that&rsquo;s incredibly annoying to recover form, and I avoid
using it heavily because of that.</li>
<li>To clear up a few common misconceptions about how the core parts of git (like
commits, branches, and merging) work</li>
</ul>
<h3 id="what-s-the-difference-between-this-and-oh-shit-git">what&rsquo;s the difference between this and Oh Shit, Git!</h3>
<p>You might be wondering – Julia! You already have a zine about git! What’s going
on? <a href="https://wizardzines.com/zines/oh-shit-git">Oh Shit, Git!</a> is a set of tricks for fixing git messes. <a href="https://wizardzines.com/zines/git/">&ldquo;How Git Works&rdquo;</a>
explains how Git <strong>actually</strong> works.</p>
<p>Also, Oh Shit, Git! is the amazing <a href="https://sylormiller.com/">Katie Sylor Miller</a>&rsquo;s <a href="https://ohshitgit.com/">concept</a>: we made it
into a zine because I was such a huge fan of her work on it.</p>
<p>I think they go really well together.</p>
<h3 id="what-s-so-confusing-about-git-anyway">what&rsquo;s so confusing about git, anyway?</h3>
<p>This zine was really hard for me to write because when I started writing it,
I&rsquo;d been using git pretty confidently for 10 years. I had no real memory of
what it was <em>like</em> to struggle with git.</p>
<p>But thanks to a huge amount of help from <a href="https://marieflanagan.com/">Marie</a> as
well as everyone who talked to me about git on Mastodon, eventually I was able
to see that there are a lot of things about git that are counterintuitive,
misleading, or just plain confusing. These include:</p>
<ul>
<li><a href="https://jvns.ca/blog/2023/11/01/confusing-git-terminology/">confusing terminology</a> (for example &ldquo;fast-forward&rdquo;, &ldquo;reference&rdquo;, or &ldquo;remote-tracking branch&rdquo;)</li>
<li>misleading messages (for example how <code>Your branch is up to date with 'origin/main'</code> doesn&rsquo;t necessary mean that your branch is up to date with the <code>main</code> branch on the origin)</li>
<li>uninformative output (for example how I <em>STILL</em> can&rsquo;t reliably figure out which code comes from which branch when I&rsquo;m looking at a merge conflict)</li>
<li>a lack of guidance around handling diverged branches (for example how when you run <code>git pull</code> and your branch has diverged from the origin, it doesn&rsquo;t give you great guidance how to handle the situation)</li>
<li>inconsistent behaviour (for example how git&rsquo;s reflogs are almost always append-only, EXCEPT for the stash, where git will delete entries when you run <code>git stash drop</code>)</li>
</ul>
<p>The more I heard from people how about how confusing they find git, the more it
became clear that git really does not make it easy to figure out what its
internal logic is just by using it.</p>
<h3 id="handling-git-s-weirdnesses-becomes-pretty-routine">handling git&rsquo;s weirdnesses becomes pretty routine</h3>
<p>The previous section made git sound really bad, like &ldquo;how can anyone possibly
use this thing?&rdquo;.</p>
<p>But my experience is that after I learned what git actually means by all of its
weird error messages, dealing with it became pretty routine! I&rsquo;ll see an
<code>error: failed to push some refs to 'github.com:jvns/wizard-zines-site'</code>,
realize &ldquo;oh right, probably a coworker made some changes to <code>main</code> since I last
ran <code>git pull</code>&rdquo;, run <code>git pull --rebase</code> to incorporate their changes, and move
on with my day. The whole thing takes about 10 seconds.</p>
<p>Or if I see a <code>You are in 'detached HEAD' state</code> warning, I&rsquo;ll just make sure
to run <code>git checkout mybranch</code> before continuing to write code. No big deal.</p>
<p>For me (and for a lot of folks I talk to about git!), dealing with git&rsquo;s weird
language can become so normal that you totally forget why anybody would even
find it weird.</p>
<h3 id="a-little-bit-of-internals">a little bit of internals</h3>
<p>One of my biggest questions when writing this zine was how much to focus on
what&rsquo;s in the <code>.git</code> directory. We ended up deciding to include a couple of
pages about internals (&ldquo;inside .git&rdquo;, pages 14-15), but otherwise focus more on
git&rsquo;s <em>behaviour</em> when you use it and why sometimes git behaves in unexpected
ways.</p>
<p>This is partly because there are lots of great guides to git&rsquo;s internals
out there already (<a href="https://maryrosecook.com/blog/post/git-from-the-inside-out">1</a>, <a href="https://shop.jcoglan.com/building-git/">2</a>), and partly because I think even if you <em>have</em> read one
of these guides to git&rsquo;s internals, it isn&rsquo;t totally obvious how to connect
that information to what you actually see in git&rsquo;s user interface.</p>
<p>For example: it&rsquo;s easy to find documentation about remotes in git &ndash;
for example <a href="https://git-scm.com/book/en/v2/Git-Branching-Remote-Branches">this page</a> says:</p>
<blockquote>
<p>Remote-tracking branches [&hellip;] remind you where the branches in your remote
repositories were the last time you connected to them.</p>
</blockquote>
<p>But even if you&rsquo;ve read that, you might not realize that the statement <code>Your branch is up to date with 'origin/main'&quot;</code> in <code>git status</code> doesn&rsquo;t necessarily
mean that you&rsquo;re actually up to date with the remote <code>main</code> branch.</p>
<p>So in general in the zine we focus on the behaviour you see in Git&rsquo;s UI, and
then explain how that relates to what&rsquo;s happening internally in Git.</p>
<h3 id="the-cheat-sheet">the cheat sheet</h3>
<p>The zine also comes with a free printable cheat sheet: (click to get a PDF version)</p>
<a href="https://wizardzines.com/git-cheat-sheet.pdf">
  <img width="600px" src="https://wizardzines.com/images/cheat-sheet-smaller.png">
</a>
<h3 id="it-comes-with-an-html-transcript">it comes with an HTML transcript!</h3>
<p>The zine also comes with an HTML transcript, to (hopefully) make it easier to
read on a screen reader! Our Operations Manager, Lee, transcribed all of the
pages and wrote image descriptions. I&rsquo;d love feedback about the experience of
reading the zine on a screen reader if you try it.</p>
<h3 id="i-really-do-love-git">I really do love git</h3>
<p>I&rsquo;ve been pretty critical about git in this post, but I only write zines about
technologies I love, and git is no exception.</p>
<p>Some reasons I love git:</p>
<ul>
<li>it&rsquo;s fast!</li>
<li>it&rsquo;s backwards compatible! I learned how to use it 10 years ago and
everything I learned then is still true</li>
<li>there&rsquo;s tons of great free Git hosting available out there (GitHub! Gitlab! a
million more!), so I can easily back up all my code</li>
<li>simple workflows are REALLY simple (if I&rsquo;m working on a project on my own, I
can just run <code>git commit -am 'whatever'</code> and <code>git push</code> over and over again and it
works perfectly)</li>
<li>Almost every internal file in git is a pretty simple text file (or has a
version which is a text file), which makes me feel like I can always
understand exactly what&rsquo;s going on under the hood if I want to.</li>
</ul>
<p>I hope this zine helps some of you love it too.</p>
<h3 id="people-who-helped-with-this-zine">people who helped with this zine</h3>
<p>I don&rsquo;t make these zines by myself!</p>
<p>I worked with <a href="https://marieflanagan.com/">Marie Claire LeBlanc Flanagan</a> every
morning for 8 months to write clear explanations of git.</p>
<p>The cover is by Vladimir Kašiković,
Gersande La Flèche did copy editing,
James Coglan (of the great <a href="https://shop.jcoglan.com/building-git/">Building
Git</a>) did technical review, our
Operations Manager Lee did the transcription as well as a million other
things, my partner Kamal read the zine and told me which parts were off (as he
always does), and I had a million great conversations with Marco Rogers about
git.</p>
<p>And finally, I want to thank all the beta readers! There were 66 this time
which is a record! They left hundreds of comments about what was confusing,
what they learned, and which of my jokes were funny. It&rsquo;s always hard to hear
from beta readers that a page I thought made sense is actually extremely
confusing, and fixing those problems before the final version makes the zine so
much better.</p>
<h3 id="get-the-zine">get the zine</h3>
<p>Here are some links to get the zine again:</p>
<ul>
<li>get <a href="https://wizardzines.com/zines/git">How Git Works</a></li>
<li>get an <a href="https://wizardzines.com/zines/all-the-zines/">14-pack of all my zines here</a>.</li>
</ul>
<p>As always, you can get either a PDF version to print at home or a print version
shipped to your house. The only caveat is print orders will ship in <strong>July</strong> &ndash; I
need to wait for orders to come in to get an idea of how many I should print
before sending it to the printer.</p>
<h3 id="thank-you">thank you</h3>
<p>As always: if you&rsquo;ve bought zines in the past, thank you for all your support
over the years. And thanks to all of you (1000+ people!!!) who have already
bought the zine in the first 3 days. It&rsquo;s already set a record for most zines
sold in a single day and I&rsquo;ve been really blown away.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Notes on git's error messages]]></title>
    <link href="https://jvns.ca/blog/2024/04/10/notes-on-git-error-messages/"/>
    <updated>2024-04-10T12:43:14+00:00</updated>
    <id>https://jvns.ca/blog/2024/04/10/notes-on-git-error-messages/</id>
    <content type="html"><![CDATA[<p>While writing about Git, I&rsquo;ve noticed that a lot of folks struggle with Git&rsquo;s
error messages. I&rsquo;ve had many years to get used to these error messages so it
took me a really long time to understand <em>why</em> folks were confused, but having
thought about it much more, I&rsquo;ve realized that:</p>
<ol>
<li>sometimes I actually <em>am</em> confused by the error messages, I&rsquo;m just used to
being confused</li>
<li>I have a bunch of strategies for getting more information when the error
message git gives me isn&rsquo;t very informative</li>
</ol>
<p>So in this post, I&rsquo;m going to go through a bunch of Git&rsquo;s error messages,
list a few things that I think are confusing about them for each one, and talk
about what I do when I&rsquo;m confused by the message.</p>
<h3 id="improving-error-messages-isn-t-easy">improving error messages isn&rsquo;t easy</h3>
<p>Before we start, I want to say that trying to think about why these error
messages are confusing has given me a lot of respect for how difficult
maintaining Git is. I&rsquo;ve been thinking about Git for months, and for some of
these messages I really have no idea how to improve them.</p>
<p>Some things that seem hard to me about improving error messages:</p>
<ul>
<li>if you come up with an idea for a new message, it&rsquo;s hard to tell if it&rsquo;s actually better!</li>
<li>work like improving error messages often <a href="https://lwn.net/Articles/959768/">isn&rsquo;t funded</a></li>
<li>the error messages have to be translated (git&rsquo;s error messages are translated into <a href="https://github.com/git/git/tree/master/po">19 languages</a>!)</li>
</ul>
<p>That said, if you find these messages confusing, hopefully some of these notes
will help clarify them a bit.</p>
<style>
.error {
  color: #db322e;
}
.warning {
  color: #765900;
}
.bg {
  color: #fdf6e3
}
pre {
  background-color: #fdf6e3;
  padding: 10px;
  border-radius: 5px;
  /* wrap long lines */
  white-space: pre-wrap;
}

h2 a {
  color: black;
  text-decoration: none;
}

article span {
  padding: 0;
}

article a:hover {
  text-decoration: underline;
}
</style>
<h2 id="git-push-on-a-diverged-branch">
  <a href="#git-push-on-a-diverged-branch">
  error: <code>git push</code> on a diverged branch
  </a>
</h2>
<pre>
$ git push
To github.com:jvns/int-exposed
<span class="error">! [rejected]        main -> main (non-fast-forward)</span>
<span class="warning">error: failed to push some refs to 'github.com:jvns/int-exposed'
hint: Updates were rejected because the tip of your current branch is behind
hint: its remote counterpart. Integrate the remote changes (e.g.
hint: 'git pull ...') before pushing again.
hint: See the 'Note about fast-forwards' in 'git push --help' for details.</span>

$ git status
On branch main
Your branch and 'origin/main' have diverged,
and have 2 and 1 different commits each, respectively.
</pre>
<p>Some things I find confusing about this:</p>
<ol>
<li>You get the exact same error message whether the branch is just <strong>behind</strong>
or the branch has <strong>diverged</strong>. There&rsquo;s no way to tell which it is from this
message: you need to run <code>git status</code> or <code>git pull</code> to find out.</li>
<li>It says <code>failed to push some refs</code>, but it&rsquo;s not totally clear <em>which</em> references it
failed to push. I believe everything that failed to push is listed with <code>! [rejected]</code> on the previous line&ndash; in this case just the <code>main</code> branch.</li>
</ol>
<p><strong>What I like to do if I&rsquo;m confused:</strong></p>
<ul>
<li>I&rsquo;ll run <code>git status</code> to figure out what the state of my current branch is.</li>
<li>I think I almost never try to push more than one branch at a time, so I
usually totally ignore git&rsquo;s notes about which specific branch failed to push
&ndash; I just assume that it&rsquo;s my current branch</li>
</ul>
<h2 id="git-pull-on-a-diverged-branch">
  <a href="#git-pull-on-a-diverged-branch">
  error: <code>git pull</code> on a diverged branch
  </a>
</h2>
<pre>
$ git pull
<span class="warning">hint: You have divergent branches and need to specify how to reconcile them.
hint: You can do so by running one of the following commands sometime before
hint: your next pull:
hint:
hint:   git config pull.rebase false  # merge
hint:   git config pull.rebase true   # rebase
hint:   git config pull.ff only       # fast-forward only
hint:
hint: You can replace "git config" with "git config --global" to set a default
hint: preference for all repositories. You can also pass --rebase, --no-rebase,
hint: or --ff-only on the command line to override the configured default per
hint: invocation.</span>
fatal: Need to specify how to reconcile divergent branches.
</pre>
<p>The main thing I think is confusing here is that git is presenting you with a
kind of overwhelming number of options: it&rsquo;s saying that you can either:</p>
<ol>
<li>configure <code>pull.rebase false</code>, <code>pull.rebase true</code>, or <code>pull.ff only</code> locally</li>
<li>or configure them globally</li>
<li>or run <code>git pull --rebase</code> or <code>git pull --no-rebase</code></li>
</ol>
<p>It&rsquo;s very hard to imagine how a beginner to git could easily use this hint to
sort through all these options on their own.</p>
<p>If I were explaining this to a friend, I&rsquo;d say something like &ldquo;you can use <code>git pull --rebase</code>
or <code>git pull --no-rebase</code> to resolve this with a rebase or merge
<em>right now</em>, and if you want to set a permanent preference, you can do that
with <code>git config pull.rebase false</code> or <code>git config pull.rebase true</code>.</p>
<p><code>git config pull.ff only</code> feels a little redundant to me because that&rsquo;s git&rsquo;s
default behaviour anyway (though it wasn&rsquo;t always).</p>
<p><strong>What I like to do here:</strong></p>
<ul>
<li>run <code>git status</code> to see the state of my current branch</li>
<li>maybe run <code>git log origin/main</code> or <code>git log</code> to see what the diverged commits are</li>
<li>usually run <code>git pull --rebase</code> to resolve it</li>
<li>sometimes I&rsquo;ll run <code>git push --force</code> or <code>git reset --hard origin/main</code> if I
want to throw away my local work or remote work (for example because I
accidentally commited to the wrong branch, or because I ran <code>git commit --amend</code> on a personal branch that only I&rsquo;m using and want to force push)</li>
</ul>
<h2 id="git-checkout-asdf">
  <a href="#git-checkout-asdf">
  error: <code>git checkout asdf</code> (a branch that doesn't exist)
  </a>
</h2>
<pre>
$ git checkout asdf
error: pathspec 'asdf' did not match any file(s) known to git
</pre>
<p>This is a little weird because we my intention was to check out a <strong>branch</strong>,
but <code>git checkout</code> is complaining about a <strong>path</strong> that doesn&rsquo;t exist.</p>
<p>This is happening because <code>git checkout</code>&rsquo;s first argument can be either a
branch or a path, and git has no way of knowing which one you intended. This
seems tricky to improve, but I might expect something like &ldquo;No such branch,
commit, or path: asdf&rdquo;.</p>
<p><strong>What I like to do here:</strong></p>
<ul>
<li>in theory it would be good to use <code>git switch</code> instead, but I keep using <code>git checkout</code> anyway</li>
<li>generally I just remember that I need to decode this as &ldquo;branch <code>asdf</code> doesn&rsquo;t exist&rdquo;</li>
</ul>
<h2 id="git-switch-asdf">
  <a href="#git-switch-asdf">
  error: <code>git switch asdf</code> (a branch that doesn't exist)
  </a>
</h2>
<pre>
$ git switch asdf
fatal: invalid reference: asdf
</pre>
<p><code>git switch</code> only accepts a branch as an argument (unless you pass <code>-d</code>), so why is it saying <code>invalid reference: asdf</code> instead of <code>invalid branch: asdf</code>?</p>
<p>I think the reason is that internally, <code>git switch</code> is trying to be helpful in its error messages: if you run <code>git switch v0.1</code> to switch to a tag, it&rsquo;ll say:</p>
<pre><code>$ git switch v0.1
fatal: a branch is expected, got tag 'v0.1'`
</code></pre>
<p>So what git is trying to communicate with <code>fatal: invalid reference: asdf</code> is
&ldquo;<code>asdf</code> isn&rsquo;t a branch, but it&rsquo;s not a tag either, or any other reference&rdquo;. From my various <a href="https://jvns.ca/blog/2024/03/28/git-poll-results/">git polls</a> my impression is that
a lot of git users have literally no idea what a &ldquo;reference&rdquo; is in git, so I&rsquo;m not sure if that&rsquo;s coming across.</p>
<p><strong>What I like to do here:</strong></p>
<p>90% of the time when a git error message says <code>reference</code> I just mentally
replace it with <code>branch</code> in my head.</p>
<h2 id="detached-head">
  error: <a href="#detached-head"><code>git checkout HEAD^</code></a>
</h2>
<pre>$ git checkout HEAD^
Note: switching to 'HEAD^'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by switching back to a branch.

If you want to create a new branch to retain commits you create, you may
do so (now or later) by using -c with the switch command. Example:

  git switch -c <new-branch-name>

Or undo this operation with:

  git switch -

Turn off this advice by setting config variable advice.detachedHead to false

HEAD is now at 182cd3f add "swap byte order" button
</pre>
<p>
This is a tough one. Definitely a lot of people are confused about this
message, but obviously there's been a lot of effort to improve it too. I don't
have anything smart to say about this one.
</p>
<p><strong>What I like to do here:</strong></p>
<ul>
<li>my shell prompt tells me if I&rsquo;m in detached HEAD state, and generally I can remember not to make new commits while in that state</li>
<li>when I&rsquo;m done looking at whatever old commits I wanted to look at, I&rsquo;ll run <code>git checkout main</code> or something to go back to a branch</li>
</ul>
<h2 id="rebase-in-progress">
  <a href="#rebase-in-progress">
  message: <code>git status</code> when a rebase is in progress
  </a>  
</h2>
<p>This isn&rsquo;t an error message, but I still find it a little confusing on its own:</p>
<pre>
$ git status
<span class="error">interactive rebase in progress;</span> onto c694cf8
Last command done (1 command done):
   pick 0a9964d wip
No commands remaining.
You are currently rebasing branch 'main' on 'c694cf8'.
  (fix conflicts and then run "git rebase --continue")
  (use "git rebase --skip" to skip this patch)
  (use "git rebase --abort" to check out the original branch)

Unmerged paths:
  (use "git restore --staged <file>..." to unstage)
  (use "git add <file>..." to mark resolution)
  <span class="error">both modified:   index.html</span>

no changes added to commit (use "git add" and/or "git commit -a")
</pre>
<p>Two things I think could be clearer here:</p>
<ol>
<li>I think it would be nice if <code>You are currently rebasing branch 'main' on 'c694cf8'.</code> were on the first line instead of the 5th line &ndash; right now the first line doesn&rsquo;t say which branch you&rsquo;re rebasing.</li>
<li>In this case, <code>c694cf8</code> is actually <code>origin/main</code>, so I feel like <code>You are currently rebasing branch 'main' on 'origin/main'</code> might be even clearer.</li>
</ol>
<p><strong>What I like to do here:</strong></p>
<p>My shell prompt includes the branch that I&rsquo;m currently rebasing, so I rely on that instead of the output of <code>git status</code>.</p>
<h2 id="merge-deleted">
  <a href="#merge-deleted">
  error: <code>git rebase</code> when a file has been deleted
  </a>
</h2>
<pre>
$ git rebase main
CONFLICT (modify/delete): index.html deleted in 0ce151e (wip) and modified in HEAD.  Version HEAD of index.html left in tree.
error: could not apply 0ce151e... wip
</pre>
<p>The thing I still find confusing about this is &ndash; <code>index.html</code> was modified in
<code>HEAD</code>. But what is <code>HEAD</code>? Is it the commit I was working on when I started
the merge/rebase, or is it the commit from the other branch? (the answer is
&ldquo;<code>HEAD</code> is your branch if you&rsquo;re doing a merge, and it&rsquo;s the &ldquo;other branch&rdquo; if
you&rsquo;re doing a rebase, but I always find that hard to remember)</p>
<p>I think I would personally find it easier to understand if the message listed the branch names if possible, something like this:</p>
<pre><code>CONFLICT (modify/delete): index.html deleted on `main` and modified on `mybranch`
</code></pre>
<h2 id="merge-ours">
  <a href="#merge-ours">
  error: <code>git status</code> during a merge or rebase (who is "them"?)
  </a>
</h2>
<pre>
$ git status 
On branch master
You have unmerged paths.
  (fix conflicts and run "git commit")
  (use "git merge --abort" to abort the merge)
<p>Unmerged paths:
(use &ldquo;git add/rm <file>&hellip;&rdquo; as appropriate to mark resolution)
deleted by them: the_file</p>
<p>no changes added to commit (use &ldquo;git add&rdquo; and/or &ldquo;git commit -a&rdquo;)
</pre></p>
<p>I find this one confusing in exactly the same way as the previous message: it
says <code>deleted by them:</code>, but what &ldquo;them&rdquo; refers to depends on whether you did a merge or rebase or cherry-pick.</p>
<ul>
<li>for a merge, <code>them</code> is the other branch you merged in</li>
<li>for a rebase, <code>them</code> is the branch that you were on when you ran <code>git rebase</code></li>
<li>for a cherry-pick, I guess it&rsquo;s the commit you cherry-picked</li>
</ul>
<p><strong>What I like to do if I&rsquo;m confused:</strong></p>
<ul>
<li>try to remember what I did</li>
<li>run <code>git show main --stat</code> or something to see what I did on the <code>main</code> branch if I can&rsquo;t remember</li>
</ul>
<h2 id="git clean">
  <a href="#git-clean">
  error: <code>git clean</code>
  </a>
</h2>
<pre>
$ git clean
fatal: clean.requireForce defaults to true and neither -i, -n, nor -f given; refusing to clean
</pre>
<p>I just find it a bit confusing that you need to look up what <code>-i</code>, <code>-n</code> and
<code>-f</code> are to be able to understand this error message. I&rsquo;m personally way too
lazy to do that so even though I&rsquo;ve probably been using <code>git clean</code> for 10
years I still had no idea what <code>-i</code> stood for (<code>interactive</code>) until I was
writing this down.</p>
<p><strong>What I like to do if I&rsquo;m confused:</strong></p>
<p>Usually I just chaotically run <code>git clean -f</code> to delete all my untracked files
and hope for the best, though I might actually switch to <code>git clean -i</code>  now
that I know what <code>-i</code> stands for. Seems a lot safer.</p>
<h3 id="that-s-all">that&rsquo;s all!</h3>
<p>Hopefully some of this is helpful!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Making crochet cacti]]></title>
    <link href="https://jvns.ca/blog/2024/04/01/making-crochet-cacti/"/>
    <updated>2024-04-01T07:37:00+00:00</updated>
    <id>https://jvns.ca/blog/2024/04/01/making-crochet-cacti/</id>
    <content type="html"><![CDATA[<p>I noticed some tech bloggers I follow have been making <a href="https://www.aprilcools.club/">April Cools Day</a> posts about topics they don&rsquo;t normally write
about (like <a href="https://ntietz.com/blog/decaf-is-good-actually/">decaf</a> or <a href="https://www.hillelwayne.com/post/microscopy/">microscopes</a>). The goal isn&rsquo;t to
trick anyone, just to write about something different for a day.</p>
<p>I thought those posts were fun so here is a post with some notes on learning to crochet tiny cacti.</p>
<h3 id="first-the-cacti">first, the cacti</h3>
<p>I&rsquo;ve been trying to do some non-computer hobbies, without putting a lot of
pressure on myself to be &ldquo;good&rdquo; at them. Here are some cacti I crocheted:</p>
<img src="https://jvns.ca/images/cacti.png">
<p>They are a little wonky and I like them.</p>
<h3 id="a-couple-of-other-critters">a couple of other critters</h3>
<p>Here are a couple of other things I made: an elephant, an orange guy, a
much earlier attempt at a cactus, and an in-progress cactus</p>
<img src="https://jvns.ca/images/elephant.png" width="200px">
<img src="https://jvns.ca/images/orange-guy.png" width="200px">
<img src="https://jvns.ca/images/cactus2.png" width="200px">
<img src="https://jvns.ca/images/cactus3.png" width="200px">
<p>Some of these are also pretty wonky, but sometimes it adds to the charm: for
example the elephant&rsquo;s head is attached at an angle which was not on purpose
but I think adds to the effect. (<a href="https://www.etsy.com/ca/listing/789349199/mr-orange-monster-amigurumi-crochet">orange guy pattern</a>, <a href="https://hellostitchesxo.com.au/amigurumi-elephant-crochet-free-pattern/">elephant pattern</a>)</p>
<p>I haven&rsquo;t really been making clothing: I like working in a pretty chaotic way
and I think you need to be a lot more careful when you make clothing so that it
will actually fit.</p>
<h3 id="the-first-project-a-mouse">the first project: a mouse</h3>
<p>The first project I made was this little <a href="https://www.yarnhild.com/crochet-amigurumi-mouse/">mouse</a>. It took me a few
hours (maybe 3 hours?) and I made a lot of mistakes and it definitely was not
as cute as it was in the pictures in the pattern, but it was still good! I
can&rsquo;t find a picture right now though.</p>
<h3 id="buying-patterns-is-great">buying patterns is great</h3>
<p>Originally I started out using free patterns, but I found some cacti patterns I really liked in an ebook called <a href="https://knotmonsters.com/products/12-crochet-mini-cactus-garden-patterns-ebook-pdf-knotmonsters-amigurumi-crochet-patterns-beginner-easy-simple-basic-plant-cacti-project-lot">Knotmonsters: Cactus Gardens Edition</a>, so I bought it.</p>
<p>I like the patterns in that book and also buying patterns seems like a nice way
to support people who are making fun patterns. I found <a href="https://www.youtube.com/watch?v=KTvHB9HTPQI">this guide to designing your own patterns</a> through
searching on Ravelry and it seems like a lot of work! Maybe I will do it one
day but for now I appreciate the
work of other people who make the patterns.</p>
<h3 id="modifying-patterns-chaotically-is-great-too">modifying patterns chaotically is great too</h3>
<p>I&rsquo;ve been modifying all of the patterns I make in a somewhat chaotic way, often
just because I made a mistake somewhere along the way and then decide to move
forward and change the pattern to adjust for the mistake instead of undoing my
work. Some of of the changes I&rsquo;ve made are:</p>
<ul>
<li>remove rows</li>
<li>put fewer stitches in a row</li>
<li>use a different stitch</li>
</ul>
<p>This doesn&rsquo;t always work but often it works well enough, and I think all of the
mistakes help me learn.</p>
<h3 id="no-safety-eyes">no safety eyes</h3>
<p>A lot of the patterns I&rsquo;ve been seeing for animals suggest using &ldquo;safety eyes&rdquo;
(plastic eyes). I didn&rsquo;t really feel like buying those , so I&rsquo;ve been
embroidering eyes on instead. &ldquo;Embroidering&rdquo; might not be accurate, really I
just sew some black yarn on in a haphazard way and hope it doesn&rsquo;t come out
looking too weird.</p>
<p>My crochet kit came with a big plastic yarn needle that I&rsquo;ve been using to
embroider and also</p>
<h3 id="no-stitch-markers">no stitch markers</h3>
<p>My crochet kit came with some plastic &ldquo;stitch markers&rdquo; which you can use to
figure out where the beginning of your row is, so you know when you&rsquo;re done.
I&rsquo;ve been finding it easier to just use a short piece of scrap yarn instead.</p>
<h3 id="on-dealing-with-all-the-counting">on dealing with all the counting</h3>
<p>In crochet there is a LOT of counting. Like &ldquo;single crochet 3 times, then
double crochet 1 time, then repeat that 6 times&rdquo;. I find it hard to do that
accurately without making mistakes, and all of the counting is not that fun! A
few things that have helped:</p>
<ul>
<li>go back and look at my stitches to see what I did (&ldquo;have I done 1 single
crochet, or 2?&rdquo;). I&rsquo;m not actually very good at doing this, but I find it
easier to see my stitches with wool/cotton yarn than with acrylic yarn for
some reason.</li>
<li>count how many stitches in total I&rsquo;ve done since the last row, and make sure
it seems approximately right (&ldquo;well, I&rsquo;m supposed to have 20 stitches and I
have 19, that&rsquo;s pretty close!&rdquo;). Then I&rsquo;ll maybe just add an extra stitch in
the wrong place to adjust, or maybe just leave it the way it is.</li>
</ul>
<h3 id="notes-on-yarn">notes on yarn</h3>
<p>So far I&rsquo;ve tried three kinds of yarn: merino (for the elephant), cotton (for
the cacti), and acrylic (for the orange dude). I still don&rsquo;t know
which one I like best, but since I&rsquo;m doing small projects it feels like the
right move is still to just buy small amounts of yarn and experiment. I think I
like the cotton and merino more than the acrylic.</p>
<p>For the cacti I used <a href="https://www.artisanthropy.ca/products/rico-ricorumi-dk">Ricorumi</a> cotton yarn,
which comes in tiny balls (which is good for me because if I don&rsquo;t end up
liking it, I don&rsquo;t have a lot of extra!) and in a lot of different colours.</p>
<p>There are a lot of yarn weights (lace! sock! sport! DK! worsted! bulky! and
more!). I don&rsquo;t really underestand them yet but I think so far I&rsquo;ve been mostly
using DK and worsted yarn.</p>
<h3 id="hook-size-who-knows">hook size? who knows!</h3>
<p>I&rsquo;ve mostly been using a 3.5mm hook, probably because I read a tutorial that
said to use a 3.5mm hook. It seems to work fine! I used a larger hook size when
making a hat, and that also worked.</p>
<p>I still don&rsquo;t really know how to choose hook sizes but that doesn&rsquo;t seem to
have a lot of consequences when making cacti.</p>
<h3 id="every-stitch-i-ve-learned">every stitch I&rsquo;ve learned</h3>
<p>I think I&rsquo;ve probably only learned how to do 5 things in crochet so far:</p>
<ul>
<li>magic ring (mr)</li>
<li>single crochet (sc)</li>
<li>half double crochet (hdc)</li>
<li>front post half double crochet (fphdc)</li>
<li>double crochet (dc)</li>
<li>back loops only/front loops only (flo/blo)</li>
<li>increase/decrease</li>
</ul>
<p>The way I&rsquo;ve been approaching learning new crochet stitches is:</p>
<ol>
<li>find a pattern I want to make</li>
<li>start it without reviewing it very much at all</li>
<li>when I get to a stitch I don&rsquo;t know, watch youtube videos</li>
<li>don&rsquo;t watch it very carefully and get it wrong</li>
<li>eventually realize that it doesn&rsquo;t look right at all, rewatch the video, and continue</li>
</ol>
<p>I&rsquo;ve been using <a href="https://sarahmaker.com/half-double-crochet/">Sarah Maker</a>&rsquo;s pages a lot, except for the magic ring where I used <a href="https://www.youtube.com/watch?v=p298HxgsO1s">this 3-minute youtube video</a>.</p>
<p>The magic ring took me a very long time to learn to do correctly, I didn&rsquo;t pay
attention very closely to the 3-minute youtube video so I did it wrong in maybe
4 projects before I figured out how to do it right.</p>
<h3 id="every-single-thing-i-ve-bought">every single thing I&rsquo;ve bought</h3>
<p>So far I&rsquo;ve only needed:</p>
<ol>
<li>a crochet kit (which I got as a gift). it came with yarn, a bunch of crochet needles in different sizes, big sewing needles, and some other things I haven&rsquo;t needed yet.</li>
<li>some Ricorumi cotton (for the cacti)</li>
<li>1 ball of gray yarn (for the elephant)</li>
</ol>
<p>I&rsquo;ve been trying to not buy too much stuff, because I never know if I&rsquo;ll get
bored with a new hobby, and if I get bored it&rsquo;s annoying to have a bunch of
stuff lying around. Some examples of things I&rsquo;ve avoided buying so far:</p>
<ul>
<li>Instead of buying polyester fiberfill, to fill all of the critters I&rsquo;ve just
been cutting up an old sweater I have that was falling apart.</li>
<li>I&rsquo;ve been embroidering the eyes instead of buying safety eyes</li>
</ul>
<p>Everything I have right now fits in a the box the crochet kit came in (which is
about the size of a large shoebox), and my plan is to keep it that way for a
while.</p>
<h3 id="that-s-all">that&rsquo;s all!</h3>
<p>Mainly what I like about crochet so far is that:</p>
<ul>
<li>it&rsquo;s a way to not be on the computer, and you can chat with people while doing it</li>
<li>you can do it without buying too much stuff, it&rsquo;s pretty compact</li>
<li>I end up with cacti in our living room which is great (I also have a bunch of real succulents, so they go with those)</li>
<li>it seems extremely forgiving of mistakes and experimentation</li>
</ul>
<p>There are definitely still a lot of things I&rsquo;m doing &ldquo;wrong&rdquo; but it&rsquo;s fun to
learn through trial and error.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Some Git poll results]]></title>
    <link href="https://jvns.ca/blog/2024/03/28/git-poll-results/"/>
    <updated>2024-03-28T08:35:56+00:00</updated>
    <id>https://jvns.ca/blog/2024/03/28/git-poll-results/</id>
    <content type="html"><![CDATA[<p>A new thing I&rsquo;ve been trying while writing this Git zine is doing a bunch of polls on Mastodon to learn about:</p>
<ul>
<li>which git commands/workflows people use (like &ldquo;do you use merge or rebase more?&rdquo; or &ldquo;do you put your current git branch in your shell prompt?&rdquo;)</li>
<li>what kinds of problems people run into with git (like &ldquo;have you lost work because of a git problem in the last year or two?&rdquo;)</li>
<li>which terminology people find confusing (like &ldquo;how confident do you feel that you know what HEAD means in git?&rdquo;)</li>
<li>how people think about various git concepts (&ldquo;how do you think about git branches?&rdquo;)</li>
<li>in what ways my usage of git is &ldquo;normal&rdquo; and in what ways it&rsquo;s &ldquo;weird&rdquo;. Where am I pretty similar to the majority of people, and where am I different?</li>
</ul>
<p>It&rsquo;s been a lot of fun and some of the results have been surprising to me, so
here are some of the results. I&rsquo;m partly just posting these so that I can have
them all in one place for myself to refer to, but maybe some of you will find
them interesting too.</p>
<h3 id="these-polls-are-highly-unscientific">these polls are highly unscientific</h3>
<p>Polls on social media that I thought about for approximately 45 seconds before
posting are not the most rigorous way of doing user research, so I&rsquo;m pretty
cautious about drawing conclusions from them. Potential problems include: I
phrased the poll badly, the set of possible responses aren&rsquo;t chosen very
carefully, some of the poll responses I just picked because I thought they were
funny, and the set of people who follow me on Mastodon is not representative of
all git users.</p>
<p>But here are a couple of examples of why I still find these poll results useful:</p>
<ul>
<li>The first poll is &ldquo;what&rsquo;s your approach to merge commits and rebase in git&rdquo;?
600 people (30% of responders) replied &ldquo;I usually use merge, rarely/never
rebase&rdquo;. It&rsquo;s helpful for me to know that there are a lot of people
out there who rarely/never use rebase, because I use rebase all the time &ndash;
it&rsquo;s a good reminder that my experiences isn&rsquo;t necessarily representative.</li>
<li>For the poll &ldquo;how confident do you feel that you know what HEAD means in
git?&rdquo;, 14% of people replied &ldquo;literally no idea&rdquo;. That tells me to be careful
about assuming that people know what <code>HEAD</code> means in my writing.</li>
</ul>
<h3 id="where-to-read-more">where to read more</h3>
<p>If you want to read more about any given poll, you can click at the date at the
bottom &ndash; there&rsquo;s usually a bunch of interesting follow-up discussion.</p>
<p>Also this post has a lot of CSS so it might not work well in a feed reader.</p>
<p>Now! Here are the polls! I&rsquo;m mostly just going to post the results without
commenting on them.</p>
<h3 id="merge-and-rebase">merge and rebase</h3>
<div class="poll-wrapper" lang="en"><p>poll: what's your approach to merge commits and rebase in git?</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"2964","expires_at":"2023-12-15T21:06:54.095Z","expired":true,"multiple":false,"votes_count":1872,"voters_count":1872,"options":[{"title":"usually rebase, rarely/never create merge commits","votes_count":771},{"title":"usually merge, rarely/never rebase","votes_count":553},{"title":"i do both all the time","votes_count":455},{"title":"other / show results","votes_count":93}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">41%</span><span class="poll_option_text">usually rebase, rarely/never create merge commits</span></label><progress aria-hidden="true" max="100" value="41"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">29%</span><span class="poll_option_text">usually merge, rarely/never rebase</span></label><progress aria-hidden="true" max="100" value="29"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">24%</span><span class="poll_option_text">i do both all the time</span></label><progress aria-hidden="true" max="100" value="24"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">4%</span><span class="poll_option_text">other / show results</span></label><progress aria-hidden="true" max="100" value="4"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1872 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/111580808091928044" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2023-12-14T21:06:54Z" title="Dec 14, 2023, 21:06">Dec 14, 2023, 21:06</time></a></div></div></div></div>
<h3 id="merge-conflicts">merge conflicts</h3>
<div class="poll-wrapper" lang="en"><p>poll: if you use git, how often do you deal with nontrivial merge conflicts? (like where 2 people were really editing the same code at the same time and you need to take time to think about how to reconcile the edits)</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3063","expires_at":"2024-01-04T18:43:50.229Z","expired":true,"multiple":false,"votes_count":2009,"voters_count":2009,"options":[{"title":"~every week or so","votes_count":212},{"title":"~every month or so","votes_count":664},{"title":"very rarely/never (a few times a year at most)","votes_count":1047},{"title":"other/show results","votes_count":86}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">10%</span><span class="poll_option_text">~every week or so</span></label><progress aria-hidden="true" max="100" value="10"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">33%</span><span class="poll_option_text">~every month or so</span></label><progress aria-hidden="true" max="100" value="33"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">52%</span><span class="poll_option_text">very rarely/never (a few times a year at most)</span></label><progress aria-hidden="true" max="100" value="52"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">4%</span><span class="poll_option_text">other/show results</span></label><progress aria-hidden="true" max="100" value="4"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>2009 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/111693491747888221" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-01-03T18:43:50Z" title="Jan 03, 2024, 18:43">Jan 03, 2024, 18:43</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>another merge conflict poll:</p><p>have you ever seen a bug in production caused by an incorrect merge conflict resolution? I've heard about this as a reason to prefer merges over rebase (because it makes the merge conflict resolution easier to audit) and I'm curious about how common it is</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3064","expires_at":"2024-01-04T19:00:03.339Z","expired":true,"multiple":false,"votes_count":1482,"voters_count":1482,"options":[{"title":"yes, many times","votes_count":214},{"title":"yes, but only once or twice","votes_count":701},{"title":"no","votes_count":479},{"title":"other/show results","votes_count":88}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">14%</span><span class="poll_option_text">yes, many times</span></label><progress aria-hidden="true" max="100" value="14"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">47%</span><span class="poll_option_text">yes, but only once or twice</span></label><progress aria-hidden="true" max="100" value="47"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">32%</span><span class="poll_option_text">no</span></label><progress aria-hidden="true" max="100" value="32"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">5%</span><span class="poll_option_text">other/show results</span></label><progress aria-hidden="true" max="100" value="5"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1482 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/111693554375140434" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-01-03T18:59:45Z" title="Jan 03, 2024, 18:59">Jan 03, 2024, 18:59</time></a></div></div></div></div>
<p>I thought it was interesting in the next one that &ldquo;edit the weird text file by hand&rdquo; was most people&rsquo;s preference:</p>
<div class="poll-wrapper" lang="en"><p>poll: when you have a merge conflict, how do you prefer to handle it?</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3293","expires_at":"2024-02-23T15:17:33.601Z","expired":true,"multiple":false,"votes_count":2380,"voters_count":2380,"options":[{"title":"edit the weird text file by hand","votes_count":1400},{"title":"use a merge conflict tool","votes_count":815},{"title":"delete your work and start over","votes_count":123},{"title":"other","votes_count":42}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">58%</span><span class="poll_option_text">edit the weird text file by hand</span></label><progress aria-hidden="true" max="100" value="58"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">34%</span><span class="poll_option_text">use a merge conflict tool</span></label><progress aria-hidden="true" max="100" value="34"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">5%</span><span class="poll_option_text">delete your work and start over</span></label><progress aria-hidden="true" max="100" value="5"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">1%</span><span class="poll_option_text">other</span></label><progress aria-hidden="true" max="100" value="1"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>2380 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/111975796153138514" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-02-22T15:17:33Z" title="Feb 22, 2024, 15:17">Feb 22, 2024, 15:17</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>merge conflict follow up: if you prefer to edit the weird text file by hand instead of using a dedicated merge conflict tool, why is that?</p><div data-component="Poll" data-props="{&quot;disabled&quot;:true,&quot;poll&quot;:{&quot;id&quot;:&quot;3300&quot;,&quot;expires_at&quot;:&quot;2024-02-24T20:23:15.110Z&quot;,&quot;expired&quot;:true,&quot;multiple&quot;:false,&quot;votes_count&quot;:1093,&quot;voters_count&quot;:1093,&quot;options&quot;:[{&quot;title&quot;:&quot;most merge conflicts are simple&quot;,&quot;votes_count&quot;:263},{&quot;title&quot;:&quot;it's infrequent, not worth learning another tool&quot;,&quot;votes_count&quot;:256},{&quot;title&quot;:&quot;prefer to use my usual text editor&quot;,&quot;votes_count&quot;:425},{&quot;title&quot;:&quot;other&quot;,&quot;votes_count&quot;:149}],&quot;emojis&quot;:[]}}"><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">24%</span><span class="poll_option_text">most merge conflicts are simple</span></label><progress aria-hidden="true" max="100" value="24"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">23%</span><span class="poll_option_text">it's infrequent, not worth learning another tool</span></label><progress aria-hidden="true" max="100" value="23"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">38%</span><span class="poll_option_text">prefer to use my usual text editor</span></label><progress aria-hidden="true" max="100" value="38"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">13%</span><span class="poll_option_text">other</span></label><progress aria-hidden="true" max="100" value="13"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1093 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/111982657794956944" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-02-23T20:22:33Z" title="Feb 23, 2024, 20:22">Feb 23, 2024, 20:22</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>poll: did you know that in a git merge conflict, the order of the code is different when you do a merge/rebase?</p><p>merge:</p><p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD<br/>    YOUR CODE<br/>=======<br/>    OTHER BRANCH'S CODE<br/>&gt;&gt;&gt;&gt;&gt;&gt;&gt; c694cf8aabe</p><p>rebase:</p><p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD<br/>    OTHER BRANCH'S CODE<br/>=======<br/>    YOUR CODE<br/>&gt;&gt;&gt;&gt;&gt;&gt;&gt; d945752 (your commit message)</p><p>(where "YOUR CODE" is the code from the branch you were on when you ran `git merge` or `git rebase`)</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3674","expires_at":"2024-03-12T14:17:12.043Z","expired":true,"multiple":false,"votes_count":1511,"voters_count":1511,"options":[{"title":"yes","votes_count":232},{"title":"yes, mostly","votes_count":221},{"title":"no","votes_count":739},{"title":"what?","votes_count":319}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">15%</span><span class="poll_option_text">yes</span></label><progress aria-hidden="true" max="100" value="15"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">14%</span><span class="poll_option_text">yes, mostly</span></label><progress aria-hidden="true" max="100" value="14"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">48%</span><span class="poll_option_text">no</span></label><progress aria-hidden="true" max="100" value="48"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">21%</span><span class="poll_option_text">what?</span></label><progress aria-hidden="true" max="100" value="21"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1511 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112077480397781920" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-11T14:17:12Z" title="Mar 11, 2024, 14:17">Mar 11, 2024, 14:17</time></a></div></div></div></div>
<h3 id="git-pull">git pull</h3>
<div class="poll-wrapper" lang="en"><p>poll: do you prefer `git fetch` or `git pull`?</p><p>(no lectures about why you think `git pull` is bad please but if you use both I'd be curious to hear in what cases you use fetch!)</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3704","expires_at":"2024-03-19T20:09:34.706Z","expired":true,"multiple":false,"votes_count":2036,"voters_count":2036,"options":[{"title":"only `git fetch`","votes_count":252},{"title":"only `git pull`","votes_count":761},{"title":"mix of both","votes_count":995},{"title":"other","votes_count":28}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">12%</span><span class="poll_option_text">only `git fetch`</span></label><progress aria-hidden="true" max="100" value="12"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">37%</span><span class="poll_option_text">only `git pull`</span></label><progress aria-hidden="true" max="100" value="37"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">48%</span><span class="poll_option_text">mix of both</span></label><progress aria-hidden="true" max="100" value="48"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">1%</span><span class="poll_option_text">other</span></label><progress aria-hidden="true" max="100" value="1"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>2036 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112118493083676573" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-18T20:07:15Z" title="Mar 18, 2024, 20:07">Mar 18, 2024, 20:07</time></a></div></div></div></div>
<h3 id="commits">commits</h3>
<div class="poll-wrapper" lang="en"><p>[poll] how do you think of a git commit?</p><p>(sorry, you can't pick “it’s all 3”, I'm curious about which one feels most true to you)</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"2949","expires_at":"2023-12-12T18:18:26.015Z","expired":true,"multiple":false,"votes_count":2466,"voters_count":2466,"options":[{"title":"a **diff** from the previous commit","votes_count":1254},{"title":"a **snapshot** of the current state","votes_count":1046},{"title":"a **history** of every past commit","votes_count":94},{"title":"other/show results","votes_count":72}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">50%</span><span class="poll_option_text">a **diff** from the previous commit</span></label><progress aria-hidden="true" max="100" value="50"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">42%</span><span class="poll_option_text">a **snapshot** of the current state</span></label><progress aria-hidden="true" max="100" value="42"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">3%</span><span class="poll_option_text">a **history** of every past commit</span></label><progress aria-hidden="true" max="100" value="3"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">2%</span><span class="poll_option_text">other/show results</span></label><progress aria-hidden="true" max="100" value="2"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>2466 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/111563158717698550" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2023-12-11T18:18:26Z" title="Dec 11, 2023, 18:18">Dec 11, 2023, 18:18</time></a></div></div></div></div>
<h3 id="branches">branches</h3>
<div class="poll-wrapper" lang="en"><p>poll: how do you think about git branches? (I'll put an image in a reply with pictures for the 3 options)</p><p>as with all of these polls obviously all 3 are valid, I'm curious which one feels the most true to you</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3083","expires_at":"2024-01-07T14:28:23.877Z","expired":true,"multiple":false,"votes_count":1966,"voters_count":1966,"options":[{"title":"1. just the commits that \"branch\" off","votes_count":1151},{"title":"2. the history of every previous commit","votes_count":436},{"title":"3. just the commit at the end (\"branch = pointer\")","votes_count":311},{"title":"other / show results","votes_count":68}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">58%</span><span class="poll_option_text">1. just the commits that "branch" off</span></label><progress aria-hidden="true" max="100" value="58"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">22%</span><span class="poll_option_text">2. the history of every previous commit</span></label><progress aria-hidden="true" max="100" value="22"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">15%</span><span class="poll_option_text">3. just the commit at the end ("branch = pointer")</span></label><progress aria-hidden="true" max="100" value="15"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">3%</span><span class="poll_option_text">other / show results</span></label><progress aria-hidden="true" max="100" value="3"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1966 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/111709458396281239" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-01-06T14:24:21Z" title="Jan 06, 2024, 14:24">Jan 06, 2024, 14:24</time></a></div></div></div></div>
<h3 id="git-environment">git environment</h3>
<div class="poll-wrapper" lang="en"><p>poll: do you put your current git branch in your shell prompt?</p><div data-component="Poll" data-props="{&quot;disabled&quot;:true,&quot;poll&quot;:{&quot;id&quot;:&quot;3145&quot;,&quot;expires_at&quot;:&quot;2024-01-19T15:38:52.396Z&quot;,&quot;expired&quot;:true,&quot;multiple&quot;:false,&quot;votes_count&quot;:2365,&quot;voters_count&quot;:2365,&quot;options&quot;:[{&quot;title&quot;:&quot;yes&quot;,&quot;votes_count&quot;:1697},{&quot;title&quot;:&quot;no&quot;,&quot;votes_count&quot;:533},{&quot;title&quot;:&quot;no, but I don't use git on the command line&quot;,&quot;votes_count&quot;:94},{&quot;title&quot;:&quot;other/show results&quot;,&quot;votes_count&quot;:41}],&quot;emojis&quot;:[]}}"><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">71%</span><span class="poll_option_text">yes</span></label><progress aria-hidden="true" max="100" value="71"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">22%</span><span class="poll_option_text">no</span></label><progress aria-hidden="true" max="100" value="22"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">3%</span><span class="poll_option_text">no, but I don't use git on the command line</span></label><progress aria-hidden="true" max="100" value="3"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">1%</span><span class="poll_option_text">other/show results</span></label><progress aria-hidden="true" max="100" value="1"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>2365 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/111777697732765132" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-01-18T15:38:31Z" title="Jan 18, 2024, 15:38">Jan 18, 2024, 15:38</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>poll: do you use git on the command line or in a GUI? </p><p>(you can pick more than one option if it’s a mix of both, sorry magit users I didn't have space for you in this poll)</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3617","expires_at":"2024-03-01T13:22:00.512Z","expired":true,"multiple":true,"votes_count":3689,"voters_count":2661,"options":[{"title":"command line, regularly","votes_count":2129},{"title":"GUI, regularly","votes_count":773},{"title":"command line, occasionally","votes_count":349},{"title":"GUI, occasionally","votes_count":438}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">80%</span><span class="poll_option_text">command line, regularly</span></label><progress aria-hidden="true" max="100" value="80"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">29%</span><span class="poll_option_text">GUI, regularly</span></label><progress aria-hidden="true" max="100" value="29"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">13%</span><span class="poll_option_text">command line, occasionally</span></label><progress aria-hidden="true" max="100" value="13"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">16%</span><span class="poll_option_text">GUI, occasionally</span></label><progress aria-hidden="true" max="100" value="16"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>2661 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112014805256252757" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-02-29T12:38:05Z" title="Feb 29, 2024, 12:38">Feb 29, 2024, 12:38</time></a></div></div></div></div>
<h3 id="losing-work">losing work</h3>
<div class="poll-wrapper" lang="en"><p>poll: have you lost work because of a git problem in the last year or two? (it counts even if it was "your fault" :))</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3263","expires_at":"2024-02-15T15:00:00.750Z","expired":true,"multiple":false,"votes_count":1475,"voters_count":1475,"options":[{"title":"yes","votes_count":262},{"title":"no","votes_count":1127},{"title":"no, but git did something else unforgivable","votes_count":70},{"title":"other","votes_count":16}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">17%</span><span class="poll_option_text">yes</span></label><progress aria-hidden="true" max="100" value="17"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">76%</span><span class="poll_option_text">no</span></label><progress aria-hidden="true" max="100" value="76"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">4%</span><span class="poll_option_text">no, but git did something else unforgivable</span></label><progress aria-hidden="true" max="100" value="4"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">1%</span><span class="poll_option_text">other</span></label><progress aria-hidden="true" max="100" value="1"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1475 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/111930248586728989" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-02-14T14:14:12Z" title="Feb 14, 2024, 14:14">Feb 14, 2024, 14:14</time></a></div></div></div></div>
<h3 id="meaning-of-various-git-terms">meaning of various git terms</h3>
<p>These polls gave me the impression that for a lot of git terms (fast-forward,
reference, HEAD), there are a lot of git users who have &ldquo;literally no idea&rdquo;
what they mean. That makes me want to be careful about using and defining those
terms.</p>
<div class="poll-wrapper" lang="en"><p>poll: how confident do you feel that you know what HEAD means in git?</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3650","expires_at":"2024-03-07T15:02:59.867Z","expired":true,"multiple":false,"votes_count":1783,"voters_count":1783,"options":[{"title":"100%","votes_count":187},{"title":"pretty confident","votes_count":645},{"title":"somewhat confident?","votes_count":690},{"title":"literally no idea","votes_count":261}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">10%</span><span class="poll_option_text">100%</span></label><progress aria-hidden="true" max="100" value="10"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">36%</span><span class="poll_option_text">pretty confident</span></label><progress aria-hidden="true" max="100" value="36"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">38%</span><span class="poll_option_text">somewhat confident?</span></label><progress aria-hidden="true" max="100" value="38"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">14%</span><span class="poll_option_text">literally no idea</span></label><progress aria-hidden="true" max="100" value="14"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1783 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112049348927204770" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-06T15:02:59Z" title="Mar 06, 2024, 15:02">Mar 06, 2024, 15:02</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>another poll: how do you think of HEAD in git?</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3651","expires_at":"2024-03-07T17:57:24.734Z","expired":true,"multiple":false,"votes_count":1386,"voters_count":1386,"options":[{"title":"a pointer to the current commit","votes_count":939},{"title":"a pointer to the current branch (usually)","votes_count":357},{"title":"other","votes_count":90}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">67%</span><span class="poll_option_text">a pointer to the current commit</span></label><progress aria-hidden="true" max="100" value="67"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">25%</span><span class="poll_option_text">a pointer to the current branch (usually)</span></label><progress aria-hidden="true" max="100" value="25"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">6%</span><span class="poll_option_text">other</span></label><progress aria-hidden="true" max="100" value="6"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1386 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112050034752815560" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-06T17:57:24Z" title="Mar 06, 2024, 17:57">Mar 06, 2024, 17:57</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>poll: when you see this message in `git status`:</p><p>”Your branch is up to date with 'origin/main’.”</p><p>do you know that your branch may not actually be up to date with the `main` branch on the remote?</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3663","expires_at":"2024-03-09T19:04:23.709Z","expired":true,"multiple":false,"votes_count":2332,"voters_count":2332,"options":[{"title":"yes","votes_count":1482},{"title":"mostly yes","votes_count":365},{"title":"no","votes_count":174},{"title":"what?","votes_count":311}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">63%</span><span class="poll_option_text">yes</span></label><progress aria-hidden="true" max="100" value="63"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">15%</span><span class="poll_option_text">mostly yes</span></label><progress aria-hidden="true" max="100" value="15"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">7%</span><span class="poll_option_text">no</span></label><progress aria-hidden="true" max="100" value="7"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">13%</span><span class="poll_option_text">what?</span></label><progress aria-hidden="true" max="100" value="13"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>2332 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112061622761219585" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-08T19:04:23Z" title="Mar 08, 2024, 19:04">Mar 08, 2024, 19:04</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>poll: how confident do you feel that you know what the term "fast-forward" means in git, for example in this error message:</p><p>`! [rejected]        main -&gt; main (non-fast-forward)`</p><p>or this one:</p><p>fatal: Not possible to fast-forward, aborting.</p><p>(I promise this is not a trick question, I'm just writing a blog post about git terminology and I'm trying to gauge how people feel about various core git terms)</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3678","expires_at":"2024-03-12T18:00:38.867Z","expired":true,"multiple":false,"votes_count":1629,"voters_count":1629,"options":[{"title":"100%","votes_count":421},{"title":"pretty confident","votes_count":515},{"title":"somewhat confident?","votes_count":342},{"title":"literally no idea","votes_count":351}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">25%</span><span class="poll_option_text">100%</span></label><progress aria-hidden="true" max="100" value="25"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">31%</span><span class="poll_option_text">pretty confident</span></label><progress aria-hidden="true" max="100" value="31"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">20%</span><span class="poll_option_text">somewhat confident?</span></label><progress aria-hidden="true" max="100" value="20"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">21%</span><span class="poll_option_text">literally no idea</span></label><progress aria-hidden="true" max="100" value="21"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1629 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112078355085525822" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-11T17:59:38Z" title="Mar 11, 2024, 17:59">Mar 11, 2024, 17:59</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>poll: how confident do you feel that you know what a "ref" or "reference" is in git? (“ref” and “reference” are the same thing)</p><p>for example in this error message (from `git push`)</p><p>error: failed to push some refs to 'github.com:jvns/int-exposed'</p><p>or this one:  (from `git switch mybranch`)</p><p>fatal: invalid reference: mybranch</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3683","expires_at":"2024-03-14T13:41:22.022Z","expired":true,"multiple":false,"votes_count":1117,"voters_count":1117,"options":[{"title":"100%","votes_count":111},{"title":"pretty confident","votes_count":323},{"title":"somewhat confident?","votes_count":356},{"title":"literally no idea","votes_count":327}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">9%</span><span class="poll_option_text">100%</span></label><progress aria-hidden="true" max="100" value="9"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">28%</span><span class="poll_option_text">pretty confident</span></label><progress aria-hidden="true" max="100" value="28"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">31%</span><span class="poll_option_text">somewhat confident?</span></label><progress aria-hidden="true" max="100" value="31"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">29%</span><span class="poll_option_text">literally no idea</span></label><progress aria-hidden="true" max="100" value="29"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1117 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112088664114767341" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-13T13:41:22Z" title="Mar 13, 2024, 13:41">Mar 13, 2024, 13:41</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>another git terminology poll: how confident do you feel that you know what a git commit is?</p><p>(not a trick question, I'm mostly curious how this one relates to people's reported confidence about more "advanced" terms like reference/fast-forward/HEAD)</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3693","expires_at":"2024-03-16T13:21:13.403Z","expired":true,"multiple":false,"votes_count":1294,"voters_count":1294,"options":[{"title":"100%","votes_count":427},{"title":"pretty confident","votes_count":649},{"title":"somewhat confident?","votes_count":198},{"title":"literally no idea","votes_count":20}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">32%</span><span class="poll_option_text">100%</span></label><progress aria-hidden="true" max="100" value="32"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">50%</span><span class="poll_option_text">pretty confident</span></label><progress aria-hidden="true" max="100" value="50"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">15%</span><span class="poll_option_text">somewhat confident?</span></label><progress aria-hidden="true" max="100" value="15"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">1%</span><span class="poll_option_text">literally no idea</span></label><progress aria-hidden="true" max="100" value="1"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1294 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112099886480664238" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-15T13:15:21Z" title="Mar 15, 2024, 13:15">Mar 15, 2024, 13:15</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>poll: in git, do you think of "detached HEAD state" and "not having any branch checked out" as being the same thing?</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3723","expires_at":"2024-03-22T18:35:27.580Z","expired":true,"multiple":false,"votes_count":1278,"voters_count":1278,"options":[{"title":"yes","votes_count":676},{"title":"no","votes_count":346},{"title":"what?","votes_count":223},{"title":"other","votes_count":33}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">52%</span><span class="poll_option_text">yes</span></label><progress aria-hidden="true" max="100" value="52"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">27%</span><span class="poll_option_text">no</span></label><progress aria-hidden="true" max="100" value="27"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">17%</span><span class="poll_option_text">what?</span></label><progress aria-hidden="true" max="100" value="17"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">2%</span><span class="poll_option_text">other</span></label><progress aria-hidden="true" max="100" value="2"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1278 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112135116065832096" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-21T18:34:42Z" title="Mar 21, 2024, 18:34">Mar 21, 2024, 18:34</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>poll: how confident do you feel that you know what the term "current branch" means in git?</p><p>(deleted &amp; reposted to clarify that I'm asking about the meaning of the term)</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3725","expires_at":"2024-03-22T19:25:55.325Z","expired":true,"multiple":false,"votes_count":1282,"voters_count":1282,"options":[{"title":"100%","votes_count":346},{"title":"pretty confident","votes_count":640},{"title":"somewhat confident?","votes_count":235},{"title":"literally no idea","votes_count":61}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">26%</span><span class="poll_option_text">100%</span></label><progress aria-hidden="true" max="100" value="26"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">49%</span><span class="poll_option_text">pretty confident</span></label><progress aria-hidden="true" max="100" value="49"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">18%</span><span class="poll_option_text">somewhat confident?</span></label><progress aria-hidden="true" max="100" value="18"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">4%</span><span class="poll_option_text">literally no idea</span></label><progress aria-hidden="true" max="100" value="4"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1282 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112135312540813733" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-21T19:24:40Z" title="Mar 21, 2024, 19:24">Mar 21, 2024, 19:24</time></a></div></div></div></div>
<h3 id="other-version-control-systems">other version control systems</h3>
<p>I occasionally hear &ldquo;SVN was better than git!&rdquo; but this &ldquo;svn vs git&rdquo; poll makes
me think that&rsquo;s a minority opinion. I&rsquo;m much more cautious about concluding anything from the hg-vs-git poll but it does seem like some people prefer git
and some people prefer Mercurial.</p>
<div class="poll-wrapper" lang="en"><p>poll 2: if you've used both svn and git, which do you prefer?</p><p>(no replies please, i have already read 300 comments about git vs other version control systems today and they were great but i can't read more)</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3707","expires_at":"2024-03-20T21:16:21.033Z","expired":true,"multiple":false,"votes_count":1642,"voters_count":1642,"options":[{"title":"svn","votes_count":58},{"title":"git","votes_count":1507},{"title":"depends","votes_count":53},{"title":"other","votes_count":24}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">3%</span><span class="poll_option_text">svn</span></label><progress aria-hidden="true" max="100" value="3"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">91%</span><span class="poll_option_text">git</span></label><progress aria-hidden="true" max="100" value="91"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">3%</span><span class="poll_option_text">depends</span></label><progress aria-hidden="true" max="100" value="3"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">1%</span><span class="poll_option_text">other</span></label><progress aria-hidden="true" max="100" value="1"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>1642 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112124427045371322" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-19T21:16:21Z" title="Mar 19, 2024, 21:16">Mar 19, 2024, 21:16</time></a></div></div></div></div>
<div class="poll-wrapper" lang="en"><p>gonna do a short thread of git vs other version control systems polls just to get an overall vibe </p><p>poll 1: if you've used both hg and git, which do you prefer?</p><p>(no replies please though, i have already read 300 comments about git vs other version control systems today and i can't read more)</p><div data-component="Poll" data-props='{"disabled":true,"poll":{"id":"3706","expires_at":"2024-03-20T21:15:27.134Z","expired":true,"multiple":false,"votes_count":684,"voters_count":684,"options":[{"title":"hg","votes_count":146},{"title":"git","votes_count":448},{"title":"depends","votes_count":53},{"title":"other","votes_count":37}],"emojis":[]}}'><div class="poll"><ul><li><label class="poll_option"><span class="poll_number">21%</span><span class="poll_option_text">hg</span></label><progress aria-hidden="true" max="100" value="21"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">65%</span><span class="poll_option_text">git</span></label><progress aria-hidden="true" max="100" value="65"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">7%</span><span class="poll_option_text">depends</span></label><progress aria-hidden="true" max="100" value="7"><span class="poll_chart"></span></progress></li><li><label class="poll_option"><span class="poll_number">5%</span><span class="poll_option_text">other</span></label><progress aria-hidden="true" max="100" value="5"><span class="poll_chart"></span></progress></li></ul><div class="poll_footer"><span>684 people</span> · <a class="detailed-status_datetime u-url u-uid" href="https://social.jvns.ca/@b0rk/112124423512955698" rel="noopener noreferrer" target="_blank"><time class="formatted" datetime="2024-03-19T21:15:27Z" title="Mar 19, 2024, 21:15">Mar 19, 2024, 21:15</time></a></div></div></div></div>
<h3 id="that-s-all">that&rsquo;s all!</h3>
<p>It&rsquo;s been very fun to run all of these polls and I&rsquo;ve learned a lot about how
people use and think about git.</p>
<style>
.poll-wrapper {
  background-color: #ecedf0;
  border-radius: 5px;
  padding: 1rem;
  margin: 1rem 0;
}
.poll p, .poll_footer p {
  margin: 0;
}
.poll-wrapper a {
  color: #444b5d;
  font-size: 14px;
}
.poll-wrapper a:hover {
  text-decoration: underline;
}
progress {
  width: 100%;
}
.poll ul {
  list-style: none;
  margin: 0;
}
.poll-wrapper span {
  padding: 0;
}
.poll li {
  margin-bottom: 10px;
  position: relative;
}
.poll_option_text {
  word-wrap: break-word;
  display: inline-block;
  max-width: calc(100% - 70px);
  overflow-wrap: break-word;
}
.poll_number {
  display: inline-block;
  flex: 0 0 45px;
  font-weight: 700;
  width: 45px;
}
.poll_option {
  cursor: default;
  display: flex;
  line-height: 18px;
  overflow: hidden;
  padding: 6px 0;
  position: relative;
}
.poll_chart {
  background: #b1d6f1;
  border-radius: 4px;
  display: block;
  height: 5px;
  min-width: 1%;
}
.poll_chart.leading {
  background: #858afa;
}
.poll {
  font-size: 14px;
  margin-top: 16px;
}
.poll_footer {
  color: #444b5d;
  padding-bottom: 5px;
  padding-top: 6px;
}
</style>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The "current branch" in git]]></title>
    <link href="https://jvns.ca/blog/2024/03/22/the-current-branch-in-git/"/>
    <updated>2024-03-22T08:15:02+00:00</updated>
    <id>https://jvns.ca/blog/2024/03/22/the-current-branch-in-git/</id>
    <content type="html"><![CDATA[<p>Hello! I know I just wrote <a href="https://jvns.ca/blog/2024/03/08/how-head-works-in-git/">a blog post about HEAD in git</a>, but I&rsquo;ve been
thinking more about what the term &ldquo;current branch&rdquo; means in git and it&rsquo;s a
little weirder than I thought.</p>
<h3 id="four-possible-definitions-for-current-branch">four possible definitions for &ldquo;current branch&rdquo;</h3>
<ol>
<li>It&rsquo;s what&rsquo;s in the file <strong><code>.git/HEAD</code></strong>. This is how the <a href="https://git-scm.com/docs/gitglossary#def_HEAD">git glossary</a> defines it.</li>
<li>It&rsquo;s what <strong><code>git status</code></strong> says on the first line</li>
<li>It&rsquo;s what you most recently <strong>checked out</strong> with <code>git checkout</code> or <code>git switch</code></li>
<li>It&rsquo;s what&rsquo;s in your shell&rsquo;s <strong>git prompt</strong>. I use <a href="https://fishshell.com/docs/current/cmds/fish_git_prompt.html">fish_git_prompt</a> so that&rsquo;s what I&rsquo;ll be talking about.</li>
</ol>
<p>I originally thought that these 4 definitions were all more or less the
same, but after chatting with some people on Mastodon, I realized that they&rsquo;re
more different from each other than I thought.</p>
<p>So let&rsquo;s talk about a few git scenarios and how each of these definitions plays
out in each of them. I used git version <code>2.39.2 (Apple Git-143)</code> for all of these experiments.</p>
<h3 id="scenario-1-right-after-git-checkout-main">scenario 1: right after <code>git checkout main</code></h3>
<p>Here&rsquo;s the most normal situation: you check out a branch.</p>
<ol>
<li><code>.git/HEAD</code> contains <code>ref: refs/heads/main</code></li>
<li><code>git status</code> says <code>On branch main</code></li>
<li>The thing I most recently checked out was: <code>main</code></li>
<li>My shell&rsquo;s git prompt says: <code>(main)</code></li>
</ol>
<p>In this case the 4 definitions all match up: they&rsquo;re all <code>main</code>. Simple enough.</p>
<h3 id="scenario-2-right-after-git-checkout-775b2b399">scenario 2: right after <code>git checkout 775b2b399</code></h3>
<p>Now let&rsquo;s imagine I check out a specific commit ID (so that we&rsquo;re in &ldquo;detached HEAD state&rdquo;).</p>
<ol>
<li><code>.git/HEAD</code> contains <code>775b2b399fb8b13ee3341e819f2aaa024a37fa92</code></li>
<li><code>git status</code> says <code>HEAD detached at 775b2b39</code></li>
<li>The thing I most recently checked out was <code>775b2b399</code></li>
<li>My shell&rsquo;s git prompt says <code>((775b2b39))</code></li>
</ol>
<p>Again, these all basically match up &ndash; some of them have truncated the commit
ID and some haven&rsquo;t, but that&rsquo;s it. Let&rsquo;s move on.</p>
<h3 id="scenario-3-right-after-git-checkout-v1-0-13">scenario 3: right after <code>git checkout v1.0.13</code></h3>
<p>What if we&rsquo;ve checked out a tag, instead of a branch or commit ID?</p>
<ol>
<li><code>.git/HEAD</code> contains <code>ca182053c7710a286d72102f4576cf32e0dafcfb</code></li>
<li><code>git status</code> says <code>HEAD detached at v1.0.13</code></li>
<li>The thing I most recently checked out was <code>v1.0.13</code></li>
<li>My shell&rsquo;s git prompt says <code>((v1.0.13))</code></li>
</ol>
<p>Now things start to get a bit weirder! <code>.git/HEAD</code> disagrees with the other 3
indicators: <code>git status</code>, the git prompt, and what I checked out are all the
same (<code>v1.0.13</code>), but <code>.git/HEAD</code> contains a commit ID.</p>
<p>The reason for this is that git is trying to help us out: commit IDs are kind
of opaque, so if there&rsquo;s a tag that corresponds to the current commit, <code>git status</code> will show us that instead.</p>
<p>Some notes about this:</p>
<ul>
<li>If we check out the commit by its ID (<code>git checkout ca182053c7710a286d72</code>)
instead of by its tag, what shows up in <code>git status</code> and in my shell prompt
are exactly the same &ndash; git doesn&rsquo;t actually &ldquo;know&rdquo; that we checked out a
tag.</li>
<li>it looks like you can find the tags matching <code>HEAD</code> by running <code>git describe HEAD --tags --exact-match</code> (here&rsquo;s the <a href="https://github.com/fish-shell/fish-shell/blob/a5156e9e0e89bff2bd81ac945a019bad34f14346/share/functions/fish_git_prompt.fish#L521-L527">fish git prompt code</a>)</li>
<li>You can see where <code>git-prompt.sh</code> added support for describing a commit by a
tag in this way in commit <a href="https://github.com/git/git/commit/27c578885a0b8f56430c5a24f558e2b45cf04a38">27c578885 in 2008</a>.</li>
<li>I don&rsquo;t know if it makes a difference whether the tag is annotated or not.</li>
<li>If there are 2 tags with the same commit ID, it gets a little weird. For
example, if I add the tag <code>v1.0.12</code> to this commit so that it&rsquo;s with both <code>v1.0.12</code> and <code>v1.0.13</code>, you can
see here that my git prompt changes, and then the prompt and <code>git status</code>
disagree about which tag to display:</li>
</ul>
<pre><code>bork@grapefruit ~/w/int-exposed ((v1.0.12))&gt; git status
HEAD detached at v1.0.13
</code></pre>
<p>(my prompt shows <code>v1.0.12</code> and <code>git status</code> shows <code>v1.0.13</code>)</p>
<h3 id="scenario-4-in-the-middle-of-a-rebase">scenario 4: in the middle of a rebase</h3>
<p>Now: what if I check out the <code>main</code> branch, do a rebase, but then there was a
merge conflict in the middle of the rebase? Here&rsquo;s the situation:</p>
<ol>
<li><code>.git/HEAD</code> contains <code>c694cf8aabe2148b2299a988406f3395c0461742</code> (the commit ID of the commit that I&rsquo;m rebasing onto, <code>origin/main</code> in this case)</li>
<li><code>git status</code> says <code>interactive rebase in progress; onto c694cf8</code></li>
<li>The thing I most recently checked out was <code>main</code></li>
<li>My shell&rsquo;s git prompt says <code>(main|REBASE-i 1/1)</code></li>
</ol>
<p>Some notes about this:</p>
<ul>
<li>I think that in some sense the &ldquo;current branch&rdquo; is <code>main</code> here &ndash; it&rsquo;s what I most recently checked out, it&rsquo;s what we&rsquo;ll go back to after the rebase is done, and it&rsquo;s where we&rsquo;d go back to if I run <code>git rebase --abort</code></li>
<li>in another sense, we&rsquo;re in a detached HEAD state at <code>c694cf8aabe2</code>. But it doesn&rsquo;t have the usual implications of being in &ldquo;detached HEAD state&rdquo; &ndash; if you make a commit, it won&rsquo;t get orphaned! Instead, assuming you finish the rebase, it&rsquo;ll get absorbed into the rebase and put somewhere in the middle of your branch.</li>
<li>it looks like during the rebase, the old &ldquo;current branch&rdquo; (<code>main</code>) is stored in <code>.git/rebase-merge/head-name</code>. Not totally sure about this though.</li>
</ul>
<h3 id="scenario-5-right-after-git-init">scenario 5: right after <code>git init</code></h3>
<p>What about when we create an empty repository with <code>git init</code>?</p>
<ol>
<li><code>.git/HEAD</code> contains <code>ref: refs/heads/main</code></li>
<li><code>git status</code> says <code>On branch main</code> (and &ldquo;No commits yet&rdquo;)</li>
<li>The thing I most recently checked out was, well, nothing</li>
<li>My shell&rsquo;s git prompt says: <code>(main)</code></li>
</ol>
<p>So here everything mostly lines up, except that we&rsquo;ve never run <code>git checkout</code> or <code>git switch</code>. Basically Git automatically switches to whatever
branch was configured in <code>init.defaultBranch</code>.</p>
<h3 id="scenario-6-a-bare-git-repository">scenario 6: a bare git repository</h3>
<p>What if we clone a bare repository with <code>git clone --bare https://github.com/rbspy/rbspy</code>?</p>
<ol>
<li><code>HEAD</code> contains <code>ref: refs/heads/main</code></li>
<li><code>git status</code> says <code>fatal: this operation must be run in a work tree</code></li>
<li>The thing I most recently checked out was, well, nothing, <code>git checkout</code> doesn&rsquo;t even work in bare repositories</li>
<li>My shell&rsquo;s git prompt says: <code>(BARE:main)</code></li>
</ol>
<p>So #1 and #4 match (they both agree that the current branch is &ldquo;main&rdquo;), but <code>git status</code> and <code>git checkout</code> don&rsquo;t even work.</p>
<p>Some notes about this one:</p>
<ul>
<li>I think <code>HEAD</code> in a bare repository mainly only really affects 1 thing: it&rsquo;s the
branch that gets checked out when you clone the repository. It&rsquo;s also used when you run <code>git log</code>.</li>
<li>if you really want to, you can update <code>HEAD</code> in a bare repository to a
different branch with <code>git symbolic-ref HEAD refs/heads/whatever</code>. I&rsquo;ve never
needed to do that though and it seems weird because <code>git symbolic ref</code> doesn&rsquo;t check if the thing you&rsquo;re pointing <code>HEAD</code> at is
actually a branch that exists. Not sure if there&rsquo;s a better way.</li>
</ul>
<h3 id="all-the-results">all the results</h3>
<p>Here&rsquo;s a table with all of the results:</p>
<style>
table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.7rem;
}

th, td {
    border: 1px solid #dddddd;
    text-align: left;
    padding: 8px;
}

th {
    background-color: #dddddd;
  font-weight: bold;
}

tr:nth-child(even) {
    background-color: #f2f2f2;
}

tr td:first-child {
  font-weight: bold;
}
</style>
<table>
  <thead>
      <tr>
          <th style="text-align: left"></th>
          <th style="text-align: left"><code>.git/HEAD</code></th>
          <th style="text-align: left">git status</th>
          <th style="text-align: left">checked out</th>
          <th style="text-align: left">prompt</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">1. <code>checkout main</code></td>
          <td style="text-align: left"><code>ref: refs/heads/main</code></td>
          <td style="text-align: left"><code>On branch main</code></td>
          <td style="text-align: left">main</td>
          <td style="text-align: left"><code>(main)</code></td>
      </tr>
      <tr>
          <td style="text-align: left">2. <code>checkout 775b2b</code></td>
          <td style="text-align: left"><code>775b2b399...</code></td>
          <td style="text-align: left"><code>HEAD detached at 775b2b39</code></td>
          <td style="text-align: left">775b2b399</td>
          <td style="text-align: left"><code>((775b2b39))</code></td>
      </tr>
      <tr>
          <td style="text-align: left">3. <code>checkout v1.0.13</code></td>
          <td style="text-align: left"><code>ca182053c...</code></td>
          <td style="text-align: left"><code>HEAD detached at v1.0.13</code></td>
          <td style="text-align: left">v1.0.13</td>
          <td style="text-align: left"><code>((v1.0.13))</code></td>
      </tr>
      <tr>
          <td style="text-align: left">4. inside rebase</td>
          <td style="text-align: left"><code>c694cf8aa...</code></td>
          <td style="text-align: left"><code>interactive rebase in progress; onto c694cf8</code></td>
          <td style="text-align: left">main</td>
          <td style="text-align: left"><code>(main|REBASE-i 1/1)</code></td>
      </tr>
      <tr>
          <td style="text-align: left">5. after <code>git init</code></td>
          <td style="text-align: left"><code>ref: refs/heads/main</code></td>
          <td style="text-align: left"><code>On branch main</code></td>
          <td style="text-align: left">n/a</td>
          <td style="text-align: left"><code>(main)</code></td>
      </tr>
      <tr>
          <td style="text-align: left">6. bare repository</td>
          <td style="text-align: left"><code>ref: refs/heads/main</code></td>
          <td style="text-align: left"><code>fatal: this operation must be run in a work tree</code></td>
          <td style="text-align: left">n/a</td>
          <td style="text-align: left"><code>(BARE:main)</code></td>
      </tr>
  </tbody>
</table>
<h3 id="current-branch-doesn-t-seem-completely-well-defined">&ldquo;current branch&rdquo; doesn&rsquo;t seem completely well defined</h3>
<p>My original instinct when talking about git was to agree with the git glossary
and say that <code>HEAD</code> and the &ldquo;current branch&rdquo; mean the exact same thing.</p>
<p>But this doesn&rsquo;t seem as ironclad as I used to think anymore! Some thoughts:</p>
<ul>
<li><code>.git/HEAD</code> is definitely the one with the most consistent format &ndash; it&rsquo;s
always either a branch or a commit ID. The others are all much messier</li>
<li>I have a lot more sympathy than I used to for the definition &ldquo;the current
branch is whatever you last checked out&rdquo;. Git does a lot of work to remember
which branch you last checked out (even if you&rsquo;re currently doing a bisect or
a merge or something else that temporarily moves HEAD off of that branch) and
it feels weird to ignore that.</li>
<li><code>git status</code> gives a lot of helpful context &ndash; these 5 status messages say a
lot more than just what <code>HEAD</code> is set to currently
<ol>
<li><code>on branch main</code></li>
<li><code>HEAD detached at 775b2b39</code></li>
<li><code>HEAD detached at v1.0.13</code></li>
<li><code>interactive rebase in progress; onto c694cf8</code></li>
<li><code>on branch main, no commits yet</code></li>
</ol>
</li>
</ul>
<h3 id="some-more-current-branch-definitions">some more &ldquo;current branch&rdquo; definitions</h3>
<p>I&rsquo;m going to try to collect some other definitions of the term <code>current branch</code> that I heard from people on Mastodon here and write some notes on them.</p>
<ol>
<li>&ldquo;the branch that would be updated if i made a commit&rdquo;</li>
</ol>
<ul>
<li>Most of the time this is the same as <code>.git/HEAD</code></li>
<li>Arguably if you&rsquo;re in the middle of a rebase, it&rsquo;s different from <code>HEAD</code>,  because ultimately that new commit will end up on the branch in <code>.git/rebase-merge/head-name</code></li>
</ul>
<ol start="2">
<li>&ldquo;the branch most git operations work against&rdquo;</li>
</ol>
<ul>
<li>This is sort of the same as what&rsquo;s in <code>.git/HEAD</code>, except that some
operations (like <code>git status</code>) will behave differently in some situations,
like how <code>git status</code> won&rsquo;t tell you the current branch if you&rsquo;re in a bare
repository</li>
</ul>
<h3 id="on-orphaned-commits">on orphaned commits</h3>
<p>One thing I noticed that wasn&rsquo;t captured in any of this is whether the
current commit is <strong>orphaned</strong> or not &ndash; the <code>git status</code> message (<code>HEAD detached from c694cf8</code>) is the same whether or not your current commit is
orphaned.</p>
<p>I imagine this is because figuring out whether or not a given commit is
orphaned might take a long time in a large repository: you can find out if
the current commit is orphaned with <code>git branch --contains HEAD</code>, and that
command takes about 500ms in a repository with 70,000 commits.</p>
<p>Git will warn you if the commit is orphaned (&ldquo;Warning: you are leaving 1 commit
behind, not connected to any of your branches&hellip;&rdquo;) when you switch to a
different branch though.</p>
<h3 id="that-s-all">that&rsquo;s all!</h3>
<p>I don&rsquo;t have anything particularly smart to say about any of this. The more I
think about git the more I can understand why people get confused.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How HEAD works in git]]></title>
    <link href="https://jvns.ca/blog/2024/03/08/how-head-works-in-git/"/>
    <updated>2024-03-08T10:13:27+00:00</updated>
    <id>https://jvns.ca/blog/2024/03/08/how-head-works-in-git/</id>
    <content type="html"><![CDATA[<p>Hello! The other day I ran a Mastodon poll asking people how confident they
were that they understood how HEAD works in Git. The results (out of 1700
votes) were a little surprising to me:</p>
<ul>
<li>10% &ldquo;100%&rdquo;</li>
<li>36% &ldquo;pretty confident&rdquo;</li>
<li>39% &ldquo;somewhat confident?&rdquo;</li>
<li>15% &ldquo;literally no idea&rdquo;</li>
</ul>
<p>I was surprised that people were so unconfident about their understanding &ndash;
I&rsquo;d been thinking of <code>HEAD</code> as a pretty straightforward topic.</p>
<p>Usually when people say that a topic is confusing when I think it&rsquo;s not, the
reason is that there&rsquo;s actually some hidden complexity that I wasn&rsquo;t
considering. And after some follow up conversations, it turned out that <code>HEAD</code>
actually <em>was</em> a bit more complicated than I&rsquo;d appreciated!</p>
<p>Here&rsquo;s a quick table of contents:</p>
<ul>
<li><a href="#head-is-actually-a-few-different-things">HEAD is actually a few different things</a></li>
<li><a href="#the-file-git-head">the file .git/HEAD</a></li>
<li><a href="#head-as-in-git-show-head">HEAD as in git show HEAD</a></li>
<li><a href="#next-all-the-output-formats">next: all the output formats</a>
<ul>
<li><a href="#git-status-on-branch-main-or-head-detached">git status: &ldquo;on branch main&rdquo; or &ldquo;HEAD detached&rdquo;</a></li>
<li><a href="#detached-head-state">detached HEAD state</a></li>
<li><a href="#git-log-head-main">git log: (HEAD -&gt; main)</a></li>
<li><a href="#merge-conflicts-head-is-just-confusing">merge conflicts: &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD is just confusing</a></li>
</ul>
</li>
</ul>
<h3 id="head-is-actually-a-few-different-things">HEAD is actually a few different things</h3>
<p>After talking to a bunch of different people about <code>HEAD</code>, I realized that
<code>HEAD</code> actually has a few different closely related meanings:</p>
<ol>
<li>The file <code>.git/HEAD</code></li>
<li><code>HEAD</code> as in <code>git show HEAD</code> (git calls this a &ldquo;revision parameter&rdquo;)</li>
<li>All of the ways git uses <code>HEAD</code> in the output of various commands (<code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;HEAD</code>, <code>(HEAD -&gt; main)</code>, <code>detached HEAD state</code>, <code>On branch main</code>, etc)</li>
</ol>
<p>These are extremely closely related to each other, but I don&rsquo;t think the
relationship is totally obvious to folks who are starting out with git.</p>
<h3 id="the-file-git-head">the file <code>.git/HEAD</code></h3>
<p>Git has a very important file called <code>.git/HEAD</code>. The way this file works is that it contains either:</p>
<ol>
<li>The name of a <strong>branch</strong> (like <code>ref: refs/heads/main</code>)</li>
<li>A <strong>commit ID</strong> (like <code>96fa6899ea34697257e84865fefc56beb42d6390</code>)</li>
</ol>
<p>This file is what determines what your &ldquo;current branch&rdquo; is in Git. For example, when you run <code>git status</code> and see this:</p>
<pre><code>$ git status
On branch main
</code></pre>
<p>it means that the file <code>.git/HEAD</code> contains <code>ref: refs/heads/main</code>.</p>
<p>If <code>.git/HEAD</code> contains a commit ID instead of a branch, git calls that
&ldquo;detached HEAD state&rdquo;. We&rsquo;ll get to that later.</p>
<small>
<p>(People will sometimes say that HEAD contains a name of a <strong>reference</strong> or a
commit ID, but I&rsquo;m pretty sure that that the reference has to be a <strong>branch</strong>.
You <em>can</em> technically make <code>.git/HEAD</code> contain the name of a reference that
isn&rsquo;t a branch by manually editing <code>.git/HEAD</code>, but I don&rsquo;t think you can do it
with a regular git command. I&rsquo;d be interested to know if there is a
regular-git-command way to make .git/HEAD a non-branch reference though, and if
so why you might want to do that!)</p>
</small>
<h3 id="head-as-in-git-show-head"><code>HEAD</code> as in <code>git show HEAD</code></h3>
<p>It&rsquo;s very common to use <code>HEAD</code> in git commands to refer to a commit ID, like:</p>
<ul>
<li><code>git diff HEAD</code></li>
<li><code>git rebase -i HEAD^^^^</code></li>
<li><code>git diff main..HEAD</code></li>
<li><code>git reset --hard HEAD@{2}</code></li>
</ul>
<p>All of these things (<code>HEAD</code>, <code>HEAD^^^</code>, <code>HEAD@{2}</code>) are called &ldquo;revision parameters&rdquo;. They&rsquo;re documented in <a href="https://git-scm.com/docs/gitrevisions">man
gitrevisions</a>, and Git will try to
resolve them to a commit ID.</p>
<p>(I&rsquo;ve honestly never actually heard the term &ldquo;revision parameter&rdquo; before, but
that&rsquo;s the term that&rsquo;ll get you to the documentation for this concept)</p>
<p>HEAD in <code>git show HEAD</code> has a pretty simple meaning: it resolves to the
<strong>current commit</strong> you have checked out! Git resolves <code>HEAD</code> in one of two ways:</p>
<ol>
<li>if <code>.git/HEAD</code> contains a branch name, it&rsquo;ll be the latest commit on that branch (for example by reading it from <code>.git/refs/heads/main</code>)</li>
<li>if <code>.git/HEAD</code> contains a commit ID, it&rsquo;ll be that commit ID</li>
</ol>
<h3 id="next-all-the-output-formats">next: all the output formats</h3>
<p>Now we&rsquo;ve talked about the file <code>.git/HEAD</code>, and the &ldquo;revision parameter&rdquo;
<code>HEAD</code>, like in <code>git show HEAD</code>. We&rsquo;re left with all of the various ways git
uses <code>HEAD</code> in its output.</p>
<h3 id="git-status-on-branch-main-or-head-detached"><code>git status</code>: &ldquo;on branch main&rdquo; or &ldquo;HEAD detached&rdquo;</h3>
<p>When you run <code>git status</code>, the first line will always look like one of these two:</p>
<ol>
<li><code>on branch main</code>. This means that <code>.git/HEAD</code> contains a branch.</li>
<li><code>HEAD detached at 90c81c72</code>. This means that <code>.git/HEAD</code> contains a commit ID.</li>
</ol>
<p>I promised earlier I&rsquo;d explain what &ldquo;HEAD detached&rdquo; means, so let&rsquo;s do that now.</p>
<h3 id="detached-head-state">detached HEAD state</h3>
<p>&ldquo;HEAD is detached&rdquo; or &ldquo;detached HEAD state&rdquo; mean that you have no current branch.</p>
<p>Having no current branch is a little dangerous because if you make new commits,
those commits won&rsquo;t be attached to any branch &ndash; they&rsquo;ll be orphaned! Orphaned
commits are a problem for 2 reasons:</p>
<ol>
<li>the commits are more difficult to find (you can&rsquo;t run <code>git log somebranch</code> to find them)</li>
<li>orphaned commits will eventually be deleted by git&rsquo;s garbage collection</li>
</ol>
<p>Personally I&rsquo;m very careful about avoiding creating commits in detached HEAD state, though some people <a href="https://github.com/arxanas/git-branchless">prefer to work that way</a>.
Getting out of detached HEAD state is pretty easy though, you can either:</p>
<ol>
<li>Go back to a branch (<code>git checkout main</code>)</li>
<li>Create a new branch at that commit (<code>git checkout -b newbranch</code>)</li>
<li>If you&rsquo;re in detached HEAD state because you&rsquo;re in the middle of a rebase, finish or abort the rebase (<code>git rebase --abort</code>)</li>
</ol>
<p>Okay, back to other git commands which have <code>HEAD</code> in their output!</p>
<h3 id="git-log-head-main"><code>git log</code>: <code>(HEAD -&gt; main)</code></h3>
<p>When you run <code>git log</code> and look at the first line, you might see one of the following 3 things:</p>
<ol>
<li><code>commit 96fa6899ea (HEAD -&gt; main)</code></li>
<li><code>commit 96fa6899ea (HEAD, main)</code></li>
<li><code>commit 96fa6899ea (HEAD)</code></li>
</ol>
<p>It&rsquo;s not totally obvious how to interpret these, so here&rsquo;s the deal:</p>
<ul>
<li>inside the <code>(...)</code>, git lists every reference that points at that commit, for example <code>(HEAD -&gt; main, origin/main, origin/HEAD)</code> means <code>HEAD</code>, <code>main</code>, <code>origin/main</code>, and <code>origin/HEAD</code> all point at that commit (either directly or indirectly)</li>
<li><code>HEAD -&gt; main</code> means that your current branch is <code>main</code></li>
<li>If that line says <code>HEAD,</code> instead of <code>HEAD -&gt;</code>, it means you&rsquo;re in detached HEAD state (you have no current branch)</li>
</ul>
<p>if we use these rules to explain the 3 examples above: the result is:</p>
<ol>
<li><code>commit 96fa6899ea (HEAD -&gt; main)</code> means:
<ul>
<li><code>.git/HEAD</code> contains <code>ref: refs/heads/main</code></li>
<li><code>.git/refs/heads/main</code> contains <code>96fa6899ea </code></li>
</ul>
</li>
<li><code>commit 96fa6899ea (HEAD, main)</code> means:
<ul>
<li><code>.git/HEAD</code> contains <code>96fa6899ea</code> (HEAD is &ldquo;detached&rdquo;)</li>
<li><code>.git/refs/heads/main</code> also contains <code>96fa6899ea </code></li>
</ul>
</li>
<li><code>commit 96fa6899ea (HEAD)</code> means:
<ul>
<li><code>.git/HEAD</code> contains <code>96fa6899ea</code> (HEAD is &ldquo;detached&rdquo;)</li>
<li><code>.git/refs/heads/main</code> either contains a different commit ID or doesn&rsquo;t exist</li>
</ul>
</li>
</ol>
<h3 id="merge-conflicts-head-is-just-confusing">merge conflicts: <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</code> is just confusing</h3>
<p>When you&rsquo;re resolving a merge conflict, you might see something like this:</p>
<pre><code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
def parse(input):
    return input.split(&quot;\n&quot;)
=======
def parse(text):
    return text.split(&quot;\n\n&quot;)
&gt;&gt;&gt;&gt;&gt;&gt;&gt; somebranch
</code></pre>
<p>I find <code>HEAD</code> in this context extremely confusing and I basically just ignore it. Here&rsquo;s why.</p>
<ul>
<li>When you do a <strong>merge</strong>, <code>HEAD</code> in the merge conflict is the same as what <code>HEAD</code> was when you ran <code>git merge</code>. Simple.</li>
<li>When you do a <strong>rebase</strong>, <code>HEAD</code> in the merge conflict is something totally
different: it&rsquo;s the <strong>other commit</strong> that you&rsquo;re rebasing on top of. So it&rsquo;s
totally different from what <code>HEAD</code> was when you ran <code>git rebase</code>. It&rsquo;s like
this because rebase works by first checking out the other commit and then
repeatedly cherry-picking commits on top of it.</li>
</ul>
<p>Similarly, the meaning of &ldquo;ours&rdquo; and &ldquo;theirs&rdquo; are flipped in a merge and rebase.</p>
<p>The fact that the meaning of <code>HEAD</code> changes depending on whether I&rsquo;m doing a
rebase or merge is really just too confusing for me and I find it much simpler
to just ignore <code>HEAD</code> entirely and use another method to figure out which part
of the code is which.</p>
<h3 id="some-thoughts-on-consistent-terminology">some thoughts on consistent terminology</h3>
<p>I think HEAD would be more intuitive if git&rsquo;s terminology around HEAD were a
little more internally consistent.</p>
<p>For example, git talks about &ldquo;detached HEAD state&rdquo;, but never about &ldquo;attached
HEAD state&rdquo; &ndash; git&rsquo;s documentation never uses the term &ldquo;attached&rdquo; at all to
refer to <code>HEAD</code>. And git talks about being &ldquo;on&rdquo; a branch, but never &ldquo;not on&rdquo; a
branch.</p>
<p>So it&rsquo;s very hard to guess that <code>on branch main</code> is actually the opposite of
<code>HEAD detached</code>. How is the user supposed to guess that <code>HEAD detached</code> has
anything to do with branches at all, or that &ldquo;on branch main&rdquo; has anything to
do with <code>HEAD</code>?</p>
<h3 id="that-s-all">that&rsquo;s all!</h3>
<p>If I think of other ways <code>HEAD</code> is used in Git (especially ways HEAD appears in
Git&rsquo;s output), I might add them to this post later.</p>
<p>If you find HEAD confusing, I hope this helps a bit!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Popular git config options]]></title>
    <link href="https://jvns.ca/blog/2024/02/16/popular-git-config-options/"/>
    <updated>2024-02-16T10:42:27+00:00</updated>
    <id>https://jvns.ca/blog/2024/02/16/popular-git-config-options/</id>
    <content type="html"><![CDATA[<p>Hello! I always wish that command line tools came with data about how popular their various options are, like:</p>
<ul>
<li>&ldquo;basically nobody uses this one&rdquo;</li>
<li>&ldquo;80% of people use this, probably take a look&rdquo;</li>
<li>&ldquo;this one has 6 possible values but people only really use these 2 in practice&rdquo;</li>
</ul>
<p>So I <a href="https://social.jvns.ca/@b0rk/111885363143321068">asked about people&rsquo;s favourite git config options on Mastodon</a>:</p>
<blockquote>
<p>what are your favourite git config options to set? Right now I only really
have <code>git config push.autosetupremote true</code> and <code>git config init.defaultBranch main</code> set in my <code>~/.gitconfig</code>, curious about what other
people set</p>
</blockquote>
<p>As usual I got a TON of great answers and learned about a bunch of very popular
git config options that I&rsquo;d never heard of.</p>
<p>I&rsquo;m going to list the options, starting with (very roughly) the most popular
ones. Here&rsquo;s a table of contents:</p>
<ul>
<li><a href="#pull-ff-only-or-pull-rebase-true">pull.ff only or pull.rebase true</a></li>
<li><a href="#merge-conflictstyle-zdiff3">merge.conflictstyle zdiff3</a></li>
<li><a href="#rebase-autosquash-true">rebase.autosquash true</a></li>
<li><a href="#rebase-autostash-true">rebase.autostash true</a></li>
<li><a href="#push-default-simple-push-default-current">push.default simple, push.default current</a></li>
<li><a href="#init-defaultbranch-main">init.defaultBranch main</a></li>
<li><a href="#commit-verbose-true">commit.verbose true</a></li>
<li><a href="#rerere-enabled-true">rerere.enabled true</a></li>
<li><a href="#help-autocorrect-10">help.autocorrect 10</a></li>
<li><a href="#core-pager-delta">core.pager delta</a></li>
<li><a href="#diff-algorithm-histogram">diff.algorithm histogram</a></li>
<li><a href="#core-excludesfile-a-global-gitignore">core.excludesfile ~/.gitignore</a></li>
<li><a href="#includeif-separate-git-configs-for-personal-and-work">includeIf: separate git configs for personal and work</a></li>
<li><a href="#fsckobjects-avoid-data-corruption">fsckobjects: avoid data corruption</a></li>
<li><a href="#submodule-stuff">submodule stuff</a></li>
<li><a href="#and-more">and more</a></li>
<li><a href="#how-to-set-these">how to set these</a></li>
<li><a href="#config-changes-i-ve-made-after-writing-this-post">config changes I&rsquo;ve made after writing this post</a></li>
</ul>
<p>All of the options are documented in <code>man git-config</code>, or <a href="https://git-scm.com/docs/git-config">this page</a>.</p>
<h3 id="pull-ff-only-or-pull-rebase-true"><code>pull.ff only</code> or <code>pull.rebase true</code></h3>
<p>These two were the most popular. These both have similar goals: to avoid accidentally creating a merge commit
when you run <code>git pull</code> on a branch where the upstream branch has diverged.</p>
<ul>
<li><code>pull.rebase true</code> is the equivalent of running <code>git pull --rebase</code> every time you <code>git pull</code></li>
<li><code>pull.ff only</code> is the equivalent of running <code>git pull --ff-only</code> every time you <code>git pull</code></li>
</ul>
<p>I&rsquo;m pretty sure it doesn&rsquo;t make sense to set both of them at once, since <code>--ff-only</code>
overrides <code>--rebase</code>.</p>
<p>Personally I don&rsquo;t use either of these since I prefer to decide how to handle
that situation every time, and now git&rsquo;s default behaviour when your branch has
diverged from the upstream is to just throw an error and ask you what to do
(very similar to what <code>git pull --ff-only</code> does).</p>
<h3 id="merge-conflictstyle-zdiff3"><code>merge.conflictstyle zdiff3</code></h3>
<p>Next: making merge conflicts more readable! <code>merge.conflictstyle zdiff3</code> and <code>merge.conflictstyle diff3</code> were both super popular (&ldquo;totally indispensable&rdquo;).</p>
<p>The main idea is
The consensus seemed to be &ldquo;diff3 is great, and zdiff3 (which is newer) is even better!&rdquo;.</p>
<p>So what&rsquo;s the deal with <code>diff3</code>. Well, by default in git, merge conflicts look like this:</p>
<pre><code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
def parse(input):
    return input.split(&quot;\n&quot;)
=======
def parse(text):
    return text.split(&quot;\n\n&quot;)
&gt;&gt;&gt;&gt;&gt;&gt;&gt; somebranch
</code></pre>
<p>I&rsquo;m supposed to decide whether <code>input.split(&quot;\n&quot;)</code> or <code>text.split(&quot;\n\n&quot;)</code> is
better. But how? What if I don&rsquo;t remember whether <code>\n</code> or <code>\n\n</code> is right? Enter diff3!</p>
<p>Here&rsquo;s what the same merge conflict look like with <code>merge.conflictstyle diff3</code> set:</p>
<pre><code>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
def parse(input):
    return input.split(&quot;\n&quot;)
||||||| b9447fc
def parse(input):
    return input.split(&quot;\n\n&quot;)
=======
def parse(text):
    return text.split(&quot;\n\n&quot;)
&gt;&gt;&gt;&gt;&gt;&gt;&gt; somebranch
</code></pre>
<p>This has <strong>extra information</strong>: now the original version of the code is in the middle! So we can see that:</p>
<ul>
<li>one side changed <code>\n\n</code> to <code>\n</code></li>
<li>the other side renamed <code>input</code> to <code>text</code></li>
</ul>
<p>So presumably the correct merge conflict resolution is <code>return text.split(&quot;\n&quot;)</code>, since that combines the changes from both sides.</p>
<p>I haven&rsquo;t used zdiff3, but a lot of people seem to think it&rsquo;s better. The blog post <a href="https://ductile.systems/zdiff3/">Better Git Conflicts with zdiff3</a> talks more about it.</p>
<h3 id="rebase-autosquash-true"><code>rebase.autosquash true</code></h3>
<p>Autosquash was also a new feature to me. The goal is to make it easier to modify old commits.</p>
<p>Here&rsquo;s how it works:</p>
<ul>
<li>You have a commit that you would like to be combined with some commit that&rsquo;s 3 commits ago, say <code>add parsing code</code></li>
<li>You commit it with <code>git commit --fixup OLD_COMMIT_ID</code>, which gives the new commit the commit message <code>fixup! add parsing code</code></li>
<li>Now, when you run <code>git rebase --autosquash main</code>, it will automatically combine all the <code>fixup!</code> commits with their targets</li>
</ul>
<p><code>rebase.autosquash true</code> means that <code>--autosquash</code> always gets passed automatically to <code>git rebase</code>.</p>
<h3 id="rebase-autostash-true"><code>rebase.autostash true</code></h3>
<p>This automatically runs <code>git stash</code> before a git rebase and <code>git stash pop</code> after. It basically passes <code>--autostash</code> to <code>git rebase</code>.</p>
<p>Personally I&rsquo;m a little scared of this since it potentially can result in merge
conflicts after the rebase, but I guess that doesn&rsquo;t come up very often for
people since it seems like a really popular configuration option.</p>
<h3 id="push-default-simple-push-default-current-push-autosetupremote-true"><code>push.default simple</code>, <code>push.default current</code>, <code>push.autoSetupRemote true</code></h3>
<p>These <a href="https://git-scm.com/docs/git-config#Documentation/git-config.txt-pushdefault"><code>push</code></a> options tell <code>git push</code> to automatically push the current branch to a remote branch with the same name.</p>
<ul>
<li><code>push.default simple</code> is the default in Git. It only works if your branch is already tracking a remote branch</li>
<li><code>push.default current</code> is similar, but it&rsquo;ll always push the local branch to a remote branch with the same name.</li>
<li><code>push.autoSetupRemote true</code> is a little different &ndash; this one makes it so when you first push a branch, it&rsquo;ll automatically set up tracking for it</li>
</ul>
<p>I think I prefer <code>push.autoSetupRemote true</code> to <code>push.default current</code> because
<code>push.autoSetupRemote true</code> also lets you <strong>pull</strong> from the matching remote
branch (though you do need to push first to set up tracking). <code>push.default current</code> only lets you push.</p>
<p>I believe the only thing to be careful of with <code>push.autoSetupRemote true</code> and
<code>push.default current</code> is that you need to be confident that you&rsquo;re never going
to accidentally make a local branch with the same name as an unrelated remote
branch. Lots of people have branch naming conventions (like <code>julia/my-change</code>)
that make this kind of conflict very unlikely, or just have few enough
collaborators that branch name conflicts probably won&rsquo;t happen.</p>
<h3 id="init-defaultbranch-main"><code>init.defaultBranch main</code></h3>
<p>Create a <code>main</code> branch instead of a <code>master</code> branch when creating a new repo.</p>
<h3 id="commit-verbose-true"><code>commit.verbose true</code></h3>
<p>This adds the whole commit diff in the text editor where you&rsquo;re writing your
commit message, to help you remember what you were doing.</p>
<h3 id="rerere-enabled-true"><code>rerere.enabled true</code></h3>
<p>This enables <a href="https://git-scm.com/book/en/v2/Git-Tools-Rerere">rerere</a> (&quot;<strong>re</strong>use <strong>re</strong>covered <strong>re</strong>solution&quot;), which remembers how you resolved merge conflicts
during a <code>git rebase</code> and automatically resolves conflicts for you when it can.</p>
<h3 id="help-autocorrect-10"><code>help.autocorrect 10</code></h3>
<p>By default git&rsquo;s autocorrect try to check for typos (like <code>git ocmmit</code>), but won&rsquo;t actually run the corrected command.</p>
<p>If you want it to run the suggestion automatically, you can set
<a href="https://git-scm.com/docs/git-config#Documentation/git-config.txt-helpautoCorrect"><code>help.autocorrect</code></a>
to <code>1</code> (run after 0.1 seconds), <code>10</code> (run after 1 second), <code>immediate</code> (run
immediately), or <code>prompt</code> (run after prompting)</p>
<h3 id="core-pager-delta"><code>core.pager delta</code></h3>
<p>The &ldquo;pager&rdquo; is what git uses to display the output of <code>git diff</code>, <code>git log</code>, <code>git show</code>, etc. People set it to:</p>
<ul>
<li><a href="https://github.com/dandavison/delta"><code>delta</code></a> (a fancy diff viewing tool with syntax highlighting)</li>
<li><code>less -x5,9</code> (sets tabstops, which I guess helps if you have a lot of files with tabs in them?)</li>
<li><code>less -F -X</code> (not sure about this one, <code>-F</code> seems to disable the pager if everything fits on one screen if but my git seems to do that already anyway)</li>
<li><code>cat</code> (to disable paging altogether)</li>
</ul>
<p>I used to use <code>delta</code> but turned it off because somehow I messed up the colour
scheme in my terminal and couldn&rsquo;t figure out how to fix it. I think it&rsquo;s a
great tool though.</p>
<p>I believe delta also suggests that you set up <code>interactive.diffFilter  delta --color-only</code> to syntax highlight code when you run <code>git add -p</code>.</p>
<h3 id="diff-algorithm-histogram"><code>diff.algorithm histogram</code></h3>
<p>Git&rsquo;s default diff algorithm often handles functions being reordered badly. For example look at this diff:</p>
<pre><code>-.header {
+.footer {
     margin: 0;
 }

-.footer {
+.header {
     margin: 0;
+    color: green;
 }
</code></pre>
<p>I find it pretty confusing. But with <code>diff.algorithm histogram</code>, the diff looks like this instead, which I find much clearer:</p>
<pre><code>-.header {
-    margin: 0;
-}
-
 .footer {
     margin: 0;
 }

+.header {
+    margin: 0;
+    color: green;
+}
</code></pre>
<p>Some folks also use <code>patience</code>, but <code>histogram</code> seems to be more popular. <a href="https://luppeng.wordpress.com/2020/10/10/when-to-use-each-of-the-git-diff-algorithms/">When to Use Each of the Git Diff Algorithms</a> has more on this.</p>
<h3 id="core-excludesfile-a-global-gitignore"><code>core.excludesfile</code>: a global .gitignore</h3>
<p><code>core.excludeFiles = ~/.gitignore</code> lets you set a global gitignore file that
applies to all repositories, for things like <code>.idea</code> or <code>.DS_Store</code> that you
never want to commit to any repo. It defaults to <code>~/.config/git/ignore</code>.</p>
<h3 id="includeif-separate-git-configs-for-personal-and-work"><code>includeIf</code>: separate git configs for personal and work</h3>
<p>Lots of people said they use this to configure different email addresses for
personal and work repositories. You can set it up something like this:</p>
<pre><code>[includeIf &quot;gitdir:~/code/&lt;work&gt;/&quot;]
path = &quot;~/code/&lt;work&gt;/.gitconfig&quot;
</code></pre>
<h3 id="url-git-github-com-insteadof-https-github-com"><code>url.&quot;git@github.com:&quot;.insteadOf 'https://github.com/'</code></h3>
<p>I often accidentally clone the HTTP version of a repository instead of the
SSH version and then have to manually go into <code>~/.git/config</code> and edit the
remote URL. This seems like a nice workaround: it&rsquo;ll replace
<code>https://github.com</code> in remotes with <code>git@github.com:</code>.</p>
<p>Here&rsquo;s what it looks like in <code>~/.gitconfig</code> since it&rsquo;s kind of a mouthful:</p>
<pre><code>[url &quot;git@github.com:&quot;]
	insteadOf = &quot;https://github.com/&quot;
</code></pre>
<p>One person said they use <code>pushInsteadOf</code> instead to only do the replacement for
<code>git push</code> because they don&rsquo;t want to have to unlock their SSH key when
pulling a public repo.</p>
<p>A couple of other people mentioned setting <code>insteadOf = &quot;gh:&quot;</code> so they can <code>git remote add gh:jvns/mysite</code> to add a remote with less typing.</p>
<h3 id="fsckobjects-avoid-data-corruption"><code>fsckobjects</code>: avoid data corruption</h3>
<p>A couple of people mentioned this one. Someone explained it as &ldquo;detect data
corruption eagerly. Rarely matters but has saved my entire team a couple
times&rdquo;.</p>
<pre><code>transfer.fsckobjects = true
fetch.fsckobjects = true
receive.fsckObjects = true
</code></pre>
<h3 id="submodule-stuff">submodule stuff</h3>
<p>I&rsquo;ve never understood anything about submodules but a couple of person said they like to set:</p>
<ul>
<li><code>status.submoduleSummary  true</code></li>
<li><code>diff.submodule  log</code></li>
<li><code>submodule.recurse  true</code></li>
</ul>
<p>I won&rsquo;t attempt to explain those but there&rsquo;s <a href="https://hachyderm.io/@unlambda/111942468084436716#.">an explanation on Mastodon by @unlambda here</a>.</p>
<h3 id="and-more">and more</h3>
<p>Here&rsquo;s everything else that was suggested by at least 2 people:</p>
<ul>
<li><code>blame.ignoreRevsFile .git-blame-ignore-revs</code> lets you specify a file with commits to ignore during <code>git blame</code>, so that giant renames don&rsquo;t mess up your blames</li>
<li><code>branch.sort -committerdate</code>, makes <code>git branch</code> sort by most recently used branches instead of alphabetical, to make it easier to find branches. <code>tag.sort taggerdate</code> is similar for tags.</li>
<li><code>color.ui false</code>: to turn off colour</li>
<li><code>commit.cleanup scissors</code>: so that you can write <code>#include</code> in a commit message without the <code>#</code> being treated as a comment and removed</li>
<li><code>core.autocrlf false</code>: on Windows, to work well with folks using Unix</li>
<li><code>core.editor emacs</code>: to use emacs (or another editor) to edit commit messages</li>
<li><code>credential.helper osxkeychain</code>: use the Mac keychain for managing</li>
<li><code>diff.tool difftastic</code>: use <a href="https://difftastic.wilfred.me.uk/">difftastic</a> (or <code>meld</code> or <code>nvimdiffs</code>) to display diffs</li>
<li><code>diff.colorMoved default</code>: uses different colours to highlight lines in diffs that have been &ldquo;moved&rdquo;</li>
<li><code>diff.colorMovedWS allow-indentation-change</code>: with <code>diff.colorMoved</code> set, also ignores indentation changes</li>
<li><code>diff.context 10</code>: include more context in diffs</li>
<li><code>fetch.prune true</code> and <code>fetch.prunetags</code> - automatically delete remote tracking branches that have been deleted</li>
<li><code>gpg.format ssh</code>: allow you to sign commits with SSH keys</li>
<li><code>log.date iso</code>: display dates as <code>2023-05-25 13:54:51</code> instead of <code>Thu May 25 13:54:51 2023</code></li>
<li><code>merge.keepbackup false</code>, to get rid of the <code>.orig</code> files git creates during a merge conflict</li>
<li><code>merge.tool meld</code> (or <code>nvim</code>, or <code>nvimdiff</code>) so that you can use <code>git mergetool</code> to help resolve merge conflicts</li>
<li><code>push.followtags true</code>: push new tags along with commits being pushed</li>
<li><code>rebase.missingCommitsCheck error</code>: don&rsquo;t allow deleting commits during a rebase</li>
<li><code>rebase.updateRefs true</code>: makes it much easier to rebase multiple stacked branches at a time. <a href="https://andrewlock.net/working-with-stacked-branches-in-git-is-easier-with-update-refs/">Here&rsquo;s a blog post about it</a>.</li>
</ul>
<h3 id="how-to-set-these">how to set these</h3>
<p>I generally set git config options with <code>git config --global NAME VALUE</code>, for
example <code>git config --global diff.algorithm histogram</code>. I usually set all of my
options globally because it stresses me out to have different git behaviour in
different repositories.</p>
<p>If I want to delete an option I&rsquo;ll edit <code>~/.gitconfig</code> manually, where they look like this:</p>
<pre><code>[diff]
	algorithm = histogram
</code></pre>
<h3 id="config-changes-i-ve-made-after-writing-this-post">config changes I&rsquo;ve made after writing this post</h3>
<p>My git config is pretty minimal, I already had:</p>
<ul>
<li><code>init.defaultBranch main</code></li>
<li><code>push.autoSetupRemote true</code></li>
<li><code>merge.tool meld</code></li>
<li><code>diff.colorMoved default</code> (which actually doesn&rsquo;t even work for me for some reason but I haven&rsquo;t found the time to debug)</li>
</ul>
<p>and I added these 3 after writing this blog post:</p>
<ul>
<li><code>diff.algorithm histogram</code></li>
<li><code>branch.sort -committerdate</code></li>
<li><code>merge.conflictstyle zdiff3</code></li>
</ul>
<p>I&rsquo;d probably also set <code>rebase.autosquash</code> if making carefully crafted pull
requests with multiple commits were a bigger part of my life right now.</p>
<p>I&rsquo;ve learned to be cautious about setting new config options &ndash; it takes me a
long time to get used to the new behaviour and if I change too many things at
once I just get confused. <code>branch.sort -committerdate</code> is something I was
already using anyway (through an alias), and I&rsquo;m pretty sold that <code>diff.algorithm histogram</code> will make my diffs easier to read when I reorder functions.</p>
<h3 id="that-s-all">that&rsquo;s all!</h3>
<p>I&rsquo;m always amazed by how useful to just ask a lot of people what stuff they like and
then list the most commonly mentioned ones, like with this <a href="https://jvns.ca/blog/2022/04/12/a-list-of-new-ish--command-line-tools/">list of new-ish command line tools</a>
I put together a couple of years ago. Having a list of 20 or 30 options to consider feels so much more efficient than combing through a list of <a href="https://jvns.ca/data/all-git-options.txt">all 600 or so git config options</a></p>
<p>It was a little confusing to summarize these because git&rsquo;s default
options have actually changed a lot of the years, so people occasionally have
options set that were important 8 years ago but today are the default. Also a
couple of the experimental options people were using have been removed and
replaced with a different version.</p>
<p>I did my best to explain things accurately as of how git works right now in
2024 but I&rsquo;ve definitely made mistakes in here somewhere, especially because I
don&rsquo;t use most of these options myself. Let me know on Mastodon if you see a
mistake and I&rsquo;ll try to fix it.</p>
<p>I might also ask people about aliases later, there were a bunch of great ones
that I left out because this was already getting long.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dealing with diverged git branches]]></title>
    <link href="https://jvns.ca/blog/2024/02/01/dealing-with-diverged-git-branches/"/>
    <updated>2024-02-01T08:47:00+00:00</updated>
    <id>https://jvns.ca/blog/2024/02/01/dealing-with-diverged-git-branches/</id>
    <content type="html"><![CDATA[<p>Hello! One of the most common problems I see folks struggling with in Git is
when a local branch (like <code>main</code>) and a remote branch (maybe also called
<code>main</code>) have diverged.</p>
<p>There are two things that make this situation hard:</p>
<ul>
<li>If you&rsquo;re not used to interpreting git&rsquo;s error messages, it&rsquo;s nontrivial to
even <strong>realize</strong> that your <code>main</code> has diverged from the remote <code>main</code> (git
will often just give you an intimidating but generic error message like
<code>! [rejected] main -&gt; main (non-fast-forward) error: failed to push some refs to 'github.com:jvns/int-exposed'</code>)</li>
<li>Once you realize that your branch has diverged from the remote <code>main</code>, there
no single clear way to handle it (what you need to do depends on the
situation and your git workflow)</li>
</ul>
<p>So let&rsquo;s talk about a) how to recognize when you&rsquo;re in a situation where a local
branch and remote branch have diverged and b) what you can do about it! Here&rsquo;s a
quick table of contents:</p>
<ul>
<li><a href="#what-does-diverged-mean">what does &ldquo;diverged&rdquo; mean?</a></li>
<li><a href="#recognizing-when-branches-are-diverged">recognizing when branches are diverged</a>
<ul>
<li><a href="#way-1-git-status">way 1: git status</a></li>
<li><a href="#way-2-git-push">way 2: git push</a></li>
<li><a href="#way-3-git-pull">way 3: git pull</a></li>
</ul>
</li>
<li><a href="#there-s-no-one-solution">there&rsquo;s no one solution</a>
<ul>
<li><a href="#solution-1-1-git-pull-rebase">solution 1.1: git pull &ndash;rebase</a></li>
<li><a href="#solution-1-2-git-pull-no-rebase">solution 1.2: git pull &ndash;no-rebase</a></li>
<li><a href="#solution-2-1-git-push-force">solution 2.1: git push &ndash;force</a></li>
<li><a href="#solution-2-2-git-push-force-with-lease">solution 2.2: git push &ndash;force-with-lease</a></li>
<li><a href="#solution-3-git-reset-hard-origin-main">solution 3: git reset &ndash;hard origin/main</a></li>
</ul>
</li>
</ul>
<p>Let&rsquo;s start with what it means for 2 branches to have &ldquo;diverged&rdquo;.</p>
<h3 id="what-does-diverged-mean">what does &ldquo;diverged&rdquo; mean?</h3>
<p>If you have a local <code>main</code> and a remote <code>main</code>, there are 4 basic configurations:</p>
<p><strong>1: up to date</strong>. The local and remote <code>main</code> branches are in the exact same place. Something like this:</p>
<pre><code>a - b - c - d
            ^ LOCAL
            ^ REMOTE
</code></pre>
<p><strong>2: local is behind</strong></p>
<p>Here you might want to <code>git pull</code>. Something like this:</p>
<pre><code>a - b - c - d - e
    ^ LOCAL     ^ REMOTE
</code></pre>
<p><strong>3: remote is behind</strong></p>
<p>Here you might want to <code>git push</code>. Something like this:</p>
<pre><code>a - b - c - d - e
    ^ REMOTE    ^ LOCAL
</code></pre>
<p><strong>4: they&rsquo;ve diverged :(</strong></p>
<p>This is the situation we&rsquo;re talking about in this blog post. It looks something like this:</p>
<pre><code>a - b - c - d - e
        \       ^ LOCAL
         -- f 
            ^ REMOTE
</code></pre>
<p>There&rsquo;s no one recipe for resolving this (how you want to handle it depends on
the situation and your git workflow!) but let&rsquo;s talk about how to recognize
that you&rsquo;re in that situation and some options for how to resolve it.</p>
<h3 id="recognizing-when-branches-are-diverged">recognizing when branches are diverged</h3>
<p>There are 3 main ways to tell that your branch has diverged.</p>
<h3 id="way-1-git-status">way 1: <code>git status</code></h3>
<p>The easiest way to is to run <code>git fetch</code> and then <code>git status</code>. You&rsquo;ll get a message something like this:</p>
<pre><code>$ git fetch
$ git status
On branch main
Your branch and 'origin/main' have diverged, &lt;-- here's the relevant line!
and have 1 and 2 different commits each, respectively.
  (use &quot;git pull&quot; to merge the remote branch into yours)
</code></pre>
<h3 id="way-2-git-push">way 2: <code>git push</code></h3>
<p>When I run <code>git push</code>, sometimes I get an error like this:</p>
<pre><code>$ git push
To github.com:jvns/int-exposed
 ! [rejected]        main -&gt; main (non-fast-forward)
error: failed to push some refs to 'github.com:jvns/int-exposed'
hint: Updates were rejected because the tip of your current branch is behind
hint: its remote counterpart. Integrate the remote changes (e.g.
hint: 'git pull ...') before pushing again.
hint: See the 'Note about fast-forwards' in 'git push --help' for details.
</code></pre>
<p>This doesn&rsquo;t <strong>always</strong> mean that my local <code>main</code> and the remote <code>main</code> have
diverged (it could just mean that my <code>main</code> is behind), but for me it <strong>often</strong>
means that. So if that happens I might run <code>git fetch</code> and <code>git status</code> to
check.</p>
<h3 id="way-3-git-pull">way 3: <code>git pull</code></h3>
<p>If I <code>git pull</code> when my branches have diverged, I get this error message:</p>
<pre><code>$ git pull
hint: You have divergent branches and need to specify how to reconcile them.
hint: You can do so by running one of the following commands sometime before
hint: your next pull:
hint:
hint:   git config pull.rebase false  # merge
hint:   git config pull.rebase true   # rebase
hint:   git config pull.ff only       # fast-forward only
hint:
hint: You can replace &quot;git config&quot; with &quot;git config --global&quot; to set a default
hint: preference for all repositories. You can also pass --rebase, --no-rebase,
hint: or --ff-only on the command line to override the configured default per
hint: invocation.
fatal: Need to specify how to reconcile divergent branches.
</code></pre>
<p>This is pretty clear about the issue (&ldquo;you have divergent branches&rdquo;).</p>
<p><code>git pull</code> doesn&rsquo;t always spit out this error message though when your branches have diverged: it depends on how
you configure git. The three other options I&rsquo;m aware of are:</p>
<ol>
<li>if you set <code>git config pull.rebase false</code>, it&rsquo;ll automatically start merging the remote <code>main</code></li>
<li>if you set <code>git config pull.rebase true</code>, it&rsquo;ll automatically start rebasing onto the remote <code>main</code></li>
<li>if you set <code>git config pull.ff only</code>, it&rsquo;ll exit with the error <code>fatal: Not possible to fast-forward, aborting.</code></li>
</ol>
<p>Now that we&rsquo;ve talked about some ways to recognize that you&rsquo;re in a situation
where your local branch has diverged from the remote one, let&rsquo;s talk about what
you can do about it.</p>
<h3 id="there-s-no-one-solution">there&rsquo;s no one solution</h3>
<p>There&rsquo;s no &ldquo;best&rdquo; way to resolve branches that have diverged &ndash; it really
depends on your workflow for git and why the situation is happening.</p>
<p>I use 3 main solutions, depending on the situation:</p>
<ol>
<li>I want to <strong>keep both sets of changes</strong> on <code>main</code>. To do this, I&rsquo;ll run <code>git pull --rebase</code>.</li>
<li>The <strong>remote changes are useless</strong> and I want to overwrite them. To do this,
I&rsquo;ll run <code>git push --force</code></li>
<li>The <strong>local changes are useless</strong> and I want to overwrite them. To do this, I&rsquo;ll
run <code>git reset --hard origin/main</code></li>
</ol>
<p>Here are some more details about all 3 of these solutions.</p>
<h3 id="solution-1-1-git-pull-rebase">solution 1.1: <code>git pull --rebase</code></h3>
<p>This is what I do when I want to keep both sets of changes. It rebases <code>main</code>
onto the remote <code>main</code> branch. I mostly use this in repositories where I&rsquo;m
doing all of my work on the <code>main</code> branch.</p>
<p>You can configure <code>git config pull.rebase true</code>, to do this automatically every
time, but I don&rsquo;t because sometimes I actually want to use solutions 2 or 3
(overwrite my local changes with the remote, or the reverse). I&rsquo;d rather be
warned &ldquo;hey, these branches have diverged, how do you want to handle it?&rdquo; and
decide for myself if I want to rebase or not.</p>
<h3 id="solution-1-2-git-pull-no-rebase">solution 1.2: <code>git pull --no-rebase</code></h3>
<p>This starts a merge between the <code>local</code> and remote <code>main</code>. Here you&rsquo;ll need to:</p>
<ol>
<li>Run <code>git pull --no-rebase</code>. This starts a merge and (if it succeeds) opens a text editor so that you can confirm that you want to commit the merge</li>
<li>Save the file in your text editor.</li>
</ol>
<p>I don&rsquo;t have too much to say about this because I&rsquo;ve never done it. I always
use rebase instead. That&rsquo;s a personal workflow choice though, lots of people have very
legitimate reasons to <a href="https://jvns.ca/blog/2023/11/06/rebasing-what-can-go-wrong-/">avoid rebase</a>.</p>
<h3 id="solution-2-1-git-push-force">solution 2.1: <code>git push --force</code></h3>
<p>Sometimes I know that the work on the remote <code>main</code> is actually useless and I
just want to overwrite it with whatever is on my local <code>main</code>.</p>
<p>I do this pretty often on private repositories where I&rsquo;m the only committer,
for example I might:</p>
<ul>
<li><code>git push</code> some commits</li>
<li>belatedly decide I want to change the most recent commit</li>
<li>make the changes and run <code>git commit --amend</code></li>
<li>run <code>git push --force</code></li>
</ul>
<p>Of course, if the repository has many different committers, force-pushing in
this way can cause a lot of problems. On shared repositories I&rsquo;ll usually
enable <a href="https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches">github branch protection</a>
so that it&rsquo;s impossible to force push.</p>
<h3 id="solution-2-2-git-push-force-with-lease">solution 2.2: <code>git push --force-with-lease</code></h3>
<p>I&rsquo;ve still never actually used <code>git push --force-with-lease</code>, but I&rsquo;ve seen a
lot of people recommend it as an alternative to <code>git push --force</code> that makes
sure that nobody else has changed the branch since the last time you pushed or
fetched, so that you don&rsquo;t accidentally blow their changes away.</p>
<p>Seems like a good option. I did notice that <code>--force-with-lease</code> isn&rsquo;t
foolproof though &ndash; for example <a href="https://github.com/git/git/commit/f17d642d3b0fa64879d59b311e596949f2a1f6d2">this git commit</a>
talks about how if you use VSCode&rsquo;s autofetching feature to continuously <code>git fetch</code>,
then <code>--force-with-lease</code> won&rsquo;t help you.</p>
<p>Apparently now Git also has <code>--force-with-lease --force-if-includes</code>
(<a href="https://git-scm.com/docs/git-push#Documentation/git-push.txt---no-force-if-includes">documented here</a>),
which I think checks the reflog to make sure that you&rsquo;ve already integrated the
remote branch into your branch somehow. I still don&rsquo;t totally understand this
but I found this <a href="https://stackoverflow.com/questions/65837109/when-should-i-use-git-push-force-if-includes">stack overflow conversation</a>
helpful.</p>
<h3 id="solution-3-1-git-reset-hard-origin-main">solution 3.1: <code>git reset --hard origin/main</code></h3>
<p>You can use this as the reverse of <code>git push --force</code> (since there&rsquo;s no <code>git pull --force</code>). I do this when I know that
my <strong>local</strong> work shouldn&rsquo;t be there and I want to throw it away and replace it
with whatever&rsquo;s on the remote branch.</p>
<p>For example, I might do this if I accidentally made a commit to <code>main</code> that
actually should have been on new branch. In that case I&rsquo;ll also create a new
branch (<code>new-branch</code> in this example) to store my local work on the <code>main</code>
branch, so it&rsquo;s not really being thrown away.</p>
<p>Fixing that problem looks like this:</p>
<pre><code>git checkout main

# 1. create `new-branch` to store my work
git checkout -b new-branch   

# 2. go back to the `main` branch I messed up
git checkout main            

# 3. make sure that my `origin/main` is up to date
git fetch                    

# 4. double check to make sure I don't have any uncomitted 
# work because `git reset --hard` will blow it away                                       
git status                   

# 5. force my local branch to match the remote `main`                               
#    NOTE: replace `origin/main` with the actual name of the
#    remote/branch, you can get this from `git status`.
git reset --hard origin/main  
</code></pre>
<p>This &ldquo;store your work on <code>main</code> on a new branch and then <code>git reset --hard</code>&rdquo; pattern can
also be useful if you&rsquo;re not sure yet how to solve the conflict, since most
people are more used to merging 2 local branches than dealing with merging a
remote branch.</p>
<p>As always <code>git reset --hard</code> is a dangerous action and you can permanently lose
your uncommitted work. I always run <code>git status</code> first to make sure I don&rsquo;t
have any uncommitted changes.</p>
<p>Some alternatives to using <code>git reset --hard</code> for this:</p>
<ul>
<li>check out some other branch and run <code>git branch -f main origin/main</code>.</li>
<li>check out some other branch and run <code>git fetch origin main:main --force</code></li>
</ul>
<h3 id="that-s-all">that&rsquo;s all!</h3>
<p>I&rsquo;d never really thought about how confusing the <code>git push</code> and <code>git pull</code>
error messages can be if you&rsquo;re not used to reading them.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Inside .git]]></title>
    <link href="https://jvns.ca/blog/2024/01/26/inside-git/"/>
    <updated>2024-01-26T09:42:42+00:00</updated>
    <id>https://jvns.ca/blog/2024/01/26/inside-git/</id>
    <content type="html"><![CDATA[<p>Hello! I posted a comic on Mastodon this week about what&rsquo;s in the <code>.git</code>
directory and someone requested a text version, so here it is. I added some
extra notes too. First, here&rsquo;s the image. It&rsquo;s a ~15 word explanation of each
part of your <code>.git</code> directory.</p>
<p><a href="https://wizardzines.com/comics/inside-git"><img src="https://wizardzines.com/images/uploads/inside-git.png"></a></p>
<p>You can <code>git clone https://github.com/jvns/inside-git</code> if you want to run all
these examples yourself.</p>
<p>Here&rsquo;s a table of contents:</p>
<ul>
<li><a href="#head-git-head">HEAD: .git/head</a></li>
<li><a href="#branch-git-refs-heads-main">branch: .git/refs/heads/main</a></li>
<li><a href="#commit-git-objects-10-93da429">commit: .git/objects/10/93da429&hellip;</a></li>
<li><a href="#tree-git-objects-9f-83ee7550">tree: .git/objects/9f/83ee7550&hellip;</a></li>
<li><a href="#blobs-git-objects-5a-475762c">blobs: .git/objects/5a/475762c&hellip;</a></li>
<li><a href="#reflog-git-logs-refs-heads-main">reflog: .git/logs/refs/heads/main</a></li>
<li><a href="#remote-tracking-branches-git-refs-remotes-origin-main">remote-tracking branches: .git/refs/remotes/origin/main</a></li>
<li><a href="#tags-git-refs-tags-v1-0">tags: .git/refs/tags/v1.0</a></li>
<li><a href="#the-stash-git-refs-stash">the stash: .git/refs/stash</a></li>
<li><a href="#git-config">.git/config</a></li>
<li><a href="#hooks-git-hooks-pre-commit">hooks: .git/hooks/pre-commit</a></li>
<li><a href="#the-staging-area-git-index">the staging area: .git/index</a></li>
<li><a href="#this-isn-t-exhaustive">this isn&rsquo;t exhaustive</a></li>
<li><a href="#this-isn-t-meant-to-completely-explain-git">this isn&rsquo;t meant to completely explain git</a></li>
</ul>
<p>The first 5 parts (<code>HEAD</code>, branch, commit, tree, blobs) are the core of git.</p>
<h3 id="head-git-head">HEAD: <code>.git/head</code></h3>
<p><strong><code>HEAD</code></strong> is a tiny file that just contains the name of your current <strong>branch</strong>.</p>
<p>Example contents:</p>
<pre><code>$ cat .git/HEAD
ref: refs/heads/main
</code></pre>
<p><code>HEAD</code> can also be a commit ID, that’s called &ldquo;detached HEAD state&rdquo;.</p>
<h3 id="branch-git-refs-heads-main">branch: <code>.git/refs/heads/main</code></h3>
<p>A <strong>branch</strong> is stored as a tiny file that just contains 1 <strong>commit ID</strong>. It’s stored
in a folder called <code>refs/heads</code>.</p>
<p>Example contents:</p>
<pre><code>$ cat .git/refs/heads/main
1093da429f08e0e54cdc2b31526159e745d98ce0
</code></pre>
<h3 id="commit-git-objects-10-93da429">commit: <code>.git/objects/10/93da429...</code></h3>
<p>A <strong>commit</strong> is a small file containing its parent(s), message, <strong>tree</strong>, and author.</p>
<p>Example contents:</p>
<pre><code>$ git cat-file -p 1093da429f08e0e54cdc2b31526159e745d98ce0
tree 9f83ee7550919867e9219a75c23624c92ab5bd83
parent 33a0481b440426f0268c613d036b820bc064cdea
author Julia Evans &lt;julia@example.com&gt; 1706120622 -0500
committer Julia Evans &lt;julia@example.com&gt; 1706120622 -0500

add hello.py
</code></pre>
<p>These files are compressed, the best way to see objects is with <code>git cat-file -p HASH</code>.</p>
<h3 id="tree-git-objects-9f-83ee7550">tree: <code>.git/objects/9f/83ee7550...</code></h3>
<p><strong>Trees</strong> are small files with directory listings. The files in it are called <strong>blobs</strong>.</p>
<p>Example contents:</p>
<pre><code>$  git cat-file -p 9f83ee7550919867e9219a75c23624c92ab5bd83
100644 blob e69de29bb2d1d6434b8b29ae775ad8c2e48c5391	.gitignore
100644 blob 665c637a360874ce43bf74018768a96d2d4d219a	hello.py
040000 tree 24420a1530b1f4ec20ddb14c76df8c78c48f76a6	lib
</code></pre>
<p>The permissions here LOOK like unix permissions, but they’re actually super
restricted, only 644 and 755 are allowed.</p>
<h3 id="blobs-git-objects-5a-475762c">blobs: <code>.git/objects/5a/475762c...</code></h3>
<p><strong>blobs</strong> are the files that contain your actual code</p>
<p>Example contents:</p>
<pre><code>$ git cat-file -p 665c637a360874ce43bf74018768a96d2d4d219a	
print(&quot;hello world!&quot;)
</code></pre>
<p>Storing a new blob with every change can get big, so <code>git gc</code> periodically
<a href="https://codewords.recurse.com/issues/three/unpacking-git-packfiles">packs them</a> for efficiency in <code>.git/objects/pack</code>.</p>
<h3 id="reflog-git-logs-refs-heads-main">reflog: <code>.git/logs/refs/heads/main</code></h3>
<p>The reflog stores the history of every branch, tag, and HEAD. For (mostly) every file in <code>.git/refs</code>, there&rsquo;s a corresponding log in <code>.git/logs/refs</code>.</p>
<p>Example content for the <code>main</code> branch:</p>
<pre><code>$ tail -n 1 .git/logs/refs/heads/main
33a0481b440426f0268c613d036b820bc064cdea
1093da429f08e0e54cdc2b31526159e745d98ce0
Julia Evans &lt;julia@example.com&gt;
1706119866 -0500
commit: add hello.py
</code></pre>
<p>each line of the reflog has:</p>
<ul>
<li>before/after commit IDs</li>
<li>user</li>
<li>timestamp</li>
<li>log message</li>
</ul>
<p>Normally it&rsquo;s all one line, I just wrapped it for readability here.</p>
<h3 id="remote-tracking-branches-git-refs-remotes-origin-main">remote-tracking branches: <code>.git/refs/remotes/origin/main</code></h3>
<p><strong>Remote-tracking branches</strong> store the most recently seen <strong>commit ID</strong> for a remote branch</p>
<p>Example content:</p>
<pre><code>$ cat .git/refs/remotes/origin/main
fcdeb177797e8ad8ad4c5381b97fc26bc8ddd5a2
</code></pre>
<p>When git status says &ldquo;you’re up to date with <code>origin/main</code>&rdquo;, it’s just looking
at this. It&rsquo;s often out of date, you can update it with <code>git fetch origin main</code>.</p>
<h3 id="tags-git-refs-tags-v1-0">tags: <code>.git/refs/tags/v1.0</code></h3>
<p>A tag is a tiny file in <code>.git/refs/tags</code> containing a commit ID.</p>
<p>Example content:</p>
<pre><code>$ cat .git/refs/tags/v1.0
1093da429f08e0e54cdc2b31526159e745d98ce0
</code></pre>
<p>Unlike branches, when you make new commits it doesn&rsquo;t update the tag.</p>
<h3 id="the-stash-git-refs-stash">the stash: <code>.git/refs/stash</code></h3>
<p>The stash is a tiny file called <code>.git/refs/stash</code>. It contains the commit ID of a commit that&rsquo;s created when you run <code>git stash</code>.</p>
<pre><code>cat .git/refs/stash
62caf3d918112d54bcfa24f3c78a94c224283a78
</code></pre>
<p>The stash is a stack, and previous values are stored in <code>.git/logs/refs/stash</code> (the reflog for <code>stash</code>).</p>
<pre><code>cat .git/logs/refs/stash
62caf3d9 e85c950f Julia Evans &lt;julia@example.com&gt; 1706290652 -0500	WIP on main: 1093da4 add hello.py
00000000 62caf3d9 Julia Evans &lt;julia@example.com&gt; 1706290668 -0500	WIP on main: 1093da4 add hello.py
</code></pre>
<p>Unlike branches and tags, if you <code>git stash pop</code> a commit from the stash, it&rsquo;s
<strong>deleted</strong> from the reflog so it&rsquo;s almost impossible to find it again. The
stash is the only reflog in git where things get deleted very soon after
they&rsquo;re added. (entries expire out of the branch reflogs too, but generally
only after 90 days)</p>
<p><strong>A note on refs:</strong></p>
<p>At this point you&rsquo;ve probably noticed that a lot of things (branches,
remote-tracking branches, tags, and the stash) are commit IDs in <code>.git/refs</code>.
They&rsquo;re called &ldquo;references&rdquo; or &ldquo;refs&rdquo;. Every ref is a commit ID, but the
different types of refs are treated VERY differently by git, so I find it
useful to think about them separately even though they all use
the same file format. For example, git deletes things from the stash reflog in
a way that it won&rsquo;t for branch or tag reflogs.</p>
<h3 id="git-config">.git/config</h3>
<p><code>.git/config</code> is a config file for the repository. It&rsquo;s where you configure
your remotes.</p>
<p>Example content:</p>
<pre><code>[remote &quot;origin&quot;] 
url = git@github.com: jvns/int-exposed 
fetch = +refs/heads/*: refs/remotes/origin/* 
[branch &quot;main&quot;] 
remote = origin 
merge refs/heads/main
</code></pre>
<p>git has local and global settings, the local settings are here and the global
ones are in <code>~/.gitconfig</code> hooks</p>
<h3 id="hooks-git-hooks-pre-commit">hooks: <code>.git/hooks/pre-commit</code></h3>
<p>Hooks are optional scripts that you can set up to run (eg before a commit) to do anything you want.</p>
<p>Example content:</p>
<pre><code>#!/bin/bash 
any-commands-you-want
</code></pre>
<p>(this obviously isn&rsquo;t a real pre-commit hook)</p>
<h3 id="the-staging-area-git-index">the staging area: <code>.git/index</code></h3>
<p>The staging area stores files when you’re preparing to commit. This one is a
binary file, unlike a lot of things in git which are essentially plain text
files.</p>
<p>As far as I can tell the best way to look at the contents of the index is with <code>git ls-files --stage</code>:</p>
<pre><code>$ git ls-files --stage
100644 e69de29bb2d1d6434b8b29ae775ad8c2e48c5391 0	.gitignore
100644 665c637a360874ce43bf74018768a96d2d4d219a 0	hello.py
100644 e69de29bb2d1d6434b8b29ae775ad8c2e48c5391 0	lib/empty.py
</code></pre>
<h3 id="this-isn-t-exhaustive">this isn&rsquo;t exhaustive</h3>
<p>There are some other things in <code>.git</code> like <code>FETCH_HEAD</code>, <code>worktrees</code>, and
<code>info</code>. I only included the ones that I&rsquo;ve found it useful to understand.</p>
<h3 id="this-isn-t-meant-to-completely-explain-git">this isn&rsquo;t meant to completely explain git</h3>
<p>One of the most common pieces of advice I hear about git is &ldquo;just learn how
the <code>.git</code> directory is structured and then you&rsquo;ll understand everything!&rdquo;.</p>
<p>I love understanding the internals of things more than anyone, but there&rsquo;s a
LOT that &ldquo;how the .git directory is structured&rdquo; doesn&rsquo;t explain, like:</p>
<ul>
<li>how merges and rebases work and how they can go wrong (for instance this list of <a href="https://jvns.ca/blog/2023/11/06/rebasing-what-can-go-wrong-/">what can go wrong with rebase</a>)</li>
<li>how exactly your colleagues are using git, and what guidelines you should be following to work with them successfully</li>
<li>how pushing/pulling code from other repositories works</li>
<li>how to handle merge conflicts</li>
</ul>
<p>Hopefully this will be useful to some folks out there though.</p>
<h3 id="some-other-references">some other references:</h3>
<ul>
<li>the book <a href="https://shop.jcoglan.com/building-git/">building git</a> by James Coglan (side note: looks like there&rsquo;s a <a href="https://mastodon.social/@jcoglan/111807463940323655">50% off discount for the rest of January</a>)</li>
<li><a href="https://maryrosecook.com/blog/post/git-from-the-inside-out">git from the inside out</a> by mary rose cook</li>
<li>the official <a href="https://git-scm.com/docs/gitrepository-layout#Documentation/gitrepository-layout.txt-index">git repository layout docs</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Do we think of git commits as diffs, snapshots, and/or histories?]]></title>
    <link href="https://jvns.ca/blog/2024/01/05/do-we-think-of-git-commits-as-diffs--snapshots--or-histories/"/>
    <updated>2024-01-05T14:00:51+00:00</updated>
    <id>https://jvns.ca/blog/2024/01/05/do-we-think-of-git-commits-as-diffs--snapshots--or-histories/</id>
    <content type="html"><![CDATA[<p>Hello! I&rsquo;ve been extremely slowly trying to figure how to explain every core
concept in Git (commits! branches! remotes! the staging area!) and commits have
been surprisingly tricky.</p>
<p>Understanding how git commits are implemented feels pretty straightforward to
me (those are facts! I can look it up!), but it&rsquo;s been much harder to figure
out how other people think about commits. So like I&rsquo;ve been doing a lot
recently, I went on Mastodon and started asking some questions.</p>
<h3 id="how-do-people-think-about-git-commits">how do people think about Git commits?</h3>
<p>I did a <a href="https://social.jvns.ca/@b0rk/111563158717698550">highly unscientific poll</a> on Mastodon about how people think about Git
commits: is it a snapshot? is it a diff? is it a list of every previous commit?
(Of course it&rsquo;s legitimate to think about it as all three, but I was curious
about the <em>primary</em> way people think about Git commits). Here it is:</p>
<img src="https://jvns.ca/images/git-commit-poll.png">
<p>The results were:</p>
<ul>
<li>51% diff</li>
<li>42% snapshot</li>
<li>4% history of every previous commit</li>
<li>3% &ldquo;other&rdquo;</li>
</ul>
<p>I was really surprised that it was so evenly split between diffs and snapshots.
People also made some interesting kind of contradictory statements like &ldquo;in my
mind a commit is a diff, but I think it&rsquo;s actually implemented as a snapshot&rdquo;
and &ldquo;in my mind a commit is a snapshot, but I think it&rsquo;s actually implemented
as a diff&rdquo;. We&rsquo;ll talk more about how a commit is actually implemented later in
the post.</p>
<p>Before we go any further: when we say &ldquo;a diff&rdquo; or &ldquo;a snapshot&rdquo;, what does that
mean?</p>
<h3 id="what-s-a-diff">what&rsquo;s a diff?</h3>
<p>What I mean by a diff is probably obvious: it&rsquo;s what you get when you run <code>git show COMMIT_ID</code>. For example here&rsquo;s a typo fix from rbspy:</p>
<pre><code>diff --git a/src/ui/summary.rs b/src/ui/summary.rs
index 5c4ff9c..3ce9b3b 100644
--- a/src/ui/summary.rs
+++ b/src/ui/summary.rs
@@ -160,7 +160,7 @@ mod tests {
 &quot;;

         let mut buf: Vec&lt;u8&gt; = Vec::new();
-        stats.write(&amp;mut buf).expect(&quot;Callgrind write failed&quot;);
+        stats.write(&amp;mut buf).expect(&quot;summary write failed&quot;);
         let actual = String::from_utf8(buf).expect(&quot;summary output not utf8&quot;);
         assert_eq!(actual, expected, &quot;Unexpected summary output&quot;);
     }
</code></pre>
<p>You can see it on GitHub here: <a href="https://github.com/rbspy/rbspy/commit/24ad81d2439f9e63dd91cc1126ca1bb5d3a4da5b">https://github.com/rbspy/rbspy/commit/24ad81d2439f9e63dd91cc1126ca1bb5d3a4da5b</a></p>
<h3 id="what-s-a-snapshot">what&rsquo;s a snapshot?</h3>
<p>When I say &ldquo;a snapshot&rdquo;, what I mean is &ldquo;all the files that you get when you
run <code>git checkout COMMIT_ID</code>&rdquo;.</p>
<p>Git often calls the list of files for a commit a &ldquo;tree&rdquo; (as in &ldquo;directory
tree&rdquo;), and you can see all of the files for the above example commit here on
GitHub:</p>
<p><a href="https://github.com/rbspy/rbspy/tree/24ad81d2439f9e63dd91cc1126ca1bb5d3a4da5b">https://github.com/rbspy/rbspy/tree/24ad81d2439f9e63dd91cc1126ca1bb5d3a4da5b</a> (it&rsquo;s <code>/tree/</code> instead of <code>/commit/</code>)</p>
<h3 id="is-how-git-implements-it-really-the-right-way-to-explain-it">is &ldquo;how Git implements it&rdquo; really the right way to explain it?</h3>
<p>Probably the most common piece of advice I hear related to learning Git is
&ldquo;just learn how Git represents things internally, and everything will make
sense&rdquo;. I obviously find this perspective extremely appealing (if you&rsquo;ve spent
any time reading this blog, you know I <em>love</em> thinking about how things are
implemented internally).</p>
<p>But as a strategy for teaching Git, it hasn&rsquo;t been as successful as I&rsquo;d hoped!
Often I&rsquo;ve eagerly started explaining &ldquo;okay, so git commits are snapshots with
a pointer to their parent, and then a branch is a pointer to a commit, and&hellip;&rdquo;,
but the person I&rsquo;m trying to help will tell me that they didn&rsquo;t really find
that explanation that useful at all and they still don&rsquo;t get it. So I&rsquo;ve been
considering other options.</p>
<p>Let&rsquo;s talk about the internals a bit anyway though.</p>
<h3 id="how-git-represents-commits-internally-snapshots">how git represents commits internally: snapshots</h3>
<p>Internally, git represents commits as snapshots (it stores the &ldquo;tree&rdquo; of the
current version of every file). I wrote about this in <a href="https://jvns.ca/blog/2023/09/14/in-a-git-repository--where-do-your-files-live-/">In a git repository, where do your files live?</a>,
but here&rsquo;s a very quick summary of what the internal format looks like.</p>
<p>Here&rsquo;s how a commit is represented:</p>
<pre><code>$ git cat-file -p 24ad81d2439f9e63dd91cc1126ca1bb5d3a4da5b
tree e197a79bef523842c91ee06fa19a51446975ec35
parent 26707359cdf0c2db66eb1216bf7ff00eac782f65
author Adam Jensen &lt;adam@acj.sh&gt; 1672104452 -0500
committer Adam Jensen &lt;adam@acj.sh&gt; 1672104890 -0500

Fix typo in expectation message
</code></pre>
<p>and here&rsquo;s what we get when we look at this tree object: a list of every file /
subdirectory in the repository&rsquo;s root directory as of that commit:</p>
<pre><code>$ git cat-file -p e197a79bef523842c91ee06fa19a51446975ec35
040000 tree 2fcc102acd27df8f24ddc3867b6756ac554b33ef	.cargo
040000 tree 7714769e97c483edb052ea14e7500735c04713eb	.github
100644 blob ebb410eb8266a8d6fbde8a9ffaf5db54a5fc979a	.gitignore
100644 blob fa1edfb73ce93054fe32d4eb35a5c4bee68c5bf5	ARCHITECTURE.md
100644 blob 9c1883ee31f4fa8b6546a7226754cfc84ada5726	CODE_OF_CONDUCT.md
100644 blob 9fac1017cb65883554f821914fac3fb713008a34	CONTRIBUTORS.md
100644 blob b009175dbcbc186fb8066344c0e899c3104f43e5	Cargo.lock
100644 blob 94b87cd2940697288e4f18530c5933f3110b405b	Cargo.toml
</code></pre>
<p>What this means is that checking out a Git commit is always fast: it&rsquo;s just as
easy for Git to check out a commit from yesterday as it is to check out a
commit from 1 million commits ago. Git never has to replay 10000 diffs to
figure out the current state or anything, because commits just aren&rsquo;t stored as
diffs.</p>
<h3 id="snapshots-are-compressed-using-packfiles">snapshots are compressed using packfiles</h3>
<p>I just said that Git commits are snapshots, but when someone says &ldquo;I think of
git commits as a snapshot, but I think internally they&rsquo;re actually diffs&rdquo;,
that&rsquo;s actually kind of true too! Git commits are not represented as diffs in
the sense you&rsquo;re probably used to (they&rsquo;re not represented on disk as a diff
from the previous commit), but the basic intuition that if you&rsquo;re editing a
10,000 lines 500 times, it would be inefficient to store 500 copies of that
file is right.</p>
<p>Git does have a way of storing files as differences from other ways. This is
called &ldquo;packfiles&rdquo; and periodically git will do a garbage collection and
compress your data into packfiles to save disk space. When you <code>git clone</code> a
repository git will also compress the data.</p>
<p>I don&rsquo;t have space for a full explanation of how packfiles work in this post
(Aditya Mukerjee&rsquo;s <a href="https://codewords.recurse.com/issues/three/unpacking-git-packfiles">Unpacking Git packfiles</a>
is my favourite writeup of how they work). But here&rsquo;s a quick summary of my
understanding of how deltas work and how they&rsquo;re different from diffs:</p>
<ul>
<li>Objects are stored as a reference to an &ldquo;original file&rdquo;, plus a &ldquo;delta&rdquo;</li>
<li>the delta has a bunch of instructions like &ldquo;read bytes 0 to 100, then insert bytes &lsquo;hello there&rsquo;, then read bytes 120 to 200&rdquo;. It cobbles together bytes from the original plus new text. So there&rsquo;s no notion of &ldquo;deletions&rdquo;, just copies and additions.</li>
<li>I think there are less layers of deltas: I don&rsquo;t know how to actually check how many layers of deltas Git actually had to go through to get a given object, but my impression is that it usually isn&rsquo;t very many. Probably less than 10? I&rsquo;d love to know how to actually find this out though.</li>
<li>The &ldquo;original file&rdquo; isn&rsquo;t necessarily from the previous commit, it could be anything. Maybe it could even be from a later commit? I&rsquo;m not sure about that.</li>
<li>There&rsquo;s no &ldquo;right&rdquo; algorithm for how to compute deltas, Git just has some approximate heuristics</li>
</ul>
<h3 id="what-actually-happens-when-you-do-a-diff-is-kind-of-weird">what actually happens when you do a diff is kind of weird</h3>
<p>When I run <code>git show SOME_COMMIT</code> to look at the diff for a commit, what
actually happens is kind of counterintuitive. My understanding is:</p>
<ol>
<li>git looks in the packfiles and applies deltas to reconstruct the tree for that commit and for its parent.</li>
<li>git diffs the two directory trees (the current commit&rsquo;s tree, and the parent commit&rsquo;s tree). Usually this is pretty fast because almost all of
the files are exactly the same, so git can just compare the hashes of the identical files and do nothing almost all of the time.</li>
<li>finally git shows me the diff</li>
</ol>
<p>So it takes deltas, turns them into a snapshot, and then calculates a diff. It
feels a little weird because it starts with a diff-like-thing and ends up with
another diff-like-thing, but the deltas and diffs are actually totally
different so it makes sense.</p>
<p>That said, the way I think of it is that git stores commits as snapshots and
packfiles are just an implementation detail to save disk space and make clones
faster. I&rsquo;ve never actually needed to know how packfiles work for any practical
reason, but it does help me understand how it&rsquo;s <em>possible</em> for git commits to
be snapshots without using way too much disk space.</p>
<h3 id="a-wrong-mental-model-for-git-commits-are-diffs">a &ldquo;wrong&rdquo; mental model for git: commits are diffs</h3>
<p>I think a pretty common &ldquo;wrong&rdquo; mental model for Git is:</p>
<ul>
<li>commits are stored as diffs from the previous commit (plus a pointer to the parent commit(s) and an author and message).</li>
<li>to get the current state for a commit, Git starts at the beginning and
replays all the previous commits</li>
</ul>
<p>This model is obviously not <strong>true</strong> (in real life, commits are stored as
snapshots, and diffs are calculated from those snapshots), but it seems very
useful and coherent to me! It gets a little weird with merge commits, but maybe
you just say it&rsquo;s stored as a diff from the first parent of the merge.</p>
<p>I think wrong mental models are often extremely useful, and this one doesn&rsquo;t
seem very problematic to me for every day Git usage. I really like that it
makes the thing that we deal with the most often (the diff) the most
fundamental &ndash; it seems really intuitive to me.</p>
<p>I&rsquo;ve also been thinking about other &ldquo;wrong&rdquo; mental models you can have about
Git which seem pretty useful like:</p>
<ul>
<li>commit messages can be edited (they can&rsquo;t really, actually you make a copy of the commit with a new message, and the old commit continues to exist)</li>
<li>commits can be moved to have a different base (similarly, they&rsquo;re copied)</li>
</ul>
<p>I feel like there&rsquo;s a whole very coherent &ldquo;wrong&rdquo; set of ideas you can have
about git that are pretty well supported by Git&rsquo;s UI and not very problematic
most of the time. I think it can get messy when you want to undo a change or
when something goes wrong though.</p>
<h3 id="some-advantages-of-commit-as-diff">some advantages of &ldquo;commit as diff&rdquo;</h3>
<p>Personally even though I know that in Git commits are snapshots, I probably think of them as diffs most of the time, because:</p>
<ul>
<li>most of the time I&rsquo;m concerned with the <strong>change</strong> I&rsquo;m making &ndash; if I&rsquo;m just
changing 1 line of code, obviously I&rsquo;m mostly thinking about just that 1 line
of code and not the entire current state of the codebase</li>
<li>when you click on a Git commit on GitHub or use <code>git show</code>, you see the diff, so it&rsquo;s just what I&rsquo;m used to seeing</li>
<li>I use rebase a lot, which is all about replaying diffs</li>
</ul>
<h3 id="some-advantages-of-commit-as-snapshot">some advantages of &ldquo;commit as snapshot&rdquo;</h3>
<p>I also think about commits as snapshots sometimes though, because:</p>
<ul>
<li>git often gets confused about file moves: sometimes if I move a file and edit
it, Git can&rsquo;t recognize that it was moved and instead will show it as
&ldquo;deleted old.py, added new.py&rdquo;. This is because git only stores snapshots, so
when it says &ldquo;moved old.py -&gt; new.py&rdquo;, it&rsquo;s just guessing because the
contents of <code>old.py</code> and <code>new.py</code> are similar.</li>
<li>it&rsquo;s conceptually much easier to think about what <code>git checkout COMMIT_ID</code> is doing (the idea of replaying 10000 commits just feels stressful to me)</li>
<li>merge commits kind of make more sense to me as snapshots, because the merged
commit can actually be literally anything (it&rsquo;s just a new snapshot!). It
helps me understand why you can make arbitrary changes when you&rsquo;re resolving
a merge conflict, and why it&rsquo;s so important to be careful about conflict
resolution.</li>
</ul>
<h3 id="some-other-ways-to-think-about-commits">some other ways to think about commits</h3>
<p>Some folks in the Mastodon replies also mentioned:</p>
<ul>
<li>&ldquo;extra&rdquo; out-of-band information about the commit, like an email or a GitHub pull request or just a conversation you had with a coworker</li>
<li>thinking about a diff as a &ldquo;before state + after state&rdquo;</li>
<li>and of course, that lots of people think of commits in lots of different ways depending on the situation</li>
</ul>
<p>some other words people use to talk about commits might be less ambiguous:</p>
<ul>
<li>&ldquo;revision&rdquo; (seems more like a snapshot)</li>
<li>&ldquo;patch&rdquo; (seems more like a diff)</li>
</ul>
<h3 id="that-s-all-for-now">that&rsquo;s all for now!</h3>
<p>It&rsquo;s been very difficult for me to get a sense of what different mental models
people have for git. It&rsquo;s especially tricky because people get really into
policing &ldquo;wrong&rdquo; mental models even though those &ldquo;wrong&rdquo; models are often
really useful, so folks are reluctant to share their &ldquo;wrong&rdquo; ideas for fear of
some Git Explainer coming out of the woodwork to explain to them why they&rsquo;re
Wrong. (these Git Explainers are often well-intentioned, but it still has a chilling effect either way)</p>
<p>But I&rsquo;ve been learning a lot! I still don&rsquo;t feel totally clear about how I want to
talk about commits, but we&rsquo;ll get there eventually.</p>
<p>Thanks to Marco Rogers, Marie Flanagan, and everyone on Mastodon for talking to
me about git commits.</p>
]]></content>
  </entry>
  
</feed>
